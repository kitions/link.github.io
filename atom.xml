<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Filip</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://kitions.github.io/"/>
  <updated>2020-05-27T08:49:31.266Z</updated>
  <id>https://kitions.github.io/</id>
  
  <author>
    <name>link</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>React diffæ­ç§˜</title>
    <link href="https://kitions.github.io/2020/05/26/react%20diff%E6%BA%90%E7%A0%81%E6%8F%AD%E7%A7%98/"/>
    <id>https://kitions.github.io/2020/05/26/react diffæºç æ­ç§˜/</id>
    <published>2020-05-26T13:56:43.000Z</published>
    <updated>2020-05-27T08:49:31.266Z</updated>
    
    <content type="html"><![CDATA[<h1 id="React-diffæ­ç§˜"><a href="#React-diffæ­ç§˜" class="headerlink" title="React diffæ­ç§˜"></a>React diffæ­ç§˜</h1><p>React æ¡†æ¶å†…éƒ¨çš„è¿ä½œå¯ä»¥åˆ†ä¸º 3 å±‚ï¼š</p><ul><li>Virtual DOM å±‚ï¼Œæè¿°é¡µé¢é•¿ä»€ä¹ˆæ ·ã€‚</li><li><strong>Reconciler å±‚ï¼Œè´Ÿè´£è°ƒç”¨ç»„ä»¶ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œè¿›è¡Œ Diff è¿ç®—ç­‰</strong>ã€‚</li><li>Renderer å±‚ï¼Œæ ¹æ®ä¸åŒçš„å¹³å°ï¼Œæ¸²æŸ“å‡ºç›¸åº”çš„é¡µé¢ï¼Œæ¯”è¾ƒå¸¸è§çš„æ˜¯ ReactDOM å’Œ ReactNativeã€‚</li></ul><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gf71qq5z11j30sk0jbjzp.jpg" alt="image-20200527153644396"></p><p>ReactChildFiber.new.jsä¸­</p><h2 id="Diffçš„å…¥å£å‡½æ•°"><a href="#Diffçš„å…¥å£å‡½æ•°" class="headerlink" title="Diffçš„å…¥å£å‡½æ•°"></a>Diffçš„å…¥å£å‡½æ•°</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ ¹æ®newChildç±»å‹é€‰æ‹©ä¸åŒdiffå‡½æ•°å¤„ç†</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileChildFibers</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  currentFirstChild: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  newChild: any,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> isObject = <span class="keyword">typeof</span> newChild === <span class="string">'object'</span> &amp;&amp; newChild !== <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isObject) &#123;</span><br><span class="line">    <span class="comment">// objectç±»å‹ï¼Œå¯èƒ½æ˜¯ REACT_ELEMENT_TYPE æˆ– REACT_PORTAL_TYPE</span></span><br><span class="line">    <span class="keyword">switch</span> (newChild.$$<span class="keyword">typeof</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> REACT_ELEMENT_TYPE:</span><br><span class="line">        <span class="comment">// è°ƒç”¨ reconcileSingleElement å¤„ç†</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> REACT_PORTAL_TYPE:</span><br><span class="line">        <span class="comment">// è°ƒç”¨ reconcileSinglePortal</span></span><br><span class="line">        <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">          reconcileSinglePortal(</span><br><span class="line">            ... <span class="comment">//å››ä¸ªå‚æ•°</span></span><br><span class="line">          ),</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">'string'</span> || <span class="keyword">typeof</span> newChild === <span class="string">'number'</span>) &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨ reconcileSingleTextNode å¤„ç†</span></span><br><span class="line">    reconcileSingleTextNode</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isArray(newChild)) &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨ reconcileChildrenArray å¤„ç†</span></span><br><span class="line">    reconcileChildrenArray</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸€äº›å…¶ä»–æƒ…å†µè°ƒç”¨å¤„ç†å‡½æ•°</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä»¥ä¸Šéƒ½æ²¡æœ‰å‘½ä¸­ï¼Œåˆ é™¤èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">return</span> deleteRemainingChildren(returnFiber, currentFirstChild);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>newChild</code>å‚æ•°å°±æ˜¯æœ¬æ¬¡æ›´æ–°çš„ JSX å¯¹è±¡ï¼ˆå¯¹åº”<code>ClassComponent</code>çš„<code>this.render</code>æ–¹æ³•è¿”å›å€¼ï¼Œæˆ–è€…<code>FunctionComponent</code>æ‰§è¡Œçš„è¿”å›å€¼ï¼‰</p><hr><h3 id="åŒçº§çš„èŠ‚ç‚¹æ•°é‡å°†Diffåˆ†ä¸ºä¸¤ç±»ï¼š"><a href="#åŒçº§çš„èŠ‚ç‚¹æ•°é‡å°†Diffåˆ†ä¸ºä¸¤ç±»ï¼š" class="headerlink" title="åŒçº§çš„èŠ‚ç‚¹æ•°é‡å°†Diffåˆ†ä¸ºä¸¤ç±»ï¼š"></a>åŒçº§çš„èŠ‚ç‚¹æ•°é‡å°†Diffåˆ†ä¸ºä¸¤ç±»ï¼š</h3><ol><li>å½“newChildç±»å‹ä¸º<code>object</code>ã€<code>number</code>ã€<code>string</code>ï¼Œä»£è¡¨åŒçº§åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹</li><li>å½“newChildç±»å‹ä¸º<code>Array</code>æ—¶ï¼Œä»£è¡¨åŒçº§æœ‰å¤šä¸ªèŠ‚ç‚¹</li></ol><h4 id="æƒ…å†µä¸€ï¼šåŒçº§åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹"><a href="#æƒ…å†µä¸€ï¼šåŒçº§åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹" class="headerlink" title="æƒ…å†µä¸€ï¼šåŒçº§åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹"></a>æƒ…å†µä¸€ï¼šåŒçº§åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹</h4><p>å¯¹äºå•ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘ä»¬ä»¥ç±»å‹objectä¸ºä¾‹ï¼Œä¼šè¿›å…¥<code>reconcileSingleElement</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isObject = <span class="keyword">typeof</span> newChild === <span class="string">'object'</span> &amp;&amp; newChild !== <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isObject) &#123;</span><br><span class="line">    <span class="comment">// å¯¹è±¡ç±»å‹ï¼Œå¯èƒ½æ˜¯ REACT_ELEMENT_TYPE æˆ– REACT_PORTAL_TYPE</span></span><br><span class="line">    <span class="keyword">switch</span> (newChild.$$<span class="keyword">typeof</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> REACT_ELEMENT_TYPE:</span><br><span class="line">        <span class="comment">// è°ƒç”¨ reconcileSingleElement å¤„ç†</span></span><br><span class="line">      <span class="comment">// ...å…¶ä»–case</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gf4tpxrf79j30u00n40ye.jpg" alt="img"></p><blockquote><p><a href="https://github.com/BetaSu/react-on-the-way/blob/v1/packages/react-reconciler/ReactFiber.js#L15" target="_blank" rel="noopener">Fiber</a> å…¶å®æŒ‡çš„æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå®ƒå¯ä»¥ç”¨ä¸€ä¸ªçº¯ JS å¯¹è±¡æ¥è¡¨ç¤ºï¼š</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fiber = &#123;</span><br><span class="line">    stateNode,    <span class="comment">// èŠ‚ç‚¹å®ä¾‹</span></span><br><span class="line">    child,        <span class="comment">// å­èŠ‚ç‚¹</span></span><br><span class="line">    sibling,      <span class="comment">// å…„å¼ŸèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">return</span>,       <span class="comment">// çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gf5pbqpocoj30i607z40d.jpg" alt="image-20200526114139235"></p><p>åœ¨<strong>render</strong>é˜¶æ®µä¼šç”Ÿæˆçš„Fiberç»“æ„</p><ul><li><p>Fiberä¸­å¯ä»¥ä¿å­˜èŠ‚ç‚¹çš„ç±»å‹ï¼Œä¾‹å­ä¸­AppèŠ‚ç‚¹æ˜¯ä¸€ä¸ªå‡½æ•°ç»„ä»¶èŠ‚ç‚¹ï¼ŒdivèŠ‚ç‚¹æ˜¯ä¸€ä¸ªåŸç”ŸDOMèŠ‚ç‚¹ï¼ŒI amèŠ‚ç‚¹æ˜¯ä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹ã€‚</p></li><li><p>å¯ä»¥ä¿å­˜èŠ‚ç‚¹çš„ä¿¡æ¯ï¼ˆæ¯”å¦‚stateï¼Œpropsï¼‰ã€‚</p></li><li><p>å¯ä»¥ä¿å­˜èŠ‚ç‚¹å¯¹åº”çš„å€¼ï¼ˆæ¯”å¦‚AppèŠ‚ç‚¹å¯¹åº”Appå‡½æ•°ï¼ŒdivèŠ‚ç‚¹å¯¹åº”div DOMElementï¼‰ã€‚è¿™æ ·çš„ç»“æ„ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆå‡½æ•°ç»„ä»¶é€šè¿‡<a href="https://zh-hans.reactjs.org/docs/hooks-intro.html" target="_blank" rel="noopener">Hooks</a>å¯ä»¥ä¿å­˜stateã€‚å› ä¸ºstateå¹¶ä¸æ˜¯ä¿å­˜åœ¨å‡½æ•°ä¸Šï¼Œè€Œæ˜¯ä¿å­˜åœ¨å‡½æ•°ç»„ä»¶å¯¹åº”çš„FiberèŠ‚ç‚¹ä¸Šã€‚</p></li><li><p>å¯ä»¥ä¿å­˜èŠ‚ç‚¹çš„è¡Œä¸ºï¼ˆæ›´æ–°/åˆ é™¤/æ’å…¥ï¼‰</p></li></ul><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gf5pe5bpcnj30ex0ct0u4.jpg" alt="image-20200526114358997"></p><p>div Fiber.return = App Fiber; å³ç”¨returnæŒ‡å‘è‡ªå·±çš„çˆ¶èŠ‚ç‚¹ã€‚çˆ¶çº§å«returnä¸å«parent</p><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gf5pilkjgnj30f50dewgf.jpg" alt="image-20200526114645771"></p><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gf5leqv5u6j30iv0mwq5w.jpg" alt="image-20200526092607718"></p><p>åˆ¤æ–­DOMèŠ‚ç‚¹æ˜¯å¦å¯ä»¥å¤ç”¨ï¼Œè®©æˆ‘ä»¬é€šè¿‡ä»£ç çœ‹çœ‹æ˜¯å¦‚ä½•åˆ¤æ–­çš„ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileSingleElement</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  currentFirstChild: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  element: ReactElement</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> key = element.key;</span><br><span class="line">  <span class="keyword">let</span> child = currentFirstChild;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é¦–å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨å¯¹åº”DOMèŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// ä¸Šä¸€æ¬¡æ›´æ–°å­˜åœ¨DOMèŠ‚ç‚¹ï¼Œæ¥ä¸‹æ¥åˆ¤æ–­æ˜¯å¦å¯å¤ç”¨</span></span><br><span class="line">    <span class="keyword">if</span> (child.key === key) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ™‹â€â™‚ï¸åŒå­¦çœ‹è¿™é‡Œï¼Œé¦–å…ˆæ¯”è¾ƒkeyæ˜¯å¦ç›¸åŒ</span></span><br><span class="line">      <span class="keyword">switch</span> (child.tag) &#123;</span><br><span class="line">        <span class="comment">// ...çœç•¥case</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">          <span class="keyword">if</span> (child.elementType === element.type) &#123;</span><br><span class="line">            <span class="comment">// ğŸ™‹â€â™‚ï¸åŒå­¦çœ‹è¿™é‡Œï¼Œkeyç›¸åŒåå†çœ‹typeæ˜¯å¦ç›¸åŒ</span></span><br><span class="line">            <span class="comment">// å¦‚æœç›¸åŒåˆ™è¡¨ç¤ºå¯ä»¥å¤ç”¨</span></span><br><span class="line">            <span class="keyword">return</span> existing;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// typeä¸åŒåˆ™è·³å‡ºå¾ªç¯</span></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ğŸ‘¹ keyä¸åŒæˆ–typeä¸åŒéƒ½ä»£è¡¨ä¸èƒ½å¤ç”¨ï¼Œä¼šåˆ°è¿™é‡Œ</span></span><br><span class="line">      <span class="comment">// ä¸èƒ½å¤ç”¨çš„èŠ‚ç‚¹ï¼Œè¢«æ ‡è®°ä¸ºåˆ é™¤</span></span><br><span class="line">      deleteRemainingChildren(returnFiber, child);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      deleteChild(returnFiber, child);</span><br><span class="line">    &#125;</span><br><span class="line">    child = child.sibling;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºæ–°Fiberï¼Œå¹¶è¿”å›</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒReacté€šè¿‡å…ˆåˆ¤æ–­keyæ˜¯å¦ç›¸åŒï¼Œå¦‚æœkeyç›¸åŒåˆ™åˆ¤æ–­typeæ˜¯å¦ç›¸åŒï¼Œåªæœ‰éƒ½ç›¸åŒæ—¶ä¸€ä¸ªDOMèŠ‚ç‚¹æ‰èƒ½å¤ç”¨ã€‚</p><h6 id="ç»ƒä¹ é¢˜"><a href="#ç»ƒä¹ é¢˜" class="headerlink" title="ç»ƒä¹ é¢˜"></a>ç»ƒä¹ é¢˜</h6><p>è¯·åˆ¤æ–­å¦‚ä¸‹JSXå¯¹è±¡å¯¹åº”çš„DOMå…ƒç´ æ˜¯å¦å¯ä»¥å¤ç”¨ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¹ é¢˜1 æ›´æ–°å‰</span></span><br><span class="line">&lt;div&gt;<span class="number">123</span>&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ æ›´æ–°å</span></span><br><span class="line"><span class="regexp">&lt;p&gt;123&lt;/</span>p&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¹ é¢˜2 æ›´æ–°å‰</span></span><br><span class="line">&lt;div key=<span class="string">"xxx"</span>&gt;<span class="number">123</span>&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ æ›´æ–°å</span></span><br><span class="line"><span class="regexp">&lt;div key="ooo"&gt;123&lt;/</span>div&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¹ é¢˜3 æ›´æ–°å‰</span></span><br><span class="line">&lt;div key=<span class="string">"xxx"</span>&gt;<span class="number">123</span>&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ æ›´æ–°å</span></span><br><span class="line"><span class="regexp">&lt;p key="ooo"&gt;123&lt;/</span>p&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¹ é¢˜4 æ›´æ–°å‰</span></span><br><span class="line">&lt;div key=<span class="string">"xxx"</span>&gt;<span class="number">123</span>&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ æ›´æ–°å</span></span><br><span class="line"><span class="regexp">&lt;div key="xxx"&gt;456&lt;/</span>div&gt;</span><br></pre></td></tr></table></figure><p>`</p><p>`</p><p>`</p><p>`</p><p>`</p><p>`</p><p>`</p><p>ä¹ é¢˜1: æœªè®¾ç½®key propé»˜è®¤ key = null;ï¼Œæ‰€ä»¥æ›´æ–°å‰åkeyç›¸åŒï¼Œéƒ½ä¸ºnullï¼Œä½†æ˜¯æ›´æ–°å‰typeä¸ºdivï¼Œæ›´æ–°åä¸ºpï¼Œtypeæ”¹å˜åˆ™ä¸èƒ½å¤ç”¨ã€‚</p><p>ä¹ é¢˜2: æ›´æ–°å‰åkeyæ”¹å˜ï¼Œä¸éœ€è¦å†åˆ¤æ–­typeï¼Œä¸èƒ½å¤ç”¨ã€‚</p><p>ä¹ é¢˜3: æ›´æ–°å‰åkeyæ”¹å˜ï¼Œä¸éœ€è¦å†åˆ¤æ–­typeï¼Œä¸èƒ½å¤ç”¨ã€‚</p><p>ä¹ é¢˜4: æ›´æ–°å‰åkeyä¸typeéƒ½æœªæ”¹å˜ï¼Œå¯ä»¥å¤ç”¨ã€‚childrenå˜åŒ–ï¼ŒDOMçš„å­å…ƒç´ éœ€è¦æ›´æ–°ã€‚</p><h4 id="æƒ…å†µäºŒï¼šåŒçº§æœ‰å¤šä¸ªå…ƒç´ çš„Diff"><a href="#æƒ…å†µäºŒï¼šåŒçº§æœ‰å¤šä¸ªå…ƒç´ çš„Diff" class="headerlink" title="æƒ…å†µäºŒï¼šåŒçº§æœ‰å¤šä¸ªå…ƒç´ çš„Diff"></a>æƒ…å†µäºŒï¼šåŒçº§æœ‰å¤šä¸ªå…ƒç´ çš„Diff</h4><p>åˆšæ‰æˆ‘ä»¬ä»‹ç»äº†å•ä¸€å…ƒç´ çš„Diffï¼Œç°åœ¨è€ƒè™‘æˆ‘ä»¬æœ‰ä¸€ä¸ª<code>FunctionComponent</code>ï¼š</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">List</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;ul&gt;</span><br><span class="line">            &lt;li key=<span class="string">"0"</span>&gt;<span class="number">0</span>&lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">            &lt;li key="1"&gt;1&lt;/</span>li&gt;</span><br><span class="line">            &lt;li key=<span class="string">"2"</span>&gt;<span class="number">2</span>&lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">            &lt;li key="3"&gt;3&lt;/</span>li&gt;</span><br><span class="line">        &lt;<span class="regexp">/ul&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>è¿”å›å€¼JSXå¯¹è±¡çš„childrenå±æ€§ä¸æ˜¯å•ä¸€å…ƒç´ ï¼Œè€Œæ˜¯åŒ…å«å››ä¸ªå¯¹è±¡çš„æ•°ç»„</p><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gf5lt57bhrj30u00bpwi1.jpg" alt="img"></p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒreconcileChildFibersçš„newChildå‚æ•°ä¸ºArrayï¼Œå°±æ‰§è¡Œåˆ°äº†è¿™å„¿</p><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gf5m5nz6goj30ft05vmxn.jpg" alt="image-20200526095202092"></p><p>æ¥çœ‹çœ‹Reactå¦‚ä½•å¤„ç†åŒçº§å¤šä¸ªå…ƒç´ çš„Diffã€‚</p><h3 id="åŒçº§å¤šä¸ªèŠ‚ç‚¹è¯¦è§£"><a href="#åŒçº§å¤šä¸ªèŠ‚ç‚¹è¯¦è§£" class="headerlink" title="åŒçº§å¤šä¸ªèŠ‚ç‚¹è¯¦è§£"></a><strong>åŒçº§å¤šä¸ªèŠ‚ç‚¹</strong>è¯¦è§£</h3><ol><li><p>èŠ‚ç‚¹æ›´æ–°</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// æƒ…å†µ1 èŠ‚ç‚¹æ›´æ–°</span><br><span class="line">    </span><br><span class="line">// ä¹‹å‰</span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"0"</span> <span class="attr">className</span>=<span class="string">"before"</span>&gt;</span>0<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"1"</span>&gt;</span>1<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">// ä¹‹åæƒ…å†µ1 èŠ‚ç‚¹å±æ€§å˜åŒ–</span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"0"</span> <span class="attr">className</span>=<span class="string">"after"</span>&gt;</span>0<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"1"</span>&gt;</span>1<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">// ä¹‹åæƒ…å†µ2 èŠ‚ç‚¹ç±»å‹æ›´æ–°</span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">"0"</span>&gt;</span>0<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"1"</span>&gt;</span>1<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ol><ol start="2"><li><p>èŠ‚ç‚¹æ–°å¢æˆ–å‡å°‘</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// æƒ…å†µ2 èŠ‚ç‚¹æ–°å¢æˆ–å‡å°‘</span><br><span class="line"></span><br><span class="line">// ä¹‹å‰</span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"0"</span>&gt;</span>0<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"1"</span>&gt;</span>1<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// ä¹‹åæƒ…å†µ1 æ–°å¢èŠ‚ç‚¹</span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"0"</span>&gt;</span>0<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"1"</span>&gt;</span>1<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"2"</span>&gt;</span>2<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// ä¹‹åæƒ…å†µ2 åˆ é™¤èŠ‚ç‚¹</span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"1"</span>&gt;</span>1<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ol><ol start="3"><li><p>èŠ‚ç‚¹ä½ç½®å˜åŒ–</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// æƒ…å†µ3 èŠ‚ç‚¹ä½ç½®å˜åŒ–</span><br><span class="line"></span><br><span class="line">// ä¹‹å‰</span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"0"</span>&gt;</span>0<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"1"</span>&gt;</span>1<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// ä¹‹å</span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"1"</span>&gt;</span>1<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"0"</span>&gt;</span>0<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ol><p>åŒä¸€æ¬¡åŒçº§å¤šä¸ªå…ƒç´ çš„Diffï¼Œä¸€å®šå±äºä»¥ä¸Šä¸‰ç§æƒ…å†µä¸­çš„ä¸€ç§æˆ–å¤šç§ã€‚</p><p>è¯¥å¦‚ä½•è®¾è®¡ç®—æ³•å‘¢</p><p>é¦–å…ˆæƒ³åˆ°çš„æ˜¯æ–¹æ¡ˆæ˜¯ï¼š</p><ol><li>åˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„æ›´æ–°å±äºå“ªç§æƒ…å†µ</li><li>å¦‚æœæ˜¯æ–°å¢ï¼Œæ‰§è¡Œæ–°å¢é€»è¾‘</li><li>å¦‚æœæ˜¯åˆ é™¤ï¼Œæ‰§è¡Œåˆ é™¤é€»è¾‘</li><li>å¦‚æœæ˜¯æ›´æ–°ï¼Œæ‰§è¡Œæ›´æ–°é€»è¾‘</li></ol><p>æŒ‰è¿™ä¸ªæ–¹æ¡ˆï¼Œå…¶å®æœ‰ä¸ªéšå«çš„å‰æï¼Œä¸Šè¿°<strong>ä¸åŒæ“ä½œçš„ä¼˜å…ˆçº§æ˜¯ç›¸åŒçš„</strong></p><p>ä½†Reactå›¢é˜Ÿå‘ç°ï¼Œåœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œç›¸å¯¹äºå¢åŠ å’Œåˆ é™¤ï¼Œæ›´æ–°ç»„ä»¶å‘ç”Ÿçš„é¢‘ç‡æ›´é«˜ã€‚æ‰€ä»¥React Diffä¼šä¼˜å…ˆåˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦å±äºæ›´æ–°ã€‚</p><p>è™½ç„¶æœ¬æ¬¡æ›´æ–°çš„JSXå¯¹è±¡<code>newChildren</code>ä¸ºæ•°ç»„å½¢å¼ï¼Œä½†æ˜¯å’Œ<code>newChildren</code>ä¸­æ¯ä¸ªå€¼è¿›è¡Œæ¯”è¾ƒçš„æ˜¯ä¸Šæ¬¡æ›´æ–°çš„FiberèŠ‚ç‚¹ï¼ŒFiberèŠ‚ç‚¹çš„åŒçº§èŠ‚ç‚¹æ˜¯ç”±siblingï¼ˆå…„å¼ŸèŠ‚ç‚¹ï¼‰æŒ‡é’ˆé“¾æ¥å½¢æˆçš„é“¾è¡¨ã€‚</p><p>å³ newChildren[0]ä¸oldFiberæ¯”è¾ƒï¼ŒnewChildren[1]ä¸oldFiber.siblingæ¯”è¾ƒã€‚</p><p><a href="https://blog.csdn.net/wyqwilliam/article/details/82717670" target="_blank" rel="noopener">å•é“¾è¡¨</a>æ— æ³•ä½¿ç”¨åŒæŒ‡é’ˆï¼Œæ‰€ä»¥æ— æ³•å¯¹ç®—æ³•ä½¿ç”¨åŒæŒ‡é’ˆä¼˜åŒ–ã€‚</p><p>åŸºäºä»¥ä¸ŠåŸå› ï¼ŒDiffç®—æ³•çš„æ•´ä½“é€»è¾‘ä¼šç»å†ä¸¤è½®éå†ã€‚</p><p>ç¬¬ä¸€è½®éå†ï¼šå¤„ç†æ›´æ–°çš„èŠ‚ç‚¹ã€‚</p><p>ç¬¬äºŒè½®éå†ï¼šå¤„ç†å‰©ä¸‹çš„ä¸å±äºæ›´æ–°çš„èŠ‚ç‚¹ã€‚</p><h4 id="ç¬¬ä¸€ééå†"><a href="#ç¬¬ä¸€ééå†" class="headerlink" title="ç¬¬ä¸€ééå†"></a><strong>ç¬¬ä¸€ééå†</strong></h4><ol><li>éå†newChildrenï¼Œi = 0ï¼Œå°†newChildren[i]ä¸oldFiberæ¯”è¾ƒï¼Œåˆ¤æ–­DOMèŠ‚ç‚¹æ˜¯å¦å¯å¤ç”¨ã€‚</li><li>å¦‚æœå¯å¤ç”¨ï¼Œi++ï¼Œæ¯”è¾ƒnewChildren[i]ä¸oldFiber.siblingæ˜¯å¦å¯å¤ç”¨ã€‚å¯ä»¥å¤ç”¨åˆ™é‡å¤æ­¥éª¤2ã€‚</li><li>å¦‚æœä¸å¯å¤ç”¨ï¼Œç«‹å³è·³å‡ºæ•´ä¸ªéå†ã€‚</li><li>å¦‚æœnewChildrenéå†å®Œæˆ–è€…oldFiberéå†å®Œï¼ˆå³oldFiber.sibling === nullï¼‰ï¼Œè·³å‡ºéå†ã€‚</li></ol><p>å½“æœ€ç»ˆå®Œæˆéå†åï¼Œä¼šæœ‰ä¸¤ç§ç»“æœï¼š</p><p>ç»“æœä¸€ï¼šå¦‚æœæ˜¯æ­¥éª¤3è·³å‡ºçš„éå†ï¼ŒnewChildrenæ²¡æœ‰éå†å®Œï¼ŒoldFiberä¹Ÿæ²¡æœ‰éå†å®Œã€‚</p><p>ä¸¾ä¸ªæ —å­ğŸŒ°</p><p>å¦‚ä¸‹ä»£ç ä¸­ï¼Œå‰2ä¸ªèŠ‚ç‚¹å¯å¤ç”¨ï¼Œkey === 2çš„èŠ‚ç‚¹typeæ”¹å˜ï¼Œä¸å¯å¤ç”¨ï¼Œè·³å‡ºéå†ã€‚</p><p>æ­¤æ—¶oldFiberå‰©ä¸‹key === 2æœªéå†ï¼ŒnewChildrenå‰©ä¸‹key === 2ã€key === 3æœªéå†ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// ä¹‹å‰</span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"0"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"1"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"2"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// ä¹‹å</span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"0"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"1"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">"2"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"3"</span>&gt;</span>3<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç»“æœäºŒï¼šå¦‚æœæ˜¯æ­¥éª¤4è·³å‡ºçš„éå†ï¼Œå¯èƒ½newChildrenéå†å®Œï¼Œæˆ–oldFiberéå†å®Œï¼Œæˆ–ä»–ä»¬åŒæ—¶éå†å®Œã€‚</p><p>å†æ¥ä¸ªğŸŒ°</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// ä¹‹å‰</span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"0"</span> <span class="attr">className</span>=<span class="string">"a"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"1"</span> <span class="attr">className</span>=<span class="string">"b"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// ä¹‹åæƒ…å†µ1 newChildrenä¸oldFiberéƒ½éå†å®Œ</span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"0"</span> <span class="attr">className</span>=<span class="string">"aa"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"1"</span> <span class="attr">className</span>=<span class="string">"bb"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// ä¹‹åæƒ…å†µ2 newChildrenæ²¡éå†å®Œï¼ŒoldFiberéå†å®Œ</span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"0"</span> <span class="attr">className</span>=<span class="string">"aa"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"1"</span> <span class="attr">className</span>=<span class="string">"bb"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"2"</span> <span class="attr">className</span>=<span class="string">"cc"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// ä¹‹åæƒ…å†µ3 newChildrenéå†å®Œï¼ŒoldFiberæ²¡éå†å®Œ</span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">"0"</span> <span class="attr">className</span>=<span class="string">"aa"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="ç¬¬äºŒè½®éå†"><a href="#ç¬¬äºŒè½®éå†" class="headerlink" title="ç¬¬äºŒè½®éå†"></a>ç¬¬äºŒè½®éå†</h4><p>å¯¹äºç»“æœäºŒï¼Œèªæ˜çš„ä½ æƒ³ä¸€æƒ³ğŸ¯ï¼ŒnewChildrenæ²¡éå†å®Œï¼ŒoldFiberéå†å®Œæ„å‘³ç€ä»€ä¹ˆï¼Ÿ</p><p>è€çš„DOMèŠ‚ç‚¹éƒ½å¤ç”¨äº†ï¼Œè¿™æ—¶è¿˜æœ‰æ–°åŠ å…¥çš„èŠ‚ç‚¹ï¼Œæ„å‘³ç€æœ¬æ¬¡æ›´æ–°æœ‰æ–°èŠ‚ç‚¹æ’å…¥ï¼Œæˆ‘ä»¬åªéœ€è¦éå†å‰©ä¸‹çš„newChildrenä¾æ¬¡æ‰§è¡Œæ’å…¥æ“ä½œ<a href="https://blog.csdn.net/qiwoo_weekly/article/details/106247621" target="_blank" rel="noopener">ï¼ˆFiber.effectTag = Placement;ï¼‰</a>ã€‚</p><blockquote><p><strong>effectTag</strong>å­—æ®µè¡¨ç¤ºå½“å‰<strong>Fiber</strong>éœ€è¦æ‰§è¡Œçš„å‰¯ä½œç”¨ï¼Œæœ€å¸¸è§çš„å‰¯ä½œç”¨æ˜¯ï¼š</p></blockquote><ul><li>Placement æ’å…¥DOMèŠ‚ç‚¹</li><li>Update æ›´æ–°DOMèŠ‚ç‚¹</li><li>Deletion åˆ é™¤DOMèŠ‚ç‚¹</li></ul><p>åŒæ ·çš„ï¼Œæˆ‘ä»¬ä¸¾ä¸€åä¸‰ã€‚newChildrenéå†å®Œï¼ŒoldFiberæ²¡éå†å®Œæ„å‘³ç€ä»€ä¹ˆï¼Ÿ</p><p>æ„å‘³ç€å¤šä½™çš„oldFiberåœ¨è¿™æ¬¡æ›´æ–°ä¸­å·²ç»ä¸å­˜åœ¨äº†ï¼Œæ‰€ä»¥éœ€è¦éå†å‰©ä¸‹çš„oldFiberï¼Œä¾æ¬¡æ‰§è¡Œåˆ é™¤æ“ä½œï¼ˆFiber.effectTag = Deletion;ï¼‰ã€‚</p><p>é‚£ä¹ˆç»“æœä¸€æ€ä¹ˆå¤„ç†å‘¢ï¼ŸnewChildrenä¸oldFiberéƒ½æ²¡éå†å®Œï¼Œè¿™æ„å‘³ç€æœ‰èŠ‚ç‚¹åœ¨è¿™æ¬¡æ›´æ–°ä¸­æ”¹å˜äº†ä½ç½®ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œå°±æ˜¯Diffç®—æ³•æœ€ç²¾é«“çš„éƒ¨åˆ†ï¼ï¼ï¼</p><h4 id="å¤„ç†ä½ç½®äº¤æ¢çš„èŠ‚ç‚¹"><a href="#å¤„ç†ä½ç½®äº¤æ¢çš„èŠ‚ç‚¹" class="headerlink" title="å¤„ç†ä½ç½®äº¤æ¢çš„èŠ‚ç‚¹"></a>å¤„ç†ä½ç½®äº¤æ¢çš„èŠ‚ç‚¹</h4><p>ä¸ºäº†å¿«é€Ÿçš„æ‰¾åˆ°keyå¯¹åº”çš„oldFiberï¼Œæˆ‘ä»¬å°†æ‰€æœ‰è¿˜æ²¡å¤„ç†çš„oldFiberæ”¾è¿›ä»¥keyå±æ€§ä¸ºkeyï¼ŒFiberä¸ºvalueçš„mapã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> existingChildren = mapRemainingChildren(returnFiber, oldFiber);</span><br></pre></td></tr></table></figure><p>æºç éƒ¨åˆ†<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapRemainingChildren</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Map</span>&lt;<span class="title">string</span> | <span class="title">number</span>, <span class="title">Fiber</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// Add the remaining children to a temporary map so that we can find them by</span></span><br><span class="line">    <span class="comment">// keys quickly. Implicit (null) keys get added to this set with their index</span></span><br><span class="line">    <span class="comment">// instead.</span></span><br><span class="line">    <span class="keyword">const</span> existingChildren: <span class="built_in">Map</span>&lt;string | number, Fiber&gt; = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> existingChild = currentFirstChild;</span><br><span class="line">    <span class="keyword">while</span> (existingChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (existingChild.key !== <span class="literal">null</span>) &#123;</span><br><span class="line">        existingChildren.set(existingChild.key, existingChild);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        existingChildren.set(existingChild.index, existingChild);</span><br><span class="line">      &#125;</span><br><span class="line">      existingChild = existingChild.sibling;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> existingChildren;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p><p>å†éå†å‰©ä½™çš„newChildrenï¼Œé€šè¿‡newChildren[i].keyå°±èƒ½åœ¨existingChildrenä¸­æ‰¾åˆ°keyç›¸åŒçš„oldFiberã€‚</p><p>æ¥ä¸‹æ¥æ˜¯é‡ç‚¹å“¦ï¼Œæ•²é»‘æ¿ ğŸ‘¨â€ğŸ«</p><p>åœ¨æˆ‘ä»¬ç¬¬ä¸€è½®å’Œç¬¬äºŒè½®éå†ä¸­ï¼Œæˆ‘ä»¬é‡åˆ°çš„æ¯ä¸€ä¸ªå¯ä»¥å¤ç”¨çš„èŠ‚ç‚¹ï¼Œä¸€å®šå­˜åœ¨ä¸€ä¸ªä»£è¡¨ä¸Šä¸€æ¬¡æ›´æ–°æ—¶è¯¥èŠ‚ç‚¹çŠ¶æ€çš„oldFiberï¼Œå¹¶ä¸”é¡µé¢ä¸Šæœ‰ä¸€ä¸ªDOMå…ƒç´ ä¸å…¶å¯¹åº”ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬åœ¨Diffå‡½æ•°çš„å…¥å£å¤„ï¼Œå®šä¹‰ä¸€ä¸ªå˜é‡</p><p>ä¸Šç¯‡React diff ä¸­çš„LastIndex</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let lastPlacedIndex = 0;</span><br></pre></td></tr></table></figure><p>è¯¥å˜é‡è¡¨ç¤ºå½“å‰æœ€åä¸€ä¸ªå¯å¤ç”¨çš„èŠ‚ç‚¹ï¼Œå¯¹åº”çš„<code>oldFiber</code>åœ¨ä¸Šæ¬¡æ›´æ–°ä¸­çš„æ‰€åœ¨çš„ä½ç½®ç´¢å¼•ï¼Œæˆ‘ä»¬é€šè¿‡è¿™ä¸ªå˜é‡åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦éœ€è¦ç§»åŠ¨ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ç®€åŒ–ä¸€ä¸‹ä¹¦å†™ï¼Œæ¯ä¸ªå­—æ¯ä»£è¡¨ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå­—æ¯çš„å€¼ä»£è¡¨èŠ‚ç‚¹çš„key</p><p>// ä¹‹å‰<br>abcd</p><p>// ä¹‹å<br>acdb</p><table><thead><tr><th>index</th><th style="text-align:left">èŠ‚ç‚¹</th><th style="text-align:left">oldIndex</th><th style="text-align:left">lastIndex</th><th style="text-align:left">æ“ä½œ</th></tr></thead><tbody><tr><td>0</td><td style="text-align:left">B</td><td style="text-align:left">0</td><td style="text-align:left">0</td><td style="text-align:left">oldIndex(0)==lastIndex(0),ä¸åŠ¨</td></tr><tr><td>1</td><td style="text-align:left">c</td><td style="text-align:left">2</td><td style="text-align:left">2</td><td style="text-align:left">oldIndex(2)==lastIndex(2),ä¸åŠ¨</td></tr><tr><td>2</td><td style="text-align:left">d</td><td style="text-align:left">3</td><td style="text-align:left">3</td><td style="text-align:left">oldIndex(3)==lastIndex3),ä¸åŠ¨</td></tr><tr><td>3</td><td style="text-align:left">b</td><td style="text-align:left">1</td><td style="text-align:left">3</td><td style="text-align:left">oldIndex(1)&lt;lastIndex(3),èŠ‚ç‚¹bç§»åŠ¨è‡³index(3)çš„ä½ç½®</td></tr></tbody></table><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¹‹å‰</span></span><br><span class="line">abcd</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¹‹å</span></span><br><span class="line">acdb</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">===ç¬¬ä¸€è½®éå†å¼€å§‹===</span><br><span class="line">aï¼ˆä¹‹åï¼‰vs aï¼ˆä¹‹å‰ï¼‰</span><br><span class="line">keyä¸å˜ï¼Œå¯å¤ç”¨</span><br><span class="line">æ­¤æ—¶ a å¯¹åº”çš„oldFiberï¼ˆä¹‹å‰çš„aï¼‰åœ¨ä¹‹å‰çš„æ•°ç»„ï¼ˆabcdï¼‰ä¸­ç´¢å¼•ä¸º<span class="number">0</span></span><br><span class="line">æ‰€ä»¥ lastPlacedIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">ç»§ç»­ç¬¬ä¸€è½®éå†...</span><br><span class="line"></span><br><span class="line">cï¼ˆä¹‹åï¼‰vs bï¼ˆä¹‹å‰ï¼‰</span><br><span class="line">keyæ”¹å˜ï¼Œä¸èƒ½å¤ç”¨ï¼Œè·³å‡ºç¬¬ä¸€è½®éå†</span><br><span class="line">æ­¤æ—¶ lastPlacedIndex === <span class="number">0</span>;</span><br><span class="line">===ç¬¬ä¸€è½®éå†ç»“æŸ===</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">===ç¬¬äºŒè½®éå†å¼€å§‹===</span><br><span class="line"></span><br><span class="line">newChildren === cdbï¼Œæ²¡ç”¨å®Œï¼Œä¸éœ€è¦æ‰§è¡Œåˆ é™¤æ—§èŠ‚ç‚¹</span><br><span class="line">oldFiber === bcdï¼Œæ²¡ç”¨å®Œï¼Œä¸éœ€è¦æ‰§è¡Œæ’å…¥æ–°èŠ‚ç‚¹</span><br><span class="line"></span><br><span class="line">å°†å‰©ä½™oldFiberï¼ˆbcdï¼‰ä¿å­˜ä¸ºmap</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“å‰oldFiberï¼šbcd</span></span><br><span class="line"><span class="comment">// å½“å‰newChildrenï¼šcdb</span></span><br><span class="line"></span><br><span class="line">ç»§ç»­éå†å‰©ä½™newChildren</span><br><span class="line"></span><br><span class="line">key === c åœ¨ oldFiberä¸­å­˜åœ¨</span><br><span class="line"><span class="keyword">const</span> oldIndex = cï¼ˆä¹‹å‰ï¼‰.index;</span><br><span class="line">å³ oldIndex ä»£è¡¨å½“å‰å¯å¤ç”¨èŠ‚ç‚¹ï¼ˆcï¼‰åœ¨ä¸Šä¸€æ¬¡æ›´æ–°æ—¶çš„ä½ç½®ç´¢å¼•</span><br><span class="line">æ­¤æ—¶ oldIndex === <span class="number">2</span>; <span class="comment">// ä¹‹å‰èŠ‚ç‚¹ä¸º abcdï¼Œæ‰€ä»¥c.index === 2</span></span><br><span class="line">æ¯”è¾ƒ oldIndex ä¸ lastPlacedIndex;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å¦‚æœ oldIndex &gt;= lastPlacedIndex ä»£è¡¨è¯¥å¯å¤ç”¨èŠ‚ç‚¹ä¸éœ€è¦ç§»åŠ¨</span><br><span class="line">å¹¶å°† lastPlacedIndex = oldIndex;</span><br><span class="line">å¦‚æœ oldIndex &lt; lastplacedIndex è¯¥å¯å¤ç”¨èŠ‚ç‚¹ä¹‹å‰æ’å…¥çš„ä½ç½®ç´¢å¼•å°äºè¿™æ¬¡æ›´æ–°éœ€è¦æ’å…¥çš„ä½ç½®ç´¢å¼•ï¼Œä»£è¡¨è¯¥èŠ‚ç‚¹éœ€è¦å‘å³ç§»åŠ¨</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">åœ¨ä¾‹å­ä¸­ï¼ŒoldIndex <span class="number">2</span> &gt; lastPlacedIndex <span class="number">0</span>ï¼Œ</span><br><span class="line">åˆ™ lastPlacedIndex = <span class="number">2</span>;</span><br><span class="line">cèŠ‚ç‚¹ä½ç½®ä¸å˜</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ç»§ç»­éå†å‰©ä½™newChildren</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“å‰oldFiberï¼šbd</span></span><br><span class="line"><span class="comment">// å½“å‰newChildrenï¼šdb</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">key === d åœ¨ oldFiberä¸­å­˜åœ¨</span><br><span class="line"><span class="keyword">const</span> oldIndex = dï¼ˆä¹‹å‰ï¼‰.index;</span><br><span class="line"></span><br><span class="line">oldIndex <span class="number">3</span> &gt; lastPlacedIndex <span class="number">2</span> <span class="comment">// ä¹‹å‰èŠ‚ç‚¹ä¸º abcdï¼Œæ‰€ä»¥d.index === 3</span></span><br><span class="line">åˆ™ lastPlacedIndex = <span class="number">3</span>;</span><br><span class="line">dèŠ‚ç‚¹ä½ç½®ä¸å˜</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ç»§ç»­éå†å‰©ä½™newChildren</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“å‰oldFiberï¼šb</span></span><br><span class="line"><span class="comment">// å½“å‰newChildrenï¼šb</span></span><br><span class="line"></span><br><span class="line">key === b åœ¨ oldFiberä¸­å­˜åœ¨</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> oldIndex = bï¼ˆä¹‹å‰ï¼‰.index;</span><br><span class="line"></span><br><span class="line">oldIndex <span class="number">1</span> &lt; lastPlacedIndex <span class="number">3</span> <span class="comment">// ä¹‹å‰èŠ‚ç‚¹ä¸º abcdï¼Œæ‰€ä»¥b.index === 1</span></span><br><span class="line">åˆ™ bèŠ‚ç‚¹éœ€è¦å‘å³ç§»åŠ¨</span><br><span class="line">===ç¬¬äºŒè½®éå†ç»“æŸ===</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æœ€ç»ˆacd <span class="number">3</span>ä¸ªèŠ‚ç‚¹éƒ½æ²¡æœ‰ç§»åŠ¨ï¼ŒbèŠ‚ç‚¹è¢«æ ‡è®°ä¸ºç§»åŠ¨</span><br></pre></td></tr></table></figure><p>ç›¸ä¿¡ä½ å·²ç»æ˜ç™½äº†èŠ‚ç‚¹ç§»åŠ¨æ˜¯å¦‚ä½•åˆ¤æ–­çš„</p><p>å†æ¥çœ‹ä¸€ä¸ªä¾‹å­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// ä¹‹å‰abcd</span><br><span class="line">// ä¹‹ådabc</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">===ç¬¬ä¸€è½®éå†å¼€å§‹===</span><br><span class="line">dï¼ˆä¹‹åï¼‰vs aï¼ˆä¹‹å‰ï¼‰</span><br><span class="line">keyä¸å˜ï¼Œtypeæ”¹å˜ï¼Œä¸èƒ½å¤ç”¨ï¼Œè·³å‡ºéå†</span><br><span class="line">===ç¬¬ä¸€è½®éå†ç»“æŸ===</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">===ç¬¬äºŒè½®éå†å¼€å§‹===</span><br><span class="line">newChildren === dabcï¼Œæ²¡ç”¨å®Œï¼Œä¸éœ€è¦æ‰§è¡Œåˆ é™¤æ—§èŠ‚ç‚¹</span><br><span class="line">oldFiber === abcdï¼Œæ²¡ç”¨å®Œï¼Œä¸éœ€è¦æ‰§è¡Œæ’å…¥æ–°èŠ‚ç‚¹</span><br><span class="line"></span><br><span class="line">å°†å‰©ä½™oldFiberï¼ˆabcdï¼‰ä¿å­˜ä¸ºmap</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ç»§ç»­éå†å‰©ä½™newChildren</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“å‰oldFiberï¼šabcd</span></span><br><span class="line"><span class="comment">// å½“å‰newChildren dabc</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">key === d åœ¨ oldFiberä¸­å­˜åœ¨</span><br><span class="line"><span class="keyword">const</span> oldIndex = dï¼ˆä¹‹å‰ï¼‰.index;</span><br><span class="line">æ­¤æ—¶ oldIndex === <span class="number">3</span>; <span class="comment">// ä¹‹å‰èŠ‚ç‚¹ä¸º abcdï¼Œæ‰€ä»¥d.index === 3</span></span><br><span class="line">æ¯”è¾ƒ oldIndex ä¸ lastPlacedIndex;</span><br><span class="line">oldIndex <span class="number">3</span> &gt; lastPlacedIndex <span class="number">0</span></span><br><span class="line">åˆ™ lastPlacedIndex = <span class="number">3</span>;</span><br><span class="line">dèŠ‚ç‚¹ä½ç½®ä¸å˜</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ç»§ç»­éå†å‰©ä½™newChildren</span><br><span class="line"><span class="comment">// å½“å‰oldFiberï¼šabc</span></span><br><span class="line"><span class="comment">// å½“å‰newChildren abc</span></span><br><span class="line"></span><br><span class="line">key === a åœ¨ oldFiberä¸­å­˜åœ¨</span><br><span class="line"><span class="keyword">const</span> oldIndex = aï¼ˆä¹‹å‰ï¼‰.index; <span class="comment">// ä¹‹å‰èŠ‚ç‚¹ä¸º abcdï¼Œæ‰€ä»¥a.index === 0</span></span><br><span class="line">æ­¤æ—¶ oldIndex === <span class="number">0</span>;</span><br><span class="line">æ¯”è¾ƒ oldIndex ä¸ lastPlacedIndex;</span><br><span class="line">oldIndex <span class="number">0</span> &lt; lastPlacedIndex <span class="number">3</span></span><br><span class="line">åˆ™ aèŠ‚ç‚¹éœ€è¦å‘å³ç§»åŠ¨</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ç»§ç»­éå†å‰©ä½™newChildren</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“å‰oldFiberï¼šbc</span></span><br><span class="line"><span class="comment">// å½“å‰newChildren bc</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">key === b åœ¨ oldFiberä¸­å­˜åœ¨</span><br><span class="line"><span class="keyword">const</span> oldIndex = bï¼ˆä¹‹å‰ï¼‰.index; <span class="comment">// ä¹‹å‰èŠ‚ç‚¹ä¸º abcdï¼Œæ‰€ä»¥b.index === 1</span></span><br><span class="line">æ­¤æ—¶ oldIndex === <span class="number">1</span>;</span><br><span class="line">æ¯”è¾ƒ oldIndex ä¸ lastPlacedIndex;</span><br><span class="line">oldIndex <span class="number">1</span> &lt; lastPlacedIndex <span class="number">3</span></span><br><span class="line">åˆ™ bèŠ‚ç‚¹éœ€è¦å‘å³ç§»åŠ¨</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ç»§ç»­éå†å‰©ä½™newChildren</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“å‰oldFiberï¼šc</span></span><br><span class="line"><span class="comment">// å½“å‰newChildren c</span></span><br><span class="line"></span><br><span class="line">key === c åœ¨ oldFiberä¸­å­˜åœ¨</span><br><span class="line"><span class="keyword">const</span> oldIndex = cï¼ˆä¹‹å‰ï¼‰.index; <span class="comment">// ä¹‹å‰èŠ‚ç‚¹ä¸º abcdï¼Œæ‰€ä»¥c.index === 2</span></span><br><span class="line">æ­¤æ—¶ oldIndex === <span class="number">2</span>;</span><br><span class="line">æ¯”è¾ƒ oldIndex ä¸ lastPlacedIndex;</span><br><span class="line">oldIndex <span class="number">2</span> &lt; lastPlacedIndex <span class="number">3</span></span><br><span class="line">åˆ™ cèŠ‚ç‚¹éœ€è¦å‘å³ç§»åŠ¨</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">===ç¬¬äºŒè½®éå†ç»“æŸ===</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä»¥ä¸ºä» abcd å˜ä¸º dabcï¼Œåªéœ€è¦å°†dç§»åŠ¨åˆ°å‰é¢ã€‚</p><p>ä½†å®é™…ä¸ŠReactä¿æŒdä¸å˜ï¼Œå°†abcåˆ†åˆ«ç§»åŠ¨åˆ°äº†dçš„åé¢ã€‚</p><p>ä»è¿™ç‚¹å¯ä»¥çœ‹å‡ºï¼Œè€ƒè™‘æ€§èƒ½ï¼Œæˆ‘ä»¬è¦å°½é‡å‡å°‘å°†èŠ‚ç‚¹ä»åé¢ç§»åŠ¨åˆ°å‰é¢çš„æ“ä½œã€‚</p><h4 id="æ³¨é‡Šè¿‡çš„Reactæºç "><a href="#æ³¨é‡Šè¿‡çš„Reactæºç " class="headerlink" title="æ³¨é‡Šè¿‡çš„Reactæºç "></a><a href="https://github.com/BetaSu/react-on-the-way/blob/master/packages/react-reconciler/ReactChildFiber.js#L265" target="_blank" rel="noopener">æ³¨é‡Šè¿‡çš„Reactæºç </a></h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// diffç®—æ³•ä¼šè¿›è¡Œä¸¤è½®éå†ï¼Œå¯èƒ½ä¸­é—´æœ‰ä¸­æ–­ï¼Œæ—¶é—´å¤æ‚åº¦O(n)</span></span><br><span class="line">  <span class="comment">// å¯å¤ç”¨èŠ‚ç‚¹çš„å‡ ç§æƒ…å†µï¼š</span></span><br><span class="line">  <span class="comment">// 1. ç›¸åŒkeyï¼ˆindexå¯ä»¥ä¸åŒï¼‰ç›¸åŒtype</span></span><br><span class="line">  <span class="comment">// 2. æ²¡æœ‰keyï¼Œç›¸åŒindexï¼Œç›¸åŒtype</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reconcileChildrenArray</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">returnFiber, </span></span></span><br><span class="line"><span class="function"><span class="params"> currentFirstChild, </span></span></span><br><span class="line"><span class="function"><span class="params"> newChildren, </span></span></span><br><span class="line"><span class="function"><span class="params"> expirationTime   <span class="comment">// æœ€æ–°ç‰ˆæœ¬æ¢ä¸ºäº† lanes: Lanes,</span></span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ç”±äºfiberæ²¡æœ‰ä¿å­˜beforeå¼•ç”¨ï¼Œæ‰€ä»¥æ— æ³•é€šè¿‡å¤´å°¾åŒæŒ‡é’ˆçš„æ–¹å¼ä¼˜åŒ–diffç®—æ³•</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// diffå®Œæˆåæ–°çš„ç¬¬ä¸€ä¸ªchild</span></span><br><span class="line">    <span class="keyword">let</span> resultingFirstChild = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> previousNewFiber = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// å¯å¤ç”¨èŠ‚ç‚¹çš„ä½ç½®å¯èƒ½å’Œä¸Šæ¬¡ä¸åŒï¼ˆéœ€è¦æ ‡è®°Placementä»£è¡¨ç§»åŠ¨ï¼‰ exï¼š abcd =&gt; badc</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥åˆ¤æ–­å®Œæ˜¯å¦å¯å¤ç”¨åè¿˜éœ€è¦æ¯”è¾ƒindexï¼Œå…·ä½“é€»è¾‘è§ placeChild</span></span><br><span class="line">    <span class="keyword">let</span> lastPlacedIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// éå†åˆ°çš„newChild ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">let</span> newIdx = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// éå†è¿‡ç¨‹ä¸­ç”¨äºæ¯”è¾ƒçš„è€fiber</span></span><br><span class="line">    <span class="keyword">let</span> oldFiber = currentFirstChild;</span><br><span class="line">    <span class="keyword">let</span> nextOldFiber = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¬¬ä¸€è½®éå†ï¼Œå¯¹æ¯”oldFiberä¸newChildren[i]å¯»æ‰¾å¯ä»¥å¤ç”¨çš„fiberï¼Œå¯å¤ç”¨æ¡ä»¶ï¼š</span></span><br><span class="line">    <span class="comment">// 1. æ–°æ—§èŠ‚ç‚¹éƒ½ä¸ºæ–‡æœ¬èŠ‚ç‚¹ï¼Œç›´æ¥å¤ç”¨ï¼ˆæ–‡æœ¬èŠ‚ç‚¹æ²¡æœ‰keyï¼‰</span></span><br><span class="line">    <span class="comment">// 2. å…¶ä»–ç±»å‹èŠ‚ç‚¹åˆ¤æ–­keyæ˜¯å¦ç›¸åŒå†³å®šå¤ç”¨ï¼ˆå¯èƒ½keyç›¸åŒä½†æ˜¯ç±»å‹ä¸åŒï¼‰</span></span><br><span class="line">    <span class="comment">// è¿™æ¬¡éå†è¦æ±‚æ–°æ—§fiber keyç›¸åŒï¼Œé¡ºåºç›¸åŒï¼Œå¦‚æœé‡åˆ°ä¸æ»¡è¶³çš„åˆ™è·³å‡ºè¿™æ¬¡éå†</span></span><br><span class="line">    <span class="keyword">for</span> (; oldFiber !== <span class="literal">null</span> &amp;&amp; newIdx &lt; newChildren.length; newIdx++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (oldFiber.index &gt; newIdx) &#123;</span><br><span class="line">        <span class="comment">// fiber.index å§‹ç»ˆç­‰äºè¯¥fiberåœ¨æ•°ç»„ä¸­çš„ç´¢å¼•ï¼Œå³ä½¿å…¶å‰ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹æ˜¯null</span></span><br><span class="line">        <span class="comment">// exï¼š [null, a] ï¼Œ å…¶ä¸­ a.index === 1</span></span><br><span class="line">        <span class="comment">// ä¸Šæ¬¡çš„ç´¢å¼•å¤§äºè¿™æ¬¡ï¼Œä»£è¡¨ä¸Šæ¬¡è¿™ä¸ªèŠ‚ç‚¹ä¹‹å‰çš„å…„å¼ŸèŠ‚ç‚¹æœ‰null  exï¼š [null, a] </span></span><br><span class="line">        <span class="comment">// å‡è®¾è¿™æ¬¡æ˜¯ [b, a] ï¼Œåˆ™å®é™…ä¸Š diffçš„æ˜¯ null -&gt; b   a -&gt; a</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥è¿™é‡Œè¿™ä¹ˆèµ‹å€¼</span></span><br><span class="line">        nextOldFiber = oldFiber;</span><br><span class="line">        oldFiber = <span class="literal">null</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nextOldFiber = oldFiber.sibling;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// keyç›¸åŒåˆ™æ›´æ–°fiber</span></span><br><span class="line">      <span class="comment">//   æ›´æ–°åŒ…æ‹¬ å¤ç”¨fiberæˆ–è€…åˆ›å»ºæ–°fiber</span></span><br><span class="line">      <span class="comment">// keyä¸åŒåˆ™è¿”å›nullï¼Œä»£è¡¨è¯¥èŠ‚ç‚¹ä¸èƒ½å¤ç”¨</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// å°è¯•å¤ç”¨èŠ‚ç‚¹</span></span><br><span class="line">      <span class="keyword">const</span> newFiber = updateSlot(</span><br><span class="line">        returnFiber,</span><br><span class="line">        oldFiber,</span><br><span class="line">        newChildren[newIdx],</span><br><span class="line">        expirationTime</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">if</span> (newFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// è¯¥ç´¢å¼•å¯¹åº”ä½ç½®çš„æ–°èŠ‚ç‚¹æ˜¯ null</span></span><br><span class="line">        <span class="keyword">if</span> (!oldFiber) &#123;</span><br><span class="line">          oldFiber = nextOldFiber;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">        <span class="keyword">if</span> (oldFiber &amp;&amp; !newFiber.alternate) &#123;</span><br><span class="line">          <span class="comment">// oldFiberä¸newFiberéƒ½å­˜åœ¨ä»£è¡¨å¯¹åº”ç´¢å¼•keyæ²¡å˜åŒ–</span></span><br><span class="line">          <span class="comment">// !newFiber.alternateä»£è¡¨newFiberæ˜¯æ–°åˆ›å»ºçš„fiber</span></span><br><span class="line">          <span class="comment">//   exï¼šoldFiber: &lt;div key="1"&gt;&lt;/div&gt; newFiber: &lt;p key="1"&gt;&lt;/p&gt;</span></span><br><span class="line">          <span class="comment">//   æ–°æ—§fiber keyç›¸åŒï¼Œåˆ™newFiberå­˜åœ¨ï¼Œä½†æ˜¯typeä¸åŒï¼Œæ‰€ä»¥æ˜¯åˆ›å»ºæ–°fiberï¼Œæ²¡æœ‰å¯¹åº”alternate</span></span><br><span class="line">          <span class="comment">// æ’å…¥æ–°DOMèŠ‚ç‚¹çš„åŒæ—¶åˆ æ‰è€çš„DOMèŠ‚ç‚¹</span></span><br><span class="line">          deleteChild(returnFiber, oldFiber);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å°†å¯å¤ç”¨çš„æ–°fiberæ’å…¥ï¼Œè¿”å›æ’å…¥çš„ç´¢å¼•</span></span><br><span class="line">      lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!previousNewFiber) &#123;</span><br><span class="line">        <span class="comment">// è¿™æ˜¯ç¬¬ä¸€ä¸ªæ’å…¥çš„æ–°fiber</span></span><br><span class="line">        resultingFirstChild = newFiber;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        previousNewFiber.sibling = newFiber;</span><br><span class="line">      &#125;</span><br><span class="line">      previousNewFiber = newFiber;</span><br><span class="line">      oldFiber = nextOldFiber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¬¬äºŒè½®éå†æƒ…å†µ1 newChildrenéå†å®Œæ—¶</span></span><br><span class="line">    <span class="keyword">if</span> (newIdx === newChildren.length) &#123;</span><br><span class="line">      <span class="comment">// å½“newChildrenéå†å®Œæ—¶ï¼Œä»£è¡¨ç¬¬ä¸€è½®æ‰€æœ‰æ–°èŠ‚ç‚¹éƒ½å¯å¤ç”¨ï¼Œ</span></span><br><span class="line">      <span class="comment">// åªéœ€è¦åˆ é™¤å‰©ä¸‹çš„oldFiberï¼Œå› ä¸ºè¿™éƒ¨åˆ†oldFiberåœ¨æ–°çš„æ•°ç»„é‡Œå·²ç»ä¸å­˜åœ¨äº†</span></span><br><span class="line">      deleteRemainingChildren(returnFiber, oldFiber);</span><br><span class="line">      <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç¬¬äºŒè½®éå†æƒ…å†µ2 oldFiberéå†å®Œæ—¶</span></span><br><span class="line">    <span class="keyword">if</span> (!oldFiber) &#123;</span><br><span class="line">      <span class="comment">// å½“oldFiberéå†å®Œæ—¶ï¼Œä»£è¡¨æ‰€æœ‰oldFiberå·²ç»å¤ç”¨å®Œæˆ–è€…è¿™æ˜¯é¦–æ¬¡æ¸²æŸ“æ²¡æœ‰oldFiber</span></span><br><span class="line">      <span class="comment">// å†éå†newChildrenï¼ŒæŠŠæ–°èŠ‚ç‚¹appendåˆ°åé¢ï¼Œè¿™éƒ¨åˆ†åœ¨oldFiberä¸­ä¸å­˜åœ¨çš„èŠ‚ç‚¹æ˜¯æ–°åŠ å…¥çš„</span></span><br><span class="line">      <span class="keyword">for</span> (; newIdx &lt; newChildren.length; newIdx++) &#123;</span><br><span class="line">        <span class="keyword">const</span> newFiber = createChild(returnFiber, newChildren[newIdx], expirationTime);</span><br><span class="line">        <span class="keyword">if</span> (!newFiber) &#123;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line">        <span class="keyword">if</span> (previousNewFiber === <span class="literal">null</span>) &#123;</span><br><span class="line">          resultingFirstChild = newFiber;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          previousNewFiber.sibling = newFiber;</span><br><span class="line">        &#125;</span><br><span class="line">        previousNewFiber = newFiber;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¬¬äºŒè½®éå†æƒ…å†µ3 newChildrenï¼ŒoldFiberéƒ½æœªéå†å®Œ</span></span><br><span class="line">    <span class="comment">// å°†å¯å¤ç”¨çš„èŠ‚ç‚¹ç§»åŠ¨ä½ç½®</span></span><br><span class="line">    <span class="comment">// å°†æ‰€æœ‰æœªéå†çš„oldFiberå­˜å…¥mapï¼Œè¿™æ ·åœ¨æ¥ä¸‹æ¥çš„éå†ä¸­èƒ½O(1)çš„å¤æ‚åº¦å°±èƒ½é€šè¿‡keyæ‰¾åˆ°å¯¹åº”çš„oldFiber</span></span><br><span class="line">    <span class="keyword">const</span> existingChildren = mapRemainingChildren(returnFiber, oldFiber);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (; newIdx &lt; newChildren.length; newIdx++) &#123;</span><br><span class="line">      <span class="keyword">const</span> newFiber = updateFromMap(</span><br><span class="line">        existingChildren,</span><br><span class="line">        returnFiber,</span><br><span class="line">        newIdx,</span><br><span class="line">        newChildren[newIdx],</span><br><span class="line">        expirationTime</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">if</span> (newFiber) &#123;</span><br><span class="line">        <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">          <span class="keyword">if</span> (newFiber.alternate) &#123;</span><br><span class="line">            <span class="comment">// å­˜åœ¨currentï¼Œä»£è¡¨æˆ‘ä»¬éœ€è¦å¤ç”¨è¿™ä¸ªèŠ‚ç‚¹ï¼Œå°†å¯¹åº”oldFiberä»mapä¸­åˆ é™¤</span></span><br><span class="line">            <span class="comment">// è¿™æ ·è¯¥oldFiberå°±ä¸ä¼šç½®ä¸ºåˆ é™¤</span></span><br><span class="line">            existingChildren.delete(newFiber.key === <span class="literal">null</span> ? newIdx : newFiber.key);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);</span><br><span class="line">        <span class="keyword">if</span> (!previousNewFiber) &#123;</span><br><span class="line">          resultingFirstChild = newFiber;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          previousNewFiber.sibling = newFiber;</span><br><span class="line">        &#125;</span><br><span class="line">        previousNewFiber = newFiber;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="comment">// è¿˜ç•™ä¸‹çš„oldFiberè¡¨ç¤ºæ²¡æœ‰è¢«å¤ç”¨ï¼Œéœ€è¦åˆ é™¤</span></span><br><span class="line">      existingChildren.forEach(<span class="function"><span class="params">child</span> =&gt;</span> deleteChild(returnFiber, child));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// åè°ƒå­èŠ‚ç‚¹ï¼Œåˆ†ä¸º mount å’Œ reconcile 2ç±»</span></span><br><span class="line">  <span class="comment">// mountç”¨äºé¦–æ¬¡æ¸²æŸ“ï¼Œchildæ²¡æœ‰å¯¹åº”fiberï¼Œç›´æ¥ç”Ÿæˆfiberï¼Œmountä¸ä¼šæ”¹å˜fiberçš„effectTagï¼ŒåŸå› è§ appendAllChildren</span></span><br><span class="line">  <span class="comment">// reconcileç”¨äºæ›´æ–°</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reconcileChildFibers</span>(<span class="params">returnFiber, currentFirstChild, newChild, expirationTime</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// React.createElementç±»å‹ æˆ–è€… å­èŠ‚ç‚¹æ˜¯Stringã€Numberå¯¹åº”çš„Arrayç±»å‹</span></span><br><span class="line">    <span class="keyword">const</span> isObject = <span class="keyword">typeof</span> newChild === <span class="string">'object'</span> &amp;&amp; newChild !== <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (isObject) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (newChild.$$<span class="keyword">typeof</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> REACT_ELEMENT_TYPE:</span><br><span class="line">          <span class="keyword">return</span> placeSingleChild(reconcileSingleElement(</span><br><span class="line">            returnFiber,</span><br><span class="line">            currentFirstChild,</span><br><span class="line">            newChild,</span><br><span class="line">            expirationTime</span><br><span class="line">          ))</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// åœ¨ beginWork updateå„ç±»Componentæ—¶å¹¶æœªå¤„ç†HostTextï¼Œè¿™é‡Œå¤„ç†å•ä¸ªHostText</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">'number'</span> || <span class="keyword">typeof</span> newChild === <span class="string">'string'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> placeSingleChild(reconcileSingleTextNode(</span><br><span class="line">          returnFiber,</span><br><span class="line">          currentFirstChild,</span><br><span class="line">          newChild,</span><br><span class="line">          expirationTime</span><br><span class="line">        ))</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// åœ¨ beginWork updateå„ç±»Componentæ—¶å¹¶æœªå¤„ç†HostTextï¼Œè¿™é‡Œå¤„ç†å¤šä¸ªHostText</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(newChild)) &#123;</span><br><span class="line">        <span class="keyword">return</span> reconcileChildrenArray(</span><br><span class="line">          returnFiber,</span><br><span class="line">          currentFirstChild,</span><br><span class="line">          newChild,</span><br><span class="line">          expirationTime</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…œåº•åˆ é™¤</span></span><br><span class="line">    <span class="keyword">return</span> deleteRemainingChildren(returnFiber, currentFirstChild);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> reconcileChildFibers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒå¤§ä½¬"><a href="#å‚è€ƒå¤§ä½¬" class="headerlink" title="å‚è€ƒå¤§ä½¬"></a>å‚è€ƒå¤§ä½¬</h2><ol><li><p>å¥‡èˆå‘¨åˆŠ. <a href="https://mp.weixin.qq.com/s/e0fDbM5pp9bX1YuYBSXhLA" target="_blank" rel="noopener">Reactæºç æ­ç§˜(ä¸‰)ï¼šDiffç®—æ³•è¯¦è§£</a></p></li><li><p><a href="https://github.com/BetaSu/react-on-the-way/blob/master/packages/react-reconciler/ReactChildFiber.js#L265" target="_blank" rel="noopener">https://github.com/BetaSu/react-on-the-way/blob/master/packages/react-reconciler/ReactChildFiber.js#L265</a></p></li><li><p><a href="https://blog.csdn.net/qiwoo_weekly/article/details/106247621" target="_blank" rel="noopener">https://blog.csdn.net/qiwoo_weekly/article/details/106247621</a></p></li><li><p><a href="https://juejin.im/post/5e9abf06e51d454702460bf6#heading-5" target="_blank" rel="noopener">https://juejin.im/post/5e9abf06e51d454702460bf6#heading-5</a></p></li><li><p><a href="https://juejin.im/post/5ec507146fb9a047f47cb805" target="_blank" rel="noopener">https://juejin.im/post/5ec507146fb9a047f47cb805</a> (åŸä½œè€…å¤§ä½¬)</p></li><li><p><a href="https://segmentfault.com/a/1190000018250127" target="_blank" rel="noopener">https://segmentfault.com/a/1190000018250127</a></p></li><li><p><a href="https://segmentfault.com/a/1190000018250127" target="_blank" rel="noopener">React Fiber åŸç†ä»‹ç»</a></p></li></ol>]]></content>
    
    <summary type="html">
    
      React diffç®€æ˜“æºç åŸç†æ¢ç©¶
    
    </summary>
    
      <category term="é»˜è®¤åˆ†ç±»" scheme="https://kitions.github.io/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/"/>
    
    
      <category term="React" scheme="https://kitions.github.io/tags/React/"/>
    
      <category term="diff" scheme="https://kitions.github.io/tags/diff/"/>
    
  </entry>
  
  <entry>
    <title>React ä¸¤å¤§ç‰¹è‰²ä¹‹React diff</title>
    <link href="https://kitions.github.io/2020/05/18/React%20diff/"/>
    <id>https://kitions.github.io/2020/05/18/React diff/</id>
    <published>2020-05-18T10:51:45.000Z</published>
    <updated>2020-05-27T08:45:26.543Z</updated>
    
    <content type="html"><![CDATA[<h1 id="React-ä¸¤å¤§ç‰¹è‰²ä¹‹React-diff"><a href="#React-ä¸¤å¤§ç‰¹è‰²ä¹‹React-diff" class="headerlink" title="React ä¸¤å¤§ç‰¹è‰²ä¹‹React diff"></a>React ä¸¤å¤§ç‰¹è‰²ä¹‹React diff</h1><p>React çš„ä¸¤å¤§ç‰¹è‰²ï¼šReact diff å’Œ Virtual Domã€‚</p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>React diffï¼Œæ˜¯ Virtual DOMå’Œæ¸²æŸ“çš„æ€§èƒ½ä¿è¯ï¼Œé«˜æ•ˆçš„diffç®—æ³•æå¤§åœ°ä¿éšœäº†Reactçš„æ€§èƒ½ã€‚ä½¿æˆ‘ä»¬çš„é¡µé¢çš„æ„å»ºæ•ˆç‡æåˆ°äº†æå¤§çš„æå‡ã€‚</p><h2 id="ä¼ ç»Ÿçš„diffç®—æ³•"><a href="#ä¼ ç»Ÿçš„diffç®—æ³•" class="headerlink" title="ä¼ ç»Ÿçš„diffç®—æ³•"></a>ä¼ ç»Ÿçš„diffç®—æ³•</h2><p>ä¼ ç»Ÿdiffç®—æ³•é€šè¿‡å¾ªç¯é€’å½’å¯¹èŠ‚ç‚¹è¿›è¡Œä¾æ¬¡å¯¹æ¯”ï¼Œæ•ˆç‡ä½ä¸‹ï¼Œç®—æ³•å¤æ‚åº¦è¾¾åˆ° O(n^3)ï¼Œå…¶ä¸­ n æ˜¯æ ‘ä¸­èŠ‚ç‚¹çš„æ€»æ•°ã€‚å…·ä½“æ˜¯æ€ä¹ˆç®—å‡ºæ¥çš„ï¼Œå¯ä»¥æŸ¥çœ‹çŸ¥ä¹ä¸Šçš„ä¸€ä¸ªå›ç­”ã€‚</p><p><a href="https://www.zhihu.com/question/66851503" target="_blank" rel="noopener">reactçš„diff ä»O(n^3)åˆ° O(n) ï¼Œè¯·é—® O(n^3) å’ŒO(n) æ˜¯æ€ä¹ˆç®—å‡ºæ¥ï¼Ÿ</a></p><p>æ‡’å¾—ç‚¹é“¾æ¥çœ‹ä¸‹ï¼š</p><p>ä¼ ç»ŸDiffç®—æ³•éœ€è¦æ‰¾åˆ°ä¸¤ä¸ªæ ‘çš„æœ€å°æ›´æ–°æ–¹å¼ï¼Œæ‰€ä»¥éœ€è¦[ä¸¤ä¸¤]å¯¹æ¯”æ¯ä¸ªå¶å­èŠ‚ç‚¹æ˜¯å¦ç›¸åŒï¼Œå¯¹æ¯”å°±éœ€è¦O(n^2)æ¬¡äº†ï¼Œå†åŠ ä¸Šæ›´æ–°ï¼ˆç§»åŠ¨ã€åˆ›å»ºã€åˆ é™¤ï¼‰æ—¶éœ€è¦éå†ä¸€æ¬¡ï¼Œæ‰€ä»¥æ˜¯O(n^3)ã€‚</p><p>æŸ¥æ‰¾ä¸åŒå°±éœ€è¦O(n^2)ï¼Œæ‰¾åˆ°å·®å¼‚åè¿˜è¦è®¡ç®—æœ€å°è½¬æ¢æ–¹å¼ï¼Œæœ€ç»ˆç»“æœä¸ºO(n^3)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Prev                  Last</span><br><span class="line">       A                     A  </span><br><span class="line">      / \                   / \</span><br><span class="line">     /   \                 /   \</span><br><span class="line">    B     D     ====&gt;     D     B</span><br><span class="line">   /                             \</span><br><span class="line">  C                               C</span><br></pre></td></tr></table></figure><p>å°±ä¸Šé¢ä¸¤æ ‘çš„å˜åŒ–è€Œè¨€ï¼Œè‹¥è¦è¾¾åˆ°æœ€å°æ›´æ–°ï¼Œé¦–å…ˆè¦å¯¹æ¯”æ¯ä¸ªèŠ‚ç‚¹æ˜¯å¦ç›¸åŒï¼Œä¹Ÿå°±æ˜¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PA-&gt;LA</span><br><span class="line">PA-&gt;LB</span><br><span class="line">PA-&gt;LC</span><br><span class="line">PA-&gt;LD</span><br><span class="line">PB-&gt;LA</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>Reactçš„Diffç®—æ³•å®Œå…¨ä¸åŒï¼Œç®€å•åˆ°æœ‰äº›ç²—æš´ï¼Œè¿‡ç¨‹å¦‚ä¸‹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># æŒ‰å¶å­èŠ‚ç‚¹ä½ç½®æ¯”è¾ƒ</span><br><span class="line">[0,0]     :     PA-&gt;LA   # ç›¸åŒï¼Œä¸ç†ä¼š</span><br><span class="line">[0.0, 0.0]:     PB-&gt;LD   # ä¸åŒï¼Œåˆ é™¤PBï¼Œæ·»åŠ LD</span><br><span class="line">[0.1, 0.1]:     PD-&gt;LB   # ä¸åŒï¼Œæ›´æ–°</span><br><span class="line">[0.1.0, 0.1.0]: PC-&gt;Null # Lastæ ‘æ²¡æœ‰è¯¥èŠ‚ç‚¹ï¼Œæ‰€ä»¥åˆ é™¤PCå³å¯</span><br><span class="line">[0.1.2, 0.1.2]: Null-&gt;LC # Prevæ ‘æ²¡æœ‰è¯¥èŠ‚ç‚¹ï¼Œæ‰€ä»¥æ·»åŠ Cåˆ°è¯¥ä½ç½®</span><br></pre></td></tr></table></figure><p>æ ‡å‡†çš„O(n)ï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹åªéå†ä¸€æ¬¡ã€‚</p><p>O(n^3)åˆ°O(n)çš„æå‡æœ‰å¤šå¤§ï¼Œé€šè¿‡ä¸€å¼ å›¾æ¥çœ‹ä¸€ä¸‹</p><p><img src="https://i.loli.net/2020/05/13/qGAO7U2kXWx3eiu.png" alt="image.png" style="zoom:50%;"></p><h2 id="Reactçš„diffç­–ç•¥"><a href="#Reactçš„diffç­–ç•¥" class="headerlink" title="Reactçš„diffç­–ç•¥"></a>Reactçš„diffç­–ç•¥</h2><ol><li><p>ç­–ç•¥ä¸€ï¼šå¿½ç•¥Web UIä¸­DOMèŠ‚ç‚¹è·¨å±‚çº§ç§»åŠ¨ï¼›ï¼ˆè·¨å±‚çº§ä¸è¿›è¡Œæ¯”è¾ƒï¼‰</p></li><li><p>ç­–ç•¥äºŒï¼šæ‹¥æœ‰ç›¸åŒç±»å‹çš„ä¸¤ä¸ªç»„ä»¶äº§ç”Ÿçš„DOMç»“æ„ä¹Ÿæ˜¯ç›¸ä¼¼çš„ï¼Œä¸åŒç±»å‹çš„ä¸¤ä¸ªç»„ä»¶äº§ç”Ÿçš„DOMç»“æ„åˆ™ä¸è¿‘ç›¸åŒï¼ˆä¸åŒç±»ä¸è¿›è¡Œæ¯”è¾ƒï¼ŒåŒçº§èŠ‚ç‚¹åšdiffï¼‰</p></li><li><p>ç­–ç•¥ä¸‰ï¼šå¯¹äºåŒä¸€å±‚çº§çš„ä¸€ç»„å­èŠ‚ç‚¹ï¼Œé€šè¿‡åˆ†é…å”¯ä¸€idè¿›è¡ŒåŒºåˆ†ï¼ˆåŒç±»åŒçº§é€šè¿‡keyæ¯”è¾ƒï¼‰</p></li></ol><p>ä¸Šé¢çš„å¥½åƒä¸å¤ªé€šä¿—æ˜“æ‡‚</p><ol><li>ä¸€ï¼šåªå¯¹åŒçº§å…ƒç´ è¿›è¡ŒDiffã€‚å¦‚æœä¸€ä¸ªDOMèŠ‚ç‚¹åœ¨å‰åä¸¤æ¬¡æ›´æ–°ä¸­è·¨è¶Šäº†å±‚çº§ï¼Œé‚£ä¹ˆReactä¸ä¼šå¤ç”¨å®ƒã€‚</li><li>äºŒï¼šä¸¤ä¸ªä¸åŒç±»å‹çš„å…ƒç´ ä¼šäº§ç”Ÿå‡ºä¸åŒçš„æ ‘ã€‚å¦‚æœå…ƒç´ ç”±divå˜ä¸ºpï¼ŒReactä¼šé”€æ¯divåŠå…¶å­å­™èŠ‚ç‚¹ï¼Œå¹¶æ–°å»ºpåŠå…¶å­å­™èŠ‚ç‚¹ã€‚</li><li>ä¸‰ï¼šå¼€å‘è€…å¯ä»¥é€šè¿‡ keyå±æ€§ æ¥æš—ç¤ºå“ªäº›å­å…ƒç´ åœ¨ä¸åŒçš„æ¸²æŸ“ä¸‹èƒ½ä¿æŒç¨³å®šã€‚</li></ol><p>åœ¨Web UIçš„åœºæ™¯ä¸‹ï¼ŒåŸºäºä»¥ä¸Šä¸‰ä¸ªç‚¹ï¼ŒReactå¯¹tree diffã€component diffã€element diffè¿›è¡Œä¼˜åŒ–ï¼Œå°†æ™®é€‚diffçš„å¤æ‚åº¦é™ä½åˆ°ä¸€ä¸ªæ•°é‡çº§ï¼Œä¿è¯äº†æ•´ä½“UIç•Œé¢çš„æ„å»ºæ€§èƒ½ï¼</p><h3 id="Tree-diff"><a href="#Tree-diff" class="headerlink" title="Tree diff"></a>Tree diff</h3><hr><p>é’ˆå¯¹ç­–ç•¥ä¸€ï¼ŒReactå¯¹æ ‘çš„ç®—æ³•è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¯¹æ ‘è¿›è¡Œåˆ†å±‚æ¯”è¾ƒï¼Œä¸¤æ£µæ ‘åªä¼šå¯¹åŒä¸€å±‚æ¬¡çš„èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒã€‚</p><p>æ—¢ç„¶DOMèŠ‚ç‚¹è·¨å±‚çº§çš„ç§»åŠ¨æ“ä½œå°‘åˆ°å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œé’ˆå¯¹è¿™ä¸€ç°è±¡ï¼ŒReactåªä¼šå¯¹ç›¸åŒå±‚çº§çš„DOMèŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒï¼Œå³åŒä¸€ä¸ªçˆ¶èŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹ã€‚å½“å‘ç°èŠ‚ç‚¹å·²ç»ä¸å­˜åœ¨æ—¶ï¼Œåˆ™è¯¥èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹ä¼šè¢«å®Œå…¨åˆ é™¤æ‰ï¼Œä¸ä¼šè¿›è¡Œä¸‹ä¸€æ­¥çš„æ¯”è¾ƒã€‚è¿™æ ·å°±åªéœ€è¦å¯¹æ ‘è¿›è¡Œä¸€æ¬¡éå†ï¼Œå°±èƒ½å®Œæˆæ•´ä¸ªDOMæ ‘çš„æ¯”è¾ƒã€‚</p><p><img src="https://i.loli.net/2020/05/14/iZWFCyOxuRKn52G.png" alt="image.png"></p><p>å‰ææ˜¯WEB ui ä¸­çš„DOMèŠ‚ç‚¹è·¨å±‚çº§çš„ç§»åŠ¨æ“ä½œç‰¹åˆ«å°‘ï¼Œä½†å¹¶æ²¡æœ‰å¦å®šDOMèŠ‚ç‚¹è·¨å±‚çº§çš„æ“ä½œçš„å­˜åœ¨ï¼Œé‚£ä¹ˆå½“é‡åˆ°è¿™ç§æ“ä½œæ—¶ï¼ŒReactçš„å¤„ç†æ–¹å¼</p><p>exampleï¼› A(åŒ…æ‹¬å…¶å­èŠ‚ç‚¹) â€“&gt; D</p><p><img src="https://i.loli.net/2020/05/14/Avw4XQcBJDCFMf8.png" alt="image.png"></p><p>ç”±äºReactåªä¼šç®€å•çš„è€ƒè™‘åŒå±‚çº§èŠ‚ç‚¹çš„ä½ç½®å˜æ¢ï¼Œè€Œå¯¹äºä¸åŒå±‚çº§çš„èŠ‚ç‚¹ï¼Œåªä¼šåˆ›å»ºå’Œåˆ é™¤æ“ä½œã€‚å½“æ ¹èŠ‚ç‚¹å‘ç°å­èŠ‚ç‚¹çš„Aæ¶ˆå¤±äº†ï¼Œå°±ä¼šç›´æ¥é”€æ¯Aï¼Œå½“Då‘ç°å¤šäº†ä¸€ä¸ªå­èŠ‚ç‚¹Aï¼Œåˆ™ä¼šåˆ›å»ºæ–°çš„A(åŒ…æ‹¬å­èŠ‚ç‚¹)ä½œä¸ºå…¶å­èŠ‚ç‚¹ã€‚æ­¤æ—¶ï¼Œdiffçš„æ‰§è¡Œæƒ…å†µæ˜¯ï¼›</p><p>â€‹                        CreateA â€”&gt;   CreateB â€”&gt;   CreateC â€”&gt;   DeleteA </p><p>  æ‰€ä»¥ï¼Œç”±æ­¤å¯ä»¥çœ‹å‡ºï¼Œå½“å‡ºç°èŠ‚ç‚¹è·¨å±‚çº§ç§»åŠ¨ï¼Œå¹¶ä¸ä¼šå‡ºç°æƒ³è±¡ä¸­çš„ç›´æ¥æŠŠæ•´ä¸ªAèŠ‚ç‚¹ç§»åŠ¨åˆ°DèŠ‚ç‚¹ä¸‹çš„ç§»åŠ¨æ“ä½œï¼Œè€Œæ˜¯ä»¥AèŠ‚ç‚¹çš„æ•´ä¸ªæ ‘ä¼šè¢«é‡æ–°åˆ›å»ºã€‚soï¼Œè¿™æ˜¯ä¸€ç§å½±å“Reactæ€§èƒ½çš„æ“ä½œï¼Œå› æ­¤å®˜æ–¹å»ºè®®ä¸è¦è¿›è¡ŒDOMèŠ‚ç‚¹è·¨å±‚çº§çš„æ“ä½œã€‚</p><blockquote><p>åœ¨å¼€å‘ç»„ä»¶æ—¶ï¼Œä¿æŒç¨³å®šçš„ DOM ç»“æ„ä¼šæœ‰åŠ©äºæ€§èƒ½çš„æå‡ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥é€šè¿‡ CSS éšè—æˆ–æ˜¾ç¤ºèŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯çœŸæ­£åœ°ç§»é™¤æˆ–æ·»åŠ  DOM èŠ‚ç‚¹ã€‚</p></blockquote><p>å›¾æ•´ä¸ªå¤„ç†è¿‡ç¨‹ï¼š</p><p><img src="https://i.loli.net/2020/05/14/GCazVwlI52WcSxd.png" alt="image.png"></p><h3 id="Component-diff"><a href="#Component-diff" class="headerlink" title="Component diff"></a>Component diff</h3><hr><p>React æ˜¯åŸºäºç»„ä»¶æ„å»ºåº”ç”¨çš„ï¼Œå¯¹äºç»„ä»¶é—´çš„æ¯”è¾ƒæ‰€é‡‡å–çš„ç­–ç•¥ä¹Ÿæ˜¯ç®€æ´ã€é«˜æ•ˆçš„ã€‚</p><ol><li><p><strong>å¦‚æœæ˜¯åŒä¸€ç±»å‹çš„ç»„ä»¶ï¼ŒæŒ‰ç…§åŸç­–ç•¥ç»§ç»­æ¯”è¾ƒ Virtual DOM æ ‘å³å¯ã€‚</strong></p></li><li><p><strong>å¦‚æœä¸æ˜¯ï¼Œåˆ™å°†è¯¥ç»„ä»¶åˆ¤å®šä¸ºdirty componentï¼Œä»è€Œæ›¿æ¢æ•´ä¸ªç»„ä»¶ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹</strong></p></li><li><p><strong>å¯¹äºåŒä¸€ç±»å‹çš„ç»„ä»¶ï¼Œæœ‰å¯èƒ½å…¶Virtual DOMæ²¡æœ‰ä»»ä½•å˜åŒ–ï¼Œå¦‚æœèƒ½å¤Ÿç¡®åˆ‡çŸ¥é“è¿™ç‚¹ï¼Œé‚£ä¹ˆå¯ä»¥èŠ‚çœå¤§é‡çš„diffè¿ç®—æ—¶é—´ï¼Œå› æ­¤ï¼ŒReactå…è®¸ç”¨æˆ·é€šè¿‡ShouldComponentUpdate()æ¥åˆ¤æ–­è¯¥ç»„ä»¶æ˜¯å¦éœ€è¦è¿›è¡Œdiffç®—æ³•ï¼Œä½†å¦‚æœè°ƒç”¨äº†forceUpdateæ–¹æ³•ï¼ŒShouldComponentUpdateä¼šå¤±æ•ˆ</strong></p><p>exampleï¼› D â€“&gt; G</p></li></ol><p><img src="https://i.loli.net/2020/05/13/juDeNmIx9zRHGE1.png" alt="image.png"></p><p>å†…éƒ¨æµç¨‹</p><p><img src="https://i.loli.net/2020/05/18/tGXixoF8fMYVhDa.png" alt="image.png"></p><p>å½“ç»„ä»¶Då˜ä¸ºç»„ä»¶Gæ—¶,å³ä½¿è¿™ä¸¤ä¸ªç»„ä»¶çš„ç»“æ„ç›¸ä¼¼,ä¸€æ—¦Reactåˆ¤æ–­Då’ŒGæ˜¯ä¸åŒç±»å‹çš„ç»„ä»¶ï¼Œå°±ä¸ä¼šæ¯”è¾ƒäºŒè€…çš„ç»“æ„ï¼Œè€Œæ˜¯ç›´æ¥åˆ é™¤ç»„ä»¶Dï¼Œé‡æ–°åˆ›å»ºç»„ä»¶GåŠå…¶å­èŠ‚ç‚¹ã€‚è™½ç„¶å½“ä¸¤ä¸ªç»„ä»¶æ—¶ä¸åŒç±»å‹ä½†ç»“æ„ç›¸ä¼¼æ—¶ï¼Œdiffä¼šå½±å“æ€§èƒ½ï¼Œä½†å…¥Reactå®˜æ–¹æ‰€è¯´ï¼Œä¸åŒç±»å‹çš„ç»„ä»¶å¾ˆå°‘å­˜åœ¨ç›¸ä¼¼DOMæ ‘çš„æƒ…å†µï¼Œå› æ­¤è¿™ç§æç«¯å› ç´ å¾ˆéš¾åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­é€ æˆè¾ƒå¤§çš„å½±å“ã€‚</p><h3 id="Element-diff"><a href="#Element-diff" class="headerlink" title="Element diff"></a>Element diff</h3><p>å½“èŠ‚ç‚¹å¤„äºåŒäºåŒä¸€å±‚çº§æ—¶å€™ï¼Œdiffæä¾›äº†3ç§èŠ‚ç‚¹æ“ä½œï¼Œåˆ†åˆ«æ˜¯æ’å…¥ã€ç§»åŠ¨ã€åˆ é™¤</p><ul><li>æ’å…¥ï¼šæ–°çš„ç»„ä»¶ç±»å‹ä¸åœ¨æ—§é›†åˆé‡Œï¼Œå³å…¨æ–°çš„èŠ‚ç‚¹ï¼Œéœ€è¦å¯¹æ–°èŠ‚ç‚¹æ‰§è¡Œæ’å…¥æ“ä½œ</li><li>ç§»åŠ¨ï¼šæ—§é›†åˆé‡Œæœ‰æ–°ç»„ä»¶ç±»å‹ï¼Œä¸”elementæ˜¯å¯æ›´æ–°çš„ç±»å‹ï¼Œè¿™ç§æƒ…å†µä¸‹ prevChild=nextChild ï¼Œå°±éœ€è¦åšç§»åŠ¨æ“ä½œï¼Œå¯ä»¥å¤ç”¨ä»¥å‰çš„ DOM èŠ‚ç‚¹ã€‚</li><li>åˆ é™¤ï¼šæ—§ç»„ä»¶ç±»å‹ï¼Œåœ¨æ–°é›†åˆé‡Œä¹Ÿæœ‰ï¼Œä½†å¯¹åº”çš„elementä¸åŒåˆ™ä¸èƒ½ç›´æ¥å¤ç”¨å’Œæ›´æ–°ï¼Œéœ€è¦æ‰§è¡Œåˆ é™¤æ“ä½œï¼Œæˆ–è€…æ—§ç»„ä»¶ä¸åœ¨æ–°é›†åˆé‡Œï¼Œä¹Ÿéœ€è¦æ‰§è¡Œåˆ é™¤æ“ä½œã€‚</li></ul><p><img src="https://i.loli.net/2020/05/18/SpXsxoKOGFJmEbj.png" style="zoom: 33%;"></p><p>æ—§é›†åˆä¸­åŒ…å«èŠ‚ç‚¹Aã€Bã€Cå’ŒDï¼Œ</p><p>æ›´æ–°åçš„æ–°é›†åˆä¸­åŒ…å«èŠ‚ç‚¹Bã€Aã€Då’ŒCï¼Œ</p><p>æ­¤æ—¶æ–°æ—§é›†åˆè¿›è¡Œdiffå·®å¼‚åŒ–å¯¹æ¯”ï¼Œå‘ç°B!=Aï¼Œåˆ™åˆ›å»ºå¹¶æ’å…¥Bè‡³æ–°é›†åˆï¼Œåˆ é™¤æ—§é›†åˆA;ä»¥æ­¤ç±»æ¨ï¼Œåˆ›å»ºå¹¶æ’å…¥Aã€Då’ŒCï¼Œåˆ é™¤Bã€Cå’ŒDã€‚</p><hr><p>æˆ‘ä»¬å‘ç°è¿™äº›éƒ½æ˜¯ç›¸åŒçš„èŠ‚ç‚¹ï¼Œä»…ä»…æ˜¯ä½ç½®å‘ç”Ÿäº†å˜åŒ–ï¼Œä½†å´éœ€è¦è¿›è¡Œç¹æ‚ä½æ•ˆçš„åˆ é™¤ã€åˆ›å»ºæ“ä½œï¼Œå…¶å®åªè¦å¯¹è¿™äº›èŠ‚ç‚¹è¿›è¡Œä½ç½®ç§»åŠ¨å³å¯ã€‚Reacté’ˆå¯¹è¿™ä¸€ç°è±¡æå‡ºäº†ä¸€ç§ä¼˜åŒ–ç­–ç•¥ï¼š<strong>è®©å¼€å‘è€…å¯¹åŒä¸€å±‚çº§çš„åŒç»„å­èŠ‚ç‚¹ï¼Œæ·»åŠ å”¯ä¸€keyè¿›è¡ŒåŒºåˆ†</strong>ã€‚è™½ç„¶è¿™åªæ˜¯å°å°çš„æ”¹åŠ¨ï¼Œæ€§èƒ½ä¸Šå´å‘ç”Ÿäº†ç¿»å¤©è¦†åœ°çš„å˜åŒ–ï¼Œå†æ¥çœ‹ä¸€ä¸‹åº”ç”¨äº†è¿™ä¸ªç­–ç•¥ä¹‹åï¼Œdiffæ˜¯å¦‚ä½•å¤„ç†çš„</p><p>example:</p><p><img src="https://i.loli.net/2020/05/18/AOauJGyqPtEoHNW.png" alt="image.png" style="zoom: 50%;"></p><p>é€šè¿‡keyå¯ä»¥å‡†ç¡®çš„å‘ç°æ–°æ—§é›†åˆä¸­çš„èŠ‚ç‚¹éƒ½æ˜¯ç›¸åŒçš„èŠ‚ç‚¹ï¼Œå› æ­¤æ— éœ€è¿›è¡ŒèŠ‚ç‚¹åˆ é™¤å’Œåˆ›å»ºï¼Œåªéœ€è¦å°†æ—§é›†åˆä¸­çš„ä½ç½®è¿›è¡Œç§»åŠ¨ï¼Œæ›´æ–°ä¸ºæ–°é›†åˆä¸­èŠ‚ç‚¹çš„ä½ç½®åè¯æ˜¯çš„Reactç»™å‡ºçš„diffç»“æœä¸ºï¼šBã€Dä¸åšä»»ä½•æ“ä½œï¼ŒAã€Cè¿›è¡Œç§»åŠ¨æ“ä½œå°±è¡Œã€‚</p><p>å…·ä½“çš„æµç¨‹çœ‹è¡¨æ ¼ï¼š</p><table><thead><tr><th>index</th><th style="text-align:left">èŠ‚ç‚¹</th><th style="text-align:left">oldIndex</th><th style="text-align:left">lastIndex</th><th style="text-align:left">æ“ä½œ</th></tr></thead><tbody><tr><td>0</td><td style="text-align:left">B</td><td style="text-align:left">1</td><td style="text-align:left">0</td><td style="text-align:left">oldIndex(1)&gt;lastIndex(0),lastIndex=oldIndexï¼ŒlastIndexå˜ä¸º1</td></tr><tr><td>1</td><td style="text-align:left">A</td><td style="text-align:left">0</td><td style="text-align:left">1</td><td style="text-align:left">oldIndex(0)&lt;lastIndex(1),èŠ‚ç‚¹Aç§»åŠ¨è‡³index(1)çš„ä½ç½®</td></tr><tr><td>2</td><td style="text-align:left">D</td><td style="text-align:left">3</td><td style="text-align:left">1</td><td style="text-align:left">oldIndex(3)&gt;lastIndex(1),lastIndex=oldIndexï¼ŒlastIndexå˜ä¸º3</td></tr><tr><td>3</td><td style="text-align:left">C</td><td style="text-align:left">2</td><td style="text-align:left">3</td><td style="text-align:left">oldIndex(2)&lt;lastIndex(3),èŠ‚ç‚¹Cç§»åŠ¨è‡³index(3)çš„ä½ç½®</td></tr></tbody></table><ul><li>indexï¼š æ–°é›†åˆçš„éå†ä¸‹æ ‡ã€‚</li><li>oldIndexï¼šå½“å‰èŠ‚ç‚¹åœ¨è€é›†åˆä¸­çš„ä¸‹æ ‡ã€‚</li><li>lastIndexï¼šåœ¨æ–°é›†åˆè®¿é—®è¿‡çš„èŠ‚ç‚¹ä¸­ï¼Œå…¶åœ¨è€é›†åˆçš„æœ€å¤§ä¸‹æ ‡å€¼(åœ¨è€é›†åˆä¸­æœ€å³çš„ä½ç½®, å³æœ€å¤§çš„ä½ç½®)ã€‚</li></ul><p>æ“ä½œä¸€æ ä¸­åªæ¯”è¾ƒoldIndexå’ŒlastIndexï¼š</p><ul><li><p>å½“oldIndex&gt;lastIndexæ—¶ï¼Œå°†oldIndexçš„å€¼èµ‹å€¼ç»™lastIndex</p></li><li><p>å½“oldIndex=lastIndexæ—¶ï¼Œä¸æ“ä½œ</p></li><li><p>å½“oldIndex&lt;lastIndexæ—¶ï¼Œå°†å½“å‰èŠ‚ç‚¹ç§»åŠ¨åˆ°indexçš„ä½ç½®ï¼Œ</p><p>æ–°ç‰ˆæœ¬Reactï¼Œåº”è¯¥æ˜¯ä»v16èµ·, placeChild(<em>newFiber</em>, <em>lastPlacedIndex</em>, <em>newIndex</em>), <em>lastPlacedIndex</em>å°±æ˜¯å½“å‰çš„æ–°fiberæ•°ç»„ä¸­å·²ç»éå†è¿‡çš„fiberä¸­åœ¨ä¸Šä¸€æ¬¡æ›´æ–°æ—¶çš„indexä¸­æœ€å¤§çš„é‚£ä¸ªï¼Œå°±æ˜¯ä¸Šé¢çš„lastIndex</p></li></ul><p>  <del>è€ç‰ˆæœ¬Reactæºç ä¸­çš„enqueueMove(this, child._mountIndex, toIndex)ï¼Œå…¶ä¸­ toIndex å…¶å®å°±æ˜¯ nextIndex</del></p><p>  <img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gf72uvqaenj30df0fdjtm.jpg" alt="image-20200527161523369"></p><hr><p>ä¸Šé¢ä¾‹å­æ˜¯æ–°æ—§é›†åˆä¸­çš„èŠ‚ç‚¹éƒ½æ˜¯ç›¸åŒçš„èŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼Œé‚£å¦‚æœæ–°é›†åˆä¸­æœ‰æ–°åŠ å…¥çš„èŠ‚ç‚¹ä¸”æ—§é›†åˆå­˜åœ¨ éœ€è¦åˆ é™¤çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆ diff åˆæ˜¯å¦‚ä½•å¯¹æ¯”è¿ä½œçš„</p><p>ABCD â€“&gt; BECA</p><table><thead><tr><th>index</th><th style="text-align:left">èŠ‚ç‚¹</th><th style="text-align:left">oldIndex</th><th style="text-align:left">lastIndex</th><th style="text-align:left">æ“ä½œ</th></tr></thead><tbody><tr><td>0</td><td style="text-align:left">B</td><td style="text-align:left">1</td><td style="text-align:left">0</td><td style="text-align:left">oldIndex(1)&gt;lastIndex(0)ï¼ŒlastIndex=oldIndexï¼ŒlastIndexå˜ä¸º1</td></tr><tr><td>1</td><td style="text-align:left">E</td><td style="text-align:left">-</td><td style="text-align:left">1</td><td style="text-align:left">oldIndexä¸å­˜åœ¨ï¼Œæ·»åŠ èŠ‚ç‚¹Eè‡³index(1)çš„ä½ç½®</td></tr><tr><td>2</td><td style="text-align:left">C</td><td style="text-align:left">2</td><td style="text-align:left">1</td><td style="text-align:left">oldIndex(2)&gt;lastIndex(1),lastIndex=oldIndexï¼ŒlastIndexå˜ä¸º2</td></tr><tr><td>3</td><td style="text-align:left">A</td><td style="text-align:left">0</td><td style="text-align:left">2</td><td style="text-align:left">oldIndex(0)&lt;lastIndex(2),èŠ‚ç‚¹Aç§»åŠ¨è‡³index(3)çš„ä½ç½®</td></tr></tbody></table><blockquote><p>PSï¼šæœ€åè¿˜éœ€è¦å¯¹æ—§é›†åˆè¿›è¡Œå¾ªç¯éå†ï¼Œæ‰¾å‡ºæ–°é›†åˆä¸­æ²¡æœ‰çš„èŠ‚ç‚¹ï¼Œæ­¤æ—¶å‘ç°å­˜åœ¨è¿™æ ·çš„èŠ‚ç‚¹Dï¼Œå› æ­¤åˆ é™¤èŠ‚ç‚¹Dï¼Œåˆ°æ­¤ diff æ“ä½œå…¨éƒ¨å®Œæˆã€‚</p></blockquote><p>åŒæ ·æ“ä½œä¸€æ ä¸­åªæ¯”è¾ƒoldIndexå’ŒlastIndexï¼Œä½†æ˜¯oldIndexå¯èƒ½æœ‰ä¸å­˜åœ¨çš„æƒ…å†µï¼š</p><ul><li>oldIndexå­˜åœ¨<ol><li>å½“oldIndex&gt;lastIndexæ—¶ï¼Œå°†oldIndexçš„å€¼èµ‹å€¼ç»™lastIndex</li><li>å½“oldIndex=lastIndexæ—¶ï¼Œä¸æ“ä½œ</li><li>å½“oldIndex&lt;lastIndexæ—¶ï¼Œå°†å½“å‰èŠ‚ç‚¹ç§»åŠ¨åˆ°indexçš„ä½ç½®</li></ol></li><li><p>oldIndexä¸å­˜åœ¨</p><ol><li>æ–°å¢å½“å‰èŠ‚ç‚¹è‡³indexçš„ä½ç½®</li></ol><p><img src="https://i.loli.net/2020/05/18/r8vweGqTnVLUaic.png" alt="image.png"></p></li></ul><hr><p>å½“ç„¶è¿™ç§diffå¹¶éå®Œç¾æ— ç¼ºçš„ï¼Œæˆ‘ä»¬æ¥çœ‹è¿™ä¹ˆä¸€ç§æƒ…å†µï¼š</p><p><img src="https://i.loli.net/2020/05/18/WI7XbhK84QuJej5.png" alt="image.png"></p><p>å®é™…æˆ‘ä»¬åªéœ€å¯¹Dæ‰§è¡Œç§»åŠ¨æ“ä½œï¼Œç„¶è€Œç”±äºDåœ¨æ—§é›†åˆä¸­çš„ä½ç½®æ˜¯æœ€å¤§çš„ï¼Œå¯¼è‡´å…¶ä»–èŠ‚ç‚¹çš„oldIndex &lt; lastIndexï¼Œé€ æˆDæ²¡æœ‰æ‰§è¡Œç§»åŠ¨æ“ä½œï¼Œè€Œæ˜¯Aã€Bã€Cå…¨éƒ¨ç§»åŠ¨åˆ°DèŠ‚ç‚¹åé¢çš„ç°è±¡ã€‚é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œå®˜æ–¹å»ºè®®ï¼š</p><blockquote><p>åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå°½é‡å‡å°‘ç±»ä¼¼å°†æœ€åä¸€ä¸ªèŠ‚ç‚¹ç§»åŠ¨åˆ°åˆ—è¡¨é¦–éƒ¨çš„æ“ä½œã€‚å½“èŠ‚ç‚¹æ•°é‡è¿‡å¤§æˆ–æ›´æ–°æ“ä½œè¿‡äºé¢‘ç¹æ—¶ï¼Œè¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¼šå½±å“Reactçš„æ¸²æŸ“æ€§èƒ½</p></blockquote><p>ç”±äºkeyçš„å­˜åœ¨ï¼Œreactå¯ä»¥å‡†ç¡®åœ°åˆ¤æ–­å‡ºè¯¥èŠ‚ç‚¹åœ¨æ–°é›†åˆä¸­æ˜¯å¦å­˜åœ¨ï¼Œè¿™æå¤§åœ°æé«˜äº†diffæ•ˆç‡ã€‚æˆ‘ä»¬åœ¨å¼€å‘è¿‡ä¸­è¿›è¡Œåˆ—è¡¨æ¸²æŸ“çš„æ—¶å€™ï¼Œè‹¥æ²¡æœ‰åŠ keyï¼Œreactä¼šæŠ›å‡ºè­¦å‘Šè¦æ±‚å¼€å‘è€…åŠ ä¸Škeyï¼Œå°±æ˜¯ä¸ºäº†æé«˜diffæ•ˆç‡ã€‚</p><p>ä½†æ˜¯åŠ äº†keyä¸€å®šè¦æ¯”æ²¡åŠ keyçš„æ€§èƒ½æ›´é«˜å—ï¼Ÿæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">ç°åœ¨æœ‰ä¸€é›†åˆ[1,2,3,4,5],æ¸²æŸ“æˆå¦‚ä¸‹çš„æ ·å­ï¼š</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>1<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>2<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>3<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>4<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>5<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">---------------</span><br><span class="line">ç°åœ¨æˆ‘ä»¬å°†è¿™ä¸ªé›†åˆçš„é¡ºåºæ‰“ä¹±å˜æˆ[1,3,2,5,4]ã€‚</span><br><span class="line">1.åŠ key</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">'1'</span>&gt;</span>1<span class="tag">&lt;/<span class="name">div</span>&gt;</span>             <span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">'1'</span>&gt;</span>1<span class="tag">&lt;/<span class="name">div</span>&gt;</span>     </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">'2'</span>&gt;</span>2<span class="tag">&lt;/<span class="name">div</span>&gt;</span>             <span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">'3'</span>&gt;</span>3<span class="tag">&lt;/<span class="name">div</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">'3'</span>&gt;</span>3<span class="tag">&lt;/<span class="name">div</span>&gt;</span>  ========&gt;  <span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">'2'</span>&gt;</span>2<span class="tag">&lt;/<span class="name">div</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">'4'</span>&gt;</span>4<span class="tag">&lt;/<span class="name">div</span>&gt;</span>             <span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">'5'</span>&gt;</span>5<span class="tag">&lt;/<span class="name">div</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">'5'</span>&gt;</span>5<span class="tag">&lt;/<span class="name">div</span>&gt;</span>             <span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">'4'</span>&gt;</span>4<span class="tag">&lt;/<span class="name">div</span>&gt;</span>  </span><br><span class="line">æ“ä½œï¼šèŠ‚ç‚¹2ç§»åŠ¨è‡³ä¸‹æ ‡ä¸º2çš„ä½ç½®ï¼ŒèŠ‚ç‚¹4ç§»åŠ¨è‡³ä¸‹æ ‡ä¸º4çš„ä½ç½®ã€‚</span><br><span class="line"></span><br><span class="line">2.ä¸åŠ key</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>1<span class="tag">&lt;/<span class="name">div</span>&gt;</span>             <span class="tag">&lt;<span class="name">div</span>&gt;</span>1<span class="tag">&lt;/<span class="name">div</span>&gt;</span>     </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>2<span class="tag">&lt;/<span class="name">div</span>&gt;</span>             <span class="tag">&lt;<span class="name">div</span>&gt;</span>3<span class="tag">&lt;/<span class="name">div</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>3<span class="tag">&lt;/<span class="name">div</span>&gt;</span>  ========&gt;  <span class="tag">&lt;<span class="name">div</span>&gt;</span>2<span class="tag">&lt;/<span class="name">div</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>4<span class="tag">&lt;/<span class="name">div</span>&gt;</span>             <span class="tag">&lt;<span class="name">div</span>&gt;</span>5<span class="tag">&lt;/<span class="name">div</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>5<span class="tag">&lt;/<span class="name">div</span>&gt;</span>             <span class="tag">&lt;<span class="name">div</span>&gt;</span>4<span class="tag">&lt;/<span class="name">div</span>&gt;</span>  </span><br><span class="line">æ“ä½œï¼šä¿®æ”¹ç¬¬1ä¸ªåˆ°ç¬¬5ä¸ªèŠ‚ç‚¹çš„innerText</span><br><span class="line">---------------</span><br><span class="line">å¦‚æœæˆ‘ä»¬å¯¹è¿™ä¸ªé›†åˆè¿›è¡Œå¢åˆ çš„æ“ä½œæ”¹æˆ[1,3,2,5,6]ã€‚</span><br><span class="line">1.åŠ key</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">'1'</span>&gt;</span>1<span class="tag">&lt;/<span class="name">div</span>&gt;</span>             <span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">'1'</span>&gt;</span>1<span class="tag">&lt;/<span class="name">div</span>&gt;</span>     </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">'2'</span>&gt;</span>2<span class="tag">&lt;/<span class="name">div</span>&gt;</span>             <span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">'3'</span>&gt;</span>3<span class="tag">&lt;/<span class="name">div</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">'3'</span>&gt;</span>3<span class="tag">&lt;/<span class="name">div</span>&gt;</span>  ========&gt;  <span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">'2'</span>&gt;</span>2<span class="tag">&lt;/<span class="name">div</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">'4'</span>&gt;</span>4<span class="tag">&lt;/<span class="name">div</span>&gt;</span>             <span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">'5'</span>&gt;</span>5<span class="tag">&lt;/<span class="name">div</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">'5'</span>&gt;</span>5<span class="tag">&lt;/<span class="name">div</span>&gt;</span>             <span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">'6'</span>&gt;</span>6<span class="tag">&lt;/<span class="name">div</span>&gt;</span>  </span><br><span class="line">æ“ä½œï¼šèŠ‚ç‚¹2ç§»åŠ¨è‡³ä¸‹æ ‡ä¸º2çš„ä½ç½®ï¼Œæ–°å¢èŠ‚ç‚¹6è‡³ä¸‹æ ‡ä¸º4çš„ä½ç½®ï¼Œåˆ é™¤èŠ‚ç‚¹4ã€‚</span><br><span class="line"></span><br><span class="line">2.ä¸åŠ key</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>1<span class="tag">&lt;/<span class="name">div</span>&gt;</span>             <span class="tag">&lt;<span class="name">div</span>&gt;</span>1<span class="tag">&lt;/<span class="name">div</span>&gt;</span>     </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>2<span class="tag">&lt;/<span class="name">div</span>&gt;</span>             <span class="tag">&lt;<span class="name">div</span>&gt;</span>3<span class="tag">&lt;/<span class="name">div</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>3<span class="tag">&lt;/<span class="name">div</span>&gt;</span>  ========&gt;  <span class="tag">&lt;<span class="name">div</span>&gt;</span>2<span class="tag">&lt;/<span class="name">div</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>4<span class="tag">&lt;/<span class="name">div</span>&gt;</span>             <span class="tag">&lt;<span class="name">div</span>&gt;</span>5<span class="tag">&lt;/<span class="name">div</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>5<span class="tag">&lt;/<span class="name">div</span>&gt;</span>             <span class="tag">&lt;<span class="name">div</span>&gt;</span>6<span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span><br><span class="line">æ“ä½œï¼šä¿®æ”¹ç¬¬1ä¸ªåˆ°ç¬¬5ä¸ªèŠ‚ç‚¹çš„innerText</span><br><span class="line">---------------</span><br><span class="line">é€šè¿‡ä¸Šé¢è¿™ä¸¤ä¸ªä¾‹å­æˆ‘ä»¬å‘ç°ï¼š</span><br><span class="line">ç”±äºdomèŠ‚ç‚¹çš„ç§»åŠ¨æ“ä½œå¼€é”€æ˜¯æ¯”è¾ƒæ˜‚è´µçš„ï¼Œæ²¡æœ‰keyçš„æƒ…å†µä¸‹è¦æ¯”æœ‰keyçš„æ€§èƒ½æ›´å¥½ã€‚</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å‘ç°ï¼Œè™½ç„¶åŠ äº†keyæé«˜äº†diffæ•ˆç‡ï¼Œä½†æ˜¯æœªå¿…ä¸€å®šæå‡äº†é¡µé¢çš„æ€§èƒ½ã€‚å› æ­¤æˆ‘ä»¬è¦æ³¨æ„è¿™ä¹ˆä¸€ç‚¹ï¼š</p><blockquote><p>å¯¹äºç®€å•åˆ—è¡¨é¡µæ¸²æŸ“æ¥è¯´ï¼Œä¸åŠ keyè¦æ¯”åŠ äº†keyçš„æ€§èƒ½æ›´å¥½</p></blockquote><p>æ ¹æ®ä¸Šé¢çš„æƒ…å†µï¼Œæœ€åæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹keyçš„ä½œç”¨ï¼š</p><ul><li>å‡†ç¡®åˆ¤æ–­å‡ºå½“å‰èŠ‚ç‚¹æ˜¯å¦åœ¨æ—§é›†åˆä¸­</li><li>æå¤§åœ°å‡å°‘éå†æ¬¡æ•°</li></ul><h2 id="æ¸²æŸ“"><a href="#æ¸²æŸ“" class="headerlink" title="æ¸²æŸ“"></a>æ¸²æŸ“</h2><h4 id="åˆå¹¶æ“ä½œ"><a href="#åˆå¹¶æ“ä½œ" class="headerlink" title="åˆå¹¶æ“ä½œ"></a>åˆå¹¶æ“ä½œ</h4><p>å½“è°ƒç”¨componentçš„<code>setstate</code>æ—¶ï¼ŒReactä¼šå°†å…¶æ ‡è®°ä¸ºdirtyã€‚åˆ°æ¯ä¸ªæ—¶é—´å¾ªç¯ç»“æŸï¼ŒReactæ£€æŸ¥æ‰€æœ‰æ ‡è®°dirtyçš„componenté‡æ–°ç»˜åˆ¶</p><p>è¿™é‡Œçš„â€œåˆå¹¶æ“ä½œâ€æ˜¯è¯´ï¼Œåœ¨ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­ï¼ŒDOMåªä¼šè¢«æ›´æ–°ä¸€æ¬¡ï¼Œè¿™ä¸ªç‰¹æ€§æ˜¯æ„å»ºé«˜æ€§èƒ½åº”ç”¨çš„å…³é”®ã€‚</p><p> <img src="https://i.loli.net/2020/05/14/b4J7ntmFZLOlaAK.png" alt=""></p><h4 id="å­æ ‘æ¸²æŸ“"><a href="#å­æ ‘æ¸²æŸ“" class="headerlink" title="å­æ ‘æ¸²æŸ“"></a>å­æ ‘æ¸²æŸ“</h4><p>è°ƒç”¨setStateæ–¹æ³•æ—¶ï¼Œcomponentä¼šé‡æ–°æ„å»ºåŒ…æ‹¬å­æ ‘å­èŠ‚ç‚¹çš„virtual DOM ã€‚å¦‚æœä½ åœ¨æ ¹èŠ‚ç‚¹è°ƒç”¨<code>setState</code>,æ•´ä¸ªReactåº”ç”¨éƒ½ä¼šè¢«é‡æ–°æ¸²æŸ“ã€‚æ‰€æœ‰çš„componentï¼Œå³ä¾¿æ²¡æœ‰æ›´æ–°ï¼Œéƒ½ä¼šè°ƒç”¨ä»–ä»¬çš„renderæ–¹æ³•ï¼Œè¿™ä¸ªå¬èµ·æ¥å¾ˆå¯æ€•ï¼Œæ€§èƒ½å®é™…ä¸Šå¾ˆä½ï¼Œä½†å®é™…ä¸Šæˆ‘ä»¬ä¸ä¼šè§¦åŠçœŸå®çš„DOMï¼Œè¿è¡Œèµ·æ¥å°±æ²¡é—®é¢˜ã€‚</p><p>åœ¨å†™reactä»£ç æ—¶ï¼Œæ¯å½“æ•°æ®æœ‰æ›´æ–°ï¼Œä½ éƒ½ä¸ä¼šç®—è°ƒç”¨æ ¹èŠ‚ç‚¹çš„<code>setState</code>ã€‚ä½ ä¼šåœ¨éœ€è¦æ¥æ”¶å¯¹åº”çš„componentä¸Šè°ƒç”¨ï¼Œæˆ–è€…åœ¨ä¸Šé¢çš„å‡ ä¸ªcomponentã€‚ä½ å¾ˆå°‘è¦ä¸€ç›´åˆ°æ ¹èŠ‚ç‚¹ã€‚å°±æ˜¯è¯´é¡µé¢æ›´æ–°åªå‡ºç°åœ¨ç”¨æˆ·äº¤äº’çš„éƒ¨åˆ†ã€‚</p><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1geqli50hv8j30b005uweh.jpg" alt="img"></p><h4 id="é€‰æ‹©å­æ ‘æ¸²æŸ“"><a href="#é€‰æ‹©å­æ ‘æ¸²æŸ“" class="headerlink" title="é€‰æ‹©å­æ ‘æ¸²æŸ“"></a>é€‰æ‹©å­æ ‘æ¸²æŸ“</h4><p>å»æ‰ä¸€äº›å­æ ‘çš„é‡æ–°æ¸²æŸ“.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">boolean</span> shouldComponentUpdate(object nextProps, object nextState)</span><br></pre></td></tr></table></figure><p>æ ¹æ®componentçš„å‰ä¸€ä¸ªå’Œä¸‹ä¸€ä¸ª<code>props/state</code>ï¼Œ ä½ å¯ä»¥å‘Šè¯‰Reactè¿™ä¸ªcomponentæ²¡æœ‰æ›´æ–°ï¼Œä¹Ÿä¸éœ€è¦é‡ç»˜</p><blockquote><p>æ³¨æ„, è¿™ä¸ªå‡½æ•°æ¯æ¬¡éƒ½ä¼šè¢«è°ƒç”¨, æ‰€ä»¥ä½ è¦ç¡®ä¿è¿è¡Œèµ·æ¥èŠ±çš„æ—¶é—´æ›´å°‘,<br>æ¯” React çš„åšæ³•æ—¶é—´å°‘, è¿˜æœ‰æ¯”è®¡ç®— component éœ€è¦çš„æ—¶é—´å°‘,<br>å³ä¾¿é‡æ–°ç»˜åˆ¶å¹¶ä¸æ˜¯å¿…è¦çš„.</p><p>Ps: ä¸è¿‡æœ‰å¯èƒ½ä½ çš„æ–¹æ³•é‡Œå†™çš„æ¯”ReactèŠ±è´¹çš„æ—¶é—´æ›´å¤š</p></blockquote><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1geqliamkyej30az05kglm.jpg" alt="img"></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul><li><p>Reactçš„é«˜æ•ˆå¾—ç›ŠäºVIrtual DOM + React diffçš„ä½“ç³»ã€‚diffç®—æ³•å¹¶éReactç‹¬åˆ›ï¼Œreactåªæ˜¯åœ¨ä¼ ç»Ÿçš„diffç®—æ³•ä¸­åšäº†ä¼˜åŒ–ã€‚ä½†å› ä¸ºä¼˜åŒ–ï¼Œå°†diffç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ä¸€ä¸‹ä»O(n^3) é™åˆ°äº† O(n)ã€‚</p></li><li><p>å¼€å‘ç»„ä»¶æ—¶ï¼Œä¿æŒç¨³å®šçš„domç»“æ„ä¼šæœ‰åŠ©äºæ€§èƒ½çš„æå‡ã€‚</p></li><li><p>å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå°½é‡å‡å°‘ç±»ä¼¼å°†æœ€åä¸€ä¸ªèŠ‚ç‚¹ç§»åŠ¨åˆ°åˆ—è¡¨é¦–éƒ¨çš„æ“ä½œã€‚</p></li><li><p>keyçš„å­˜åœ¨æ˜¯ä¸ºäº†æå‡diffæ•ˆç‡ï¼Œä½†æœªå¿…ä¸€å®šå°±å¯ä»¥æå‡æ€§èƒ½ï¼Œè®°ä½ç®€å•åˆ—è¡¨æ¸²æŸ“æƒ…å†µä¸‹ï¼Œä¸åŠ keyè¦æ¯”åŠ keyçš„æ€§èƒ½æ›´å¥½ã€‚ï¼ˆä¸è¿‡å¯èƒ½å› ä¸ºReact consoleçš„æé†’ï¼Œå¤§å®¶éƒ½ä¼šåŠ ä¸Šï¼Œä¸ªäººè§‰å¾—è¿™ç‚¹æ€§èƒ½é—®é¢˜ä¸å¤§ï¼‰ã€‚</p></li><li><p>æˆ‘ä»¬å¯ä»¥æ ¹æ®diffçš„ç‰¹ç‚¹ï¼Œåœ¨å…·ä½“åœºæ™¯ä¸­å–é•¿è¡¥çŸ­ï¼Œè§„é¿ä¸€äº›ç®—æ³•ä¸Šé¢çš„çŸ­æ¿ä¹Ÿæ˜¯æœ‰åˆ©äºæå‡åº”ç”¨æ•´ä½“çš„æ€§èƒ½ã€‚</p></li></ul><p>ä¹‹åå¯ä»¥ç®€å•å®ç°ä¸‹diff</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/sexy_squirrel/java/article/details/79801940" target="_blank" rel="noopener">æµ…è°ˆReactä¸­çš„diff</a></p><p><a href="https://www.zhihu.com/question/66851503/answer/246766239" target="_blank" rel="noopener">reactçš„diff ä»O(n^3)åˆ° O(n) ï¼Œè¯·é—® O(n^3) å’ŒO(n) æ˜¯æ€ä¹ˆç®—å‡ºæ¥ï¼Ÿ</a></p><p><a href="https://zhuanlan.zhihu.com/p/20346379?refer=purerender" target="_blank" rel="noopener">React æºç å‰–æç³»åˆ— ï¼ ä¸å¯æ€è®®çš„ react diff</a></p><p><a href="https://juejin.im/post/5cb5b4926fb9a068b52fb823" target="_blank" rel="noopener">React diffåŸç†æ¢ç©¶ä»¥åŠåº”ç”¨å®è·µ</a></p><p><a href="https://juejin.im/post/5cb5b4926fb9a068b52fb823" target="_blank" rel="noopener">React Fiber åŸç†ä»‹ç»</a></p>]]></content>
    
    <summary type="html">
    
      React çš„ä¸¤å¤§ç‰¹è‰²ï¼šReact diff å’Œ Virtual Domã€‚React ä¸­æœ€å€¼å¾—ç§°é“çš„éƒ¨åˆ†è«è¿‡äº Virtual DOM ä¸ diff çš„å®Œç¾ç»“åˆï¼Œç‰¹åˆ«æ˜¯å…¶é«˜æ•ˆçš„ diff ç®—æ³•ï¼Œè®©ç”¨æˆ·å¯ä»¥æ— éœ€é¡¾å¿Œæ€§èƒ½é—®é¢˜è€Œâ€ä»»æ€§è‡ªç”±â€çš„åˆ·æ–°é¡µé¢ï¼Œè®©å¼€å‘è€…ä¹Ÿå¯ä»¥æ— éœ€å…³å¿ƒ Virtual DOM èƒŒåçš„è¿ä½œåŸç†ï¼Œå› ä¸º React diff ä¼šå¸®åŠ©æˆ‘ä»¬è®¡ç®—å‡º Virtual DOM ä¸­çœŸæ­£å˜åŒ–çš„éƒ¨åˆ†ï¼Œå¹¶åªé’ˆå¯¹è¯¥éƒ¨åˆ†è¿›è¡Œå®é™… DOM æ“ä½œï¼Œè€Œéé‡æ–°æ¸²æŸ“æ•´ä¸ªé¡µé¢ï¼Œä»è€Œä¿è¯äº†æ¯æ¬¡æ“ä½œæ›´æ–°åé¡µé¢çš„é«˜æ•ˆæ¸²æŸ“ï¼Œå› æ­¤ Virtual DOM ä¸ diff æ˜¯ä¿è¯ React æ€§èƒ½å£ç¢‘çš„å¹•åæ¨æ‰‹ã€‚
    
    </summary>
    
      <category term="é»˜è®¤åˆ†ç±»" scheme="https://kitions.github.io/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/"/>
    
    
      <category term="React" scheme="https://kitions.github.io/tags/React/"/>
    
      <category term="diff" scheme="https://kitions.github.io/tags/diff/"/>
    
  </entry>
  
  <entry>
    <title>ç½‘æ˜“äº‘æ­Œå•è½¬ç§»åˆ°Apple Musicã€Spotifyç­‰æµéŸ³ä¹å¹³å°</title>
    <link href="https://kitions.github.io/2020/04/30/%E7%BD%91%E6%98%93%E4%BA%91%E8%BD%AC%E5%87%BA%E6%AD%8C%E5%8D%95/"/>
    <id>https://kitions.github.io/2020/04/30/ç½‘æ˜“äº‘è½¬å‡ºæ­Œå•/</id>
    <published>2020-04-30T02:13:33.000Z</published>
    <updated>2020-04-30T02:13:35.895Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç½‘æ˜“äº‘æ­Œå•è½¬ç§»åˆ°Apple-Musicã€Spotifyç­‰æµéŸ³ä¹å¹³å°"><a href="#ç½‘æ˜“äº‘æ­Œå•è½¬ç§»åˆ°Apple-Musicã€Spotifyç­‰æµéŸ³ä¹å¹³å°" class="headerlink" title="ç½‘æ˜“äº‘æ­Œå•è½¬ç§»åˆ°Apple Musicã€Spotifyç­‰æµéŸ³ä¹å¹³å°"></a>ç½‘æ˜“äº‘æ­Œå•è½¬ç§»åˆ°Apple Musicã€Spotifyç­‰æµéŸ³ä¹å¹³å°</h1><p>çº¯å¬æ­Œï¼Œè€Œä¸”ä¸»åŠ›æ˜¯åœ¨iOSç«¯å’ŒMACç«¯çš„ï¼ŒApple Musicå¯èƒ½æ˜¯æœ€niceçš„ã€‚</p><p>ç³»ç»Ÿçº§çš„åº”ç”¨ä½“éªŒï¼Œç•Œé¢ç®€æ´ã€‚ä½†å¤ªè¿‡äºç®€æ´ï¼Œå¯¼è‡´å¾ˆå¤šäººå—¤ä¹‹ä»¥é¼»ï¼Œæ¬§ç¾æ›²åº“å¯¹æ¯”å›½å†…éŸ³ä¹åº”ç”¨ç®—æ˜¯æœ€é½çš„ï¼Œåè¯­è¿˜è¡Œå§ï¼Œä½†ç½‘æ˜“éŸ³ä¹äººï¼Œå°ä¼—æ°‘è°£æ­Œæ‰‹çš„æ›²åº“åº”è¯¥å¾ˆä¸å…¨ï¼Œæ–°æ­Œä¸Šæ¶é€Ÿåº¦æŒºå¿«çš„ã€‚éŸ³è´¨æ¯”qqéŸ³ä¹ï¼Œç½‘æ˜“äº‘å¥½å¾ˆå¤šã€‚ä½ èŠ±é’±ç›¸å½“äºä¹°æ–­ï¼Œæ–°ä¸“è¾‘éƒ½ä¸æ”¶è´¹ï¼Œåƒç½‘æ˜“ï¼Œè…¾è®¯ï¼Œå°½ç®¡ä½ å……äº†ä¼šå‘˜ï¼Œæ­Œæ‰‹å‡ºæ–°ä¸“è¾‘æ—¶ï¼Œç…§æ ·æ•°å­—ä¸“è¾‘æ˜¯å•ç‹¬æ”¶è´¹ã€‚</p><p>ä»·æ ¼ï¼š æ•™è‚²ä¼˜æƒ ç››æƒ 5å…ƒ/æœˆï¼Œä¸ªäººç”¨æˆ·10å…ƒ/æœˆï¼Œå®¶åº­ç»„15å…ƒ/æœˆã€‚è¿™ä¹ˆä¾¿å®œçš„ä»·æ ¼æ‹¥æœ‰è¿™ä¹ˆåºå¤§çš„æ›²åº“çœŸçš„å¾ˆå®æƒ äº†ã€‚é‰´äºå¤§å®¶éƒ½qiongï¼Œä½ å¯ä»¥å»æŸå®æœä¸ªApple musicæ•™è‚²ä¼˜æƒ é‚®ç®±ï¼Œ5å—é’±ï¼Œä½ ä»¥å5å…ƒ/æœˆã€‚ ä¸è¿‡10å—ä¹Ÿä¸è´µï¼Œä½ åŠ ä¸Šå®¶äººå¼€ä¸ªå®¶åº­ç»„ï¼Œä¹Ÿå¾ˆä¾¿å®œï¼Œå®¶åº­ç»„æœ€å¤š6ä¸ªidï¼Œç›¸å½“äºæ¯äººæ¯æœˆä¸¤å—äº”</p><p>ç¼ºç‚¹å°±æ˜¯æ²¡æœ‰æ­Œæ›²è¯„è®ºå’Œç¤¾äº¤åŠŸèƒ½ï¼Œè¿‡äºç®€æ´ã€‚</p><h3 id="1-ç™»å½•ä½ çš„ç½‘æ˜“äº‘è´¦å·"><a href="#1-ç™»å½•ä½ çš„ç½‘æ˜“äº‘è´¦å·" class="headerlink" title="1. ç™»å½•ä½ çš„ç½‘æ˜“äº‘è´¦å·"></a>1. ç™»å½•ä½ çš„<a href="https://music.163.com/" target="_blank" rel="noopener">ç½‘æ˜“äº‘</a>è´¦å·</h3><p>   <img src="https://s1.ax1x.com/2020/04/30/JHXTVf.png" alt="JHXTVf.png"></p><h3 id="2-è¿›å…¥ä¸ªäººä¸­å¿ƒï¼Œé€‰æ‹©ä½ æƒ³è¦è½¬ç§»çš„æ­Œå•"><a href="#2-è¿›å…¥ä¸ªäººä¸­å¿ƒï¼Œé€‰æ‹©ä½ æƒ³è¦è½¬ç§»çš„æ­Œå•" class="headerlink" title="2. è¿›å…¥ä¸ªäººä¸­å¿ƒï¼Œé€‰æ‹©ä½ æƒ³è¦è½¬ç§»çš„æ­Œå•"></a>2. è¿›å…¥ä¸ªäººä¸­å¿ƒï¼Œé€‰æ‹©ä½ æƒ³è¦è½¬ç§»çš„æ­Œå•</h3><p>   <a href="https://imgchr.com/i/JHjpZV" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/04/30/JHjpZV.png" alt="JHjpZV.png"></a></p><h3 id="3-å³é”®æ£€æŸ¥è¿›å…¥å¼€å‘è€…å·¥å…·ï¼Œåœ¨consoleé‡Œå¤åˆ¶è¿™æ®µä»£ç å›è½¦"><a href="#3-å³é”®æ£€æŸ¥è¿›å…¥å¼€å‘è€…å·¥å…·ï¼Œåœ¨consoleé‡Œå¤åˆ¶è¿™æ®µä»£ç å›è½¦" class="headerlink" title="3. å³é”®æ£€æŸ¥è¿›å…¥å¼€å‘è€…å·¥å…·ï¼Œåœ¨consoleé‡Œå¤åˆ¶è¿™æ®µä»£ç å›è½¦"></a>3. å³é”®æ£€æŸ¥è¿›å…¥å¼€å‘è€…å·¥å…·ï¼Œåœ¨consoleé‡Œå¤åˆ¶è¿™æ®µä»£ç å›è½¦</h3><blockquote><p>å…¶å®å°±æ˜¯å¾ˆç®€å•çš„é€‰ä¸­è¡¨æ ¼ä¸­çš„æ­Œåå­—æ®µ å’Œä½œè€…å­—æ®µ æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œ<code>ä½œè€…-æ­Œå</code>çš„å½¢å¼ï¼Œå¤„ç†æˆè¿™ä¸ª<a href="https://www.tunemymusic.comç½‘ç«™éœ€è¦çš„æ•°æ®" target="_blank" rel="noopener">https://www.tunemymusic.comç½‘ç«™éœ€è¦çš„æ•°æ®</a></p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">"SCRIPT"</span>);</span><br><span class="line">    script.src = <span class="string">'https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js'</span>;</span><br><span class="line">    script.type = <span class="string">'text/javascript'</span>;</span><br><span class="line">    <span class="built_in">document</span>.getElementsByTagName(<span class="string">"head"</span>)[<span class="number">0</span>].appendChild(script);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> checkReady = <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">window</span>.jQuery) &#123;</span><br><span class="line">            callback(jQuery);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">window</span>.setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                checkReady(callback);</span><br><span class="line">            &#125;, <span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    checkReady(<span class="function"><span class="keyword">function</span> (<span class="params">$</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> text = <span class="string">""</span>;</span><br><span class="line">        $(<span class="built_in">window</span>.contentFrame.document).find(<span class="string">'#m-playlist .m-table tbody tr'</span>).each(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            text += ($(<span class="keyword">this</span>).children(<span class="string">'td:eq(3)'</span>).children(<span class="string">'div'</span>).attr(<span class="string">'title'</span>) + <span class="string">" - "</span> + $(<span class="keyword">this</span>).find(<span class="string">"b"</span>).attr(<span class="string">"title"</span>) + <span class="string">"&lt;br/&gt;"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        $(<span class="built_in">window</span>.contentFrame.document).find(<span class="string">'body'</span>).append(<span class="string">"&lt;p&gt;"</span> + text + <span class="string">"&lt;/p&gt;"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure><p>è¾“å‡ºåœ¨äº†é¡µé¢å°±æ˜¯è¿™æ ·</p><p><a href="https://imgchr.com/i/JHvNc9" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/04/30/JHvNc9.png" alt="JHvNc9.png"></a></p><h3 id="4-æ‰“å¼€å’±ä»¬-æœ€å…³é”®çš„-TuneMyMusic-https-www-tunemymusic-com-ï¼Œä¹Ÿä¸ç”¨ç™»å½•ï¼Œä¹Ÿä¸ç”¨æ³¨å†Œ"><a href="#4-æ‰“å¼€å’±ä»¬-æœ€å…³é”®çš„-TuneMyMusic-https-www-tunemymusic-com-ï¼Œä¹Ÿä¸ç”¨ç™»å½•ï¼Œä¹Ÿä¸ç”¨æ³¨å†Œ" class="headerlink" title="4. æ‰“å¼€å’±ä»¬ æœ€å…³é”®çš„[TuneMyMusic][https://www.tunemymusic.com/]ï¼Œä¹Ÿä¸ç”¨ç™»å½•ï¼Œä¹Ÿä¸ç”¨æ³¨å†Œ"></a>4. æ‰“å¼€å’±ä»¬ æœ€å…³é”®çš„[TuneMyMusic][<a href="https://www.tunemymusic.com/]ï¼Œä¹Ÿä¸ç”¨ç™»å½•ï¼Œä¹Ÿä¸ç”¨æ³¨å†Œ" target="_blank" rel="noopener">https://www.tunemymusic.com/]ï¼Œä¹Ÿä¸ç”¨ç™»å½•ï¼Œä¹Ÿä¸ç”¨æ³¨å†Œ</a></h3><blockquote><p>åœ¨ä¸åŒçš„éŸ³ä¹æœåŠ¡å¹³å°ä¹‹é—´ä¼ é€æ’­æ”¾åˆ—è¡¨<br>å°†æ‚¨åœ¨ä»»æ„éŸ³ä¹æœåŠ¡å¹³å°å†…çš„éŸ³ä¹åº“ä¼ é€åˆ°æ‚¨æƒ³è¦çš„ä»»ä½•å…¶ä»–å¹³å°ï¼æ”¯æŒSpotify, TIDAL, Apple Music, YouTubeç­‰ç­‰</p></blockquote><p>   <a href="https://imgchr.com/i/JHvrtO" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/04/30/JHvrtO.md.png" alt="JHvrtO.md.png"></a></p><h4 id="4-1-å¯¼å…¥æ–¹å¼"><a href="#4-1-å¯¼å…¥æ–¹å¼" class="headerlink" title="4.1 å¯¼å…¥æ–¹å¼"></a>4.1 å¯¼å…¥æ–¹å¼</h4><p>é€‰æ‹©ä»æ–‡æœ¬ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥ä»å…¶ä»–å¹³å°å¯¼å…¥<img src="https://s1.ax1x.com/2020/04/30/JHxeUK.png" alt="JHxeUK.png"></p><h4 id="4-2-å¤åˆ¶"><a href="#4-2-å¤åˆ¶" class="headerlink" title="4.2 å¤åˆ¶"></a>4.2 å¤åˆ¶</h4><p>åˆšåˆšç½‘æ˜“äº‘é‚£å„¿å¤åˆ¶çš„æ­Œæ‰‹-æ­Œåä¸€å¤§é•¿ä¸²å¤åˆ¶è¿›å»</p><p><img src="https://s1.ax1x.com/2020/04/30/JHx4M9.png" alt="JHx4M9.png"></p><h4 id="4-3-é€‰æ‹©å¯¼å…¥çš„å¹³å°"><a href="#4-3-é€‰æ‹©å¯¼å…¥çš„å¹³å°" class="headerlink" title="4.3  é€‰æ‹©å¯¼å…¥çš„å¹³å°"></a>4.3  é€‰æ‹©å¯¼å…¥çš„å¹³å°</h4><p>å’±ä»¬è¿™å„¿é€‰æ‹©Apple musicï¼Œç„¶åä¼šè·³å‡ºä¸€ä¸ªç™»å½•çš„æ¡†ï¼Œä½ ç™»å½•å</p><p><img src="https://s1.ax1x.com/2020/04/30/JHzKoV.png" alt="JHzKoV.png"></p><h4 id="4-4-ç­‰å¾…å¯¼å…¥"><a href="#4-4-ç­‰å¾…å¯¼å…¥" class="headerlink" title="4.4  ç­‰å¾…å¯¼å…¥"></a>4.4  ç­‰å¾…å¯¼å…¥</h4><p>å“ªé¦–æˆåŠŸï¼Œå“ªé¦–å¤±è´¥éƒ½ä¼šæ˜¾ç¤ºå‡ºæ¥ï¼ŒApple Musicå°éŸ³ä¹äººçš„æ›²åº“è¾ƒå°‘ï¼Œæ¬§ç¾æ­Œæ‰‹çš„æ­Œè¾ƒå…¨ï¼Œæ‰€ä»¥å¯èƒ½ä½ çš„æ­Œå•æœ‰ä¸€åŠä¼šä¸æˆåŠŸã€‚</p><p><img src="https://s1.ax1x.com/2020/04/30/JHz2wt.png" alt="JHz2wt.png"></p><h3 id="5-æˆåŠŸåˆšåˆšå¯¼å…¥çš„ã€‚"><a href="#5-æˆåŠŸåˆšåˆšå¯¼å…¥çš„ã€‚" class="headerlink" title="5. æˆåŠŸåˆšåˆšå¯¼å…¥çš„ã€‚"></a>5. æˆåŠŸåˆšåˆšå¯¼å…¥çš„ã€‚</h3><p><img src="https://s1.ax1x.com/2020/04/30/JbSuXd.png" alt="JbSuXd.png"></p>]]></content>
    
    <summary type="html">
    
      çº¯å¬æ­Œï¼Œè€Œä¸”ä¸»åŠ›æ˜¯åœ¨iOSç«¯å’ŒMACç«¯çš„ï¼ŒApple Musicå¯èƒ½æ˜¯æœ€niceçš„ã€‚åˆ©ç”¨TuneMyMusicç½‘ç«™è½¬ç§»æ­Œå•
    
    </summary>
    
      <category term="é»˜è®¤åˆ†ç±»" scheme="https://kitions.github.io/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/"/>
    
    
  </entry>
  
  <entry>
    <title>Angularä¸­çš„è‡ªå®šä¹‰è¡¨å•æ§ä»¶ControlValueAccessor</title>
    <link href="https://kitions.github.io/2020/04/02/Angular%E4%B8%AD%E7%9A%84%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A1%A8%E5%8D%95%E6%8E%A7%E4%BB%B6ControlValueAccessor/"/>
    <id>https://kitions.github.io/2020/04/02/Angularä¸­çš„è‡ªå®šä¹‰è¡¨å•æ§ä»¶ControlValueAccessor/</id>
    <published>2020-04-02T09:52:16.000Z</published>
    <updated>2020-04-07T02:02:39.036Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Angularä¸­çš„è‡ªå®šä¹‰è¡¨å•æ§ä»¶ControlValueAccessor"><a href="#Angularä¸­çš„è‡ªå®šä¹‰è¡¨å•æ§ä»¶ControlValueAccessor" class="headerlink" title="Angularä¸­çš„è‡ªå®šä¹‰è¡¨å•æ§ä»¶ControlValueAccessor"></a>Angularä¸­çš„è‡ªå®šä¹‰è¡¨å•æ§ä»¶ControlValueAccessor</h1><p>è¿™ä¸ªæ˜¯ä¸ªè¾ƒä¸ºç®€å•çš„ç†è§£</p><p> ControlValueAccessor acts as a bridge between the Angular forms API and a native element in the DOM.</p><p>ä½œç”¨ï¼š</p><ul><li>æŠŠ form æ¨¡å‹ä¸­å€¼æ˜ å°„åˆ°è§†å›¾ä¸­</li><li>å½“è§†å›¾å‘ç”Ÿå˜åŒ–æ—¶ï¼Œé€šçŸ¥ form directives æˆ– form controls</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> ControlValueAccessor &#123;</span><br><span class="line">  writeValue(obj: <span class="built_in">any</span>): <span class="built_in">void</span></span><br><span class="line">  registerOnChange(fn: <span class="built_in">any</span>): <span class="built_in">void</span></span><br><span class="line">  registerOnTouched(fn: <span class="built_in">any</span>): <span class="built_in">void</span></span><br><span class="line">  setDisabledState(isDisabled: <span class="built_in">boolean</span>)?: <span class="built_in">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>writeValue(obj: any)ï¼šè¯¥æ–¹æ³•ç”¨äºå°†æ¨¡å‹ä¸­çš„æ–°å€¼å†™å…¥è§†å›¾æˆ– DOM å±æ€§ä¸­ï¼Œå³model-&gt;view</li><li>registerOnChange(fn: any)ï¼šè®¾ç½®å½“æ§ä»¶æ¥æ”¶åˆ° change äº‹ä»¶åï¼Œè°ƒç”¨çš„å‡½æ•°ï¼Œå¯ä»¥ç”¨æ¥é€šçŸ¥å¤–éƒ¨ï¼Œç»„ä»¶å·²ç»å‘ç”Ÿå˜åŒ–ï¼Œå³view-&gt;model</li><li>registerOnTouched(fn: any)ï¼šè®¾ç½®å½“æ§ä»¶æ¥æ”¶åˆ° touched äº‹ä»¶åï¼Œè°ƒç”¨çš„å‡½æ•°</li><li>setDisabledState?(isDisabled: boolean)ï¼šå½“æ§ä»¶çŠ¶æ€å˜æˆ DISABLED æˆ–ä» DISABLED çŠ¶æ€å˜åŒ–æˆ ENABLE çŠ¶æ€æ—¶ï¼Œä¼šè°ƒç”¨è¯¥å‡½æ•°ã€‚è¯¥å‡½æ•°ä¼šæ ¹æ®å‚æ•°å€¼ï¼Œå¯ç”¨æˆ–ç¦ç”¨æŒ‡å®šçš„ DOM å…ƒç´ ã€‚</li></ul><p>ä»»ä½•ä¸€ä¸ªç»„ä»¶æˆ–æŒ‡ä»¤éƒ½å¯ä»¥é€šè¿‡å®ç° <code>ControlValueAccessor</code> æ¥å£å¹¶æ³¨å†Œä¸º <code>NG_VALUE_ACCESSOR</code>ï¼Œä»è€Œè½¬å˜æˆ <code>ControlValueAccessor</code> ç±»å‹çš„å¯¹è±¡</p><p><code>registerOnChange</code> æ–¹æ³•æ¥æ³¨å†Œç”±æ¯æ¬¡åŸç”Ÿè¡¨å•æ§ä»¶å€¼æ›´æ–°æ—¶è§¦å‘çš„å›è°ƒå‡½æ•°</p><p>Example:</p><p>å­ç»„ä»¶</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">    selector: <span class="string">'app-demo'</span>,</span><br><span class="line">    templateUrl: <span class="string">'./demo.component.html'</span>,</span><br><span class="line">    styleUrls: [<span class="string">'./demo.component.css'</span>],</span><br><span class="line">    providers: [</span><br><span class="line">        &#123;</span><br><span class="line">            provide: NG_VALUE_ACCESSOR,</span><br><span class="line">            useExisting: DemoComponent,</span><br><span class="line">            multi: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        DemoService</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> DemoComponent <span class="keyword">implements</span> ControlValueAccessor, OnInit &#123;</span><br><span class="line">    <span class="keyword">private</span> _result: &#123; [index: <span class="built_in">string</span>]: [] &#125; = &#123;&#125;;</span><br><span class="line">    <span class="keyword">private</span> _labelHandler: <span class="function">(<span class="params">val: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">        <span class="keyword">private</span> service: DemoService,</span></span><br><span class="line"><span class="params">    </span>) &#123; &#125;</span><br><span class="line">  </span><br><span class="line">  aTestFunc()&#123;</span><br><span class="line">      <span class="keyword">this</span>._labelHandler(<span class="string">"123123"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  writeValue(value: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (value) &#123;</span><br><span class="line">            <span class="comment">// todo åœ¨è¿™é‡Œå¯¹çˆ¶ç»„ä»¶ä¼ è¿›æ¥çš„ngmodelå€¼åšå¤„ç†</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    registerOnChange(fn: <span class="built_in">any</span>) &#123;</span><br><span class="line">      <span class="comment">//æ¯æ¬¡æ§ä»¶viewå±‚çš„å€¼å‘ç”Ÿæ”¹å˜ï¼Œéƒ½è¦è°ƒç”¨è¯¥æ–¹æ³•é€šçŸ¥å¤–éƒ¨</span></span><br><span class="line">        <span class="keyword">this</span>._labelHandler = fn;</span><br><span class="line">    &#125;</span><br><span class="line">    registerOnTouched(fn: <span class="built_in">any</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çˆ¶ç»„ä»¶</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// html</span><br><span class="line">    <span class="tag">&lt;<span class="name">app-demo</span> [(<span class="attr">ngModel</span>)]=<span class="string">"demo"</span> &gt;</span><span class="tag">&lt;/<span class="name">app-demo</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// component.ts</span></span><br><span class="line"></span><br><span class="line">ngOnInit() &#123;</span><br><span class="line">  <span class="comment">// ç»™demoä¸€ä¸ªå€¼åŒå‘ç»‘å®š</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      ControlValueAccessor acts as a bridge between the Angular forms API and a native element in the DOM.
    
    </summary>
    
      <category term="é»˜è®¤åˆ†ç±»" scheme="https://kitions.github.io/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/"/>
    
    
      <category term="Angnular" scheme="https://kitions.github.io/tags/Angnular/"/>
    
  </entry>
  
  <entry>
    <title>CKediorä¸¤å¼ æ–¹æ³•ä¸Šä¼ å›¾ç‰‡åŠç®€å•çš„pluginsç¼–å†™</title>
    <link href="https://kitions.github.io/2020/03/19/CKedior%E4%B8%A4%E5%BC%A0%E6%96%B9%E6%B3%95%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E5%8F%8A%E7%AE%80%E5%8D%95%E7%9A%84plugins%E7%BC%96%E5%86%99/"/>
    <id>https://kitions.github.io/2020/03/19/CKediorä¸¤å¼ æ–¹æ³•ä¸Šä¼ å›¾ç‰‡åŠç®€å•çš„pluginsç¼–å†™/</id>
    <published>2020-03-19T09:29:44.000Z</published>
    <updated>2020-04-17T10:44:48.415Z</updated>
    
    <content type="html"><![CDATA[<p>CKedioræ¯”è¾ƒç¨³å¥ï¼Œæ–‡æ¡£å¾ˆå…¨ï¼Œæ”¯æŒæ’ä»¶ï¼Œé…ç½®ä»€ä¹ˆçš„ä¹Ÿå¾ˆå‹å¥½ï¼Œå…ˆç»™ä¸ªæ–‡æ¡£é“¾æ¥æ„Ÿå—ä¸€ä¸‹ï¼šckeditoråœ¨çº¿æ–‡æ¡£<a href="https://docs.ckeditor.com/#!/guide/dev_installationã€‚" target="_blank" rel="noopener">https://docs.ckeditor.com/#!/guide/dev_installationã€‚</a></p><p>ckeditorå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ä¸Šä¼ å›¾ç‰‡ç›®å‰æƒ³åˆ°çš„ä¸¤ä¸ªæ–¹æ³•ï¼š</p><ol><li>è‡ªå·±å†™ä¸€ä¸ªä¸Šä¼ æ’ä»¶ï¼ˆæ‰©å±•æ€§æ›´å¼ºï¼‰</li><li>æ‰¾åˆ°é’©å­å‡½æ•°ç›‘å¬äº‹ä»¶ï¼ˆä¸Šä¼ æ›´é€šç”¨ï¼‰</li></ol><h1 id="ä¸€-è‡ªå·±å†™ä¸€ä¸ªä¸Šä¼ æ’ä»¶"><a href="#ä¸€-è‡ªå·±å†™ä¸€ä¸ªä¸Šä¼ æ’ä»¶" class="headerlink" title="ä¸€. è‡ªå·±å†™ä¸€ä¸ªä¸Šä¼ æ’ä»¶"></a>ä¸€. è‡ªå·±å†™ä¸€ä¸ªä¸Šä¼ æ’ä»¶</h1><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>æ¯•ç«Ÿæ¯ä¸ªäººçš„éœ€æ±‚éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿™æ—¶å€™ä¸€ä¸ªç¼–è¾‘å™¨çš„â€œå¯æ‰©å±•æ€§â€å°±å¿…ä¸å¯å°‘äº†ã€‚æœ‰äº†è¿™ä¸ªæ’ä»¶åŠŸèƒ½ï¼Œä½ å¯ä»¥é’ˆå¯¹å¯Œæ–‡æœ¬ç¼–è¾‘å™¨åšå„ç§å„æ ·çš„äº‹æƒ…ï¼Œæ¯”å¦‚å¤åˆ¶å¤–ç«™å›¾ç‰‡ï¼Œè‡ªåŠ¨ä¸Šä¼ åˆ°ä½ æŒ‡å®šçš„åŸŸåï¼Œå¹¶æ’å…¥å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ä¸­ç­‰ç­‰ã€‚</p><h3 id="æ€ä¹ˆå†™ä¸€ä¸ªckeditorçš„plugins"><a href="#æ€ä¹ˆå†™ä¸€ä¸ªckeditorçš„plugins" class="headerlink" title="æ€ä¹ˆå†™ä¸€ä¸ªckeditorçš„plugins"></a>æ€ä¹ˆå†™ä¸€ä¸ªckeditorçš„plugins</h3><h5 id="1-æ–‡ä»¶å¤¹"><a href="#1-æ–‡ä»¶å¤¹" class="headerlink" title="1. æ–‡ä»¶å¤¹"></a>1. æ–‡ä»¶å¤¹</h5><p>åœ¨ckeidtorçš„ç›®å½•ä¸‹æœ‰ä¸ªpluginsæ–‡ä»¶å¤¹ï¼Œæˆ‘ä»¬è¦åšçš„å°±åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œï¼Œåœ¨pluginsä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œåç§°ä¸ºä½ æ‰€å‘½åçš„æ’ä»¶åï¼Œæ–°å»ºä¸€ä¸ªjsã€‚imagesæ–‡ä»¶å¤¹ç”¨æ¥å­˜æ”¾ç”¨åˆ°çš„å°å›¾æ ‡.</p><p><img src="https://ae01.alicdn.com/kf/H2f66016af09c42188659a0e89028b111I.png" alt=""></p><h5 id="2-plugin-js"><a href="#2-plugin-js" class="headerlink" title="2. plugin.js"></a>2. plugin.js</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CKEDITOR.plugins.add( <span class="string">'UploadImage'</span>, &#123;</span><br><span class="line">    icons: <span class="string">'image'</span>,</span><br><span class="line">    init: <span class="function"><span class="keyword">function</span>(<span class="params"> editor </span>) </span>&#123;</span><br><span class="line">        <span class="comment">// Plugin logic goes here...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h6 id="2-1-åˆ›å»ºç¼–è¾‘å™¨å‘½ä»¤"><a href="#2-1-åˆ›å»ºç¼–è¾‘å™¨å‘½ä»¤" class="headerlink" title="2.1 åˆ›å»ºç¼–è¾‘å™¨å‘½ä»¤"></a>2.1 åˆ›å»ºç¼–è¾‘å™¨å‘½ä»¤</h6><p>æˆ‘ä»¬å¸Œæœ›æ’ä»¶å…·æœ‰ä¸€ä¸ªå¯¹è¯æ¡†çª—å£ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªç¼–è¾‘å™¨å‘½ä»¤æ¥æ‰“å¼€ä¸€ä¸ªæ–°çš„å¯¹è¯æ¡†çª—å£ã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨çš„<a href="https://ckeditor.com/docs/ckeditor4/latest/api/CKEDITOR_editor.html#method-addCommand" target="_blank" rel="noopener">editor.addCommand</a> å‡½æ•°æ³¨å†Œabbrå‘½ä»¤ã€‚ä¸šåŠ¡é€»è¾‘ ä¸»è¦å†™åœ¨è¿™å—</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">editor.addCommand( <span class="string">'abbr'</span>, <span class="keyword">new</span> CKEDITOR.dialogCommand( <span class="string">'abbrDialog'</span> ) );</span><br></pre></td></tr></table></figure><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">editor.addCommand(<span class="string">'openFileComm'</span>, &#123;&#125;</span><br></pre></td></tr></table></figure><h6 id="2-2-åˆ›å»ºå·¥å…·æ æŒ‰é’®"><a href="#2-2-åˆ›å»ºå·¥å…·æ æŒ‰é’®" class="headerlink" title="2.2 åˆ›å»ºå·¥å…·æ æŒ‰é’®"></a>2.2 åˆ›å»ºå·¥å…·æ æŒ‰é’®</h6><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">editor.ui.addButton( <span class="string">'Abbr'</span>, &#123;</span><br><span class="line">    label: <span class="string">'Insert Abbreviation'</span>,</span><br><span class="line">    command: <span class="string">'UploadImage'</span>,</span><br><span class="line">    toolbar: <span class="string">'insert'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h6 id="2-3-CKEditoråˆå§‹åŒ–"><a href="#2-3-CKEditoråˆå§‹åŒ–" class="headerlink" title="2.3 CKEditoråˆå§‹åŒ–"></a>2.3 CKEditoråˆå§‹åŒ–</h6><p>å‘Šè¯‰CKEditoråŠ è½½æˆ‘ä»¬çš„æ’ä»¶äº†ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¿…é¡»å°†å…¶åç§°æ·»åŠ åˆ°<br>CKEDITOR.config.extraPluginsé…ç½®é€‰é¡¹ä¸­ï¼š<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.extraPlugins = <span class="string">'UploadImage'</span>;</span><br></pre></td></tr></table></figure></p><h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><p>ps: ç›®å‰å†™çš„æ’ä»¶æ˜¯ç”¨jqueryé’ˆå¯¹è‡ªå·±é¡¹ç›®ä½¿ç”¨çš„ã€‚æ²¡æœ‰å†™æˆä¸€ä¸ªé€šç”¨å‹çš„æ’ä»¶</p><p><img src="https://ae01.alicdn.com/kf/Hadce4c9a7cd34578a322d91efc90af9c8.png" alt=""></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * link æ·»åŠ è‡ªå®šä¹‰å›¾ç‰‡ä¸Šä¼ ç»„ä»¶  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*     html</span></span><br><span class="line"><span class="comment">    &lt;div&gt;</span></span><br><span class="line"><span class="comment">        &lt;form id="editorImageForm" enctype="multipart/form-data" method="post"</span></span><br><span class="line"><span class="comment">            style="display: none"&gt;</span></span><br><span class="line"><span class="comment">            &lt;div&gt;</span></span><br><span class="line"><span class="comment">                &lt;input type="file" id="editFileInput" name="file"</span></span><br><span class="line"><span class="comment">                    accept=".gif,.png,.jpg,.jpeg" /&gt;&lt;br&gt;</span></span><br><span class="line"><span class="comment">            &lt;/div&gt;</span></span><br><span class="line"><span class="comment">        &lt;/form&gt;</span></span><br><span class="line"><span class="comment">    &lt;/div&gt;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">CKEDITOR.plugins.add(<span class="string">'UploadImage'</span>,&#123;<span class="comment">// è°ƒç”¨addæ–¹æ³•æ·»åŠ æ’ä»¶</span></span><br><span class="line">    init : <span class="function"><span class="keyword">function</span> (<span class="params">editor</span>) </span>&#123; <span class="comment">// åˆå§‹åŒ–é¡µé¢æ—¶è°ƒç”¨æ–¹æ³•ï¼Œæ¥æ”¶ä¸€ä¸ªå¯Œæ–‡æœ¬å¯¹è±¡å®ä¾‹</span></span><br><span class="line">        <span class="keyword">var</span> pluginName = <span class="string">'UploadImage'</span>; <span class="comment">// æ’ä»¶å</span></span><br><span class="line">        <span class="keyword">var</span> _file = <span class="built_in">document</span>.getElementById(<span class="string">'editFileInput'</span>); <span class="comment">//è·å–é¡µé¢ä¸­çš„fileæ–‡ä»¶é€‰æ‹©å™¨å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">var</span> uploadUrl = <span class="built_in">document</span>.querySelector(<span class="string">'.site_url_upload'</span>).innerText || <span class="string">"https://user.smm.cn/upload_img"</span>; <span class="comment">// ä¸Šä¼ çš„urlï¼Œä»é¡µé¢ä¸­è·å–çš„</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æ·»åŠ æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        editor.addCommand(<span class="string">'openFileComm'</span>, &#123;<span class="comment">//æ·»åŠ å‘½ä»¤</span></span><br><span class="line">            exec : <span class="function"><span class="keyword">function</span> (<span class="params">editor</span>) </span>&#123;<span class="comment">//å‘½ä»¤è°ƒç”¨æ—¶æ‰§è¡Œæ­¤å‡½æ•°</span></span><br><span class="line">                _file.click(); <span class="comment">//è§¦å‘æ–‡ä»¶é€‰æ‹©å™¨çš„ç‚¹å‡»äº‹ä»¶</span></span><br><span class="line">                _file.onchange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="comment">//ä¸ºæ–‡ä»¶é€‰æ‹©å™¨ç‹¬äº«ç»‘å®šonchangeæ–¹æ³•</span></span><br><span class="line">                    upload();<span class="comment">//æ‰§è¡Œå‡½æ•°</span></span><br><span class="line">                    <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                        <span class="keyword">let</span> files = _file.files[<span class="number">0</span>];</span><br><span class="line">                        <span class="keyword">var</span> fd = <span class="keyword">new</span> FormData();</span><br><span class="line">                        fd.append(<span class="string">"richTxt_img"</span>, files); </span><br><span class="line">                        fd.append(<span class="string">"name"</span>, <span class="string">""</span>); </span><br><span class="line">                        fd.append(<span class="string">"cat"</span>, <span class="string">""</span>); </span><br><span class="line">                        $.ajax(&#123; <span class="comment">//ä½¿ç”¨ajaxè¯·æ±‚ä¸Šä¼ å›¾ç‰‡</span></span><br><span class="line">                            url : uploadUrl,</span><br><span class="line">                            <span class="keyword">type</span> : <span class="string">'POST'</span>,</span><br><span class="line">                            data : fd,</span><br><span class="line">                            <span class="keyword">async</span> : <span class="literal">false</span>,</span><br><span class="line">                            cache : <span class="literal">false</span>,</span><br><span class="line">                            processData:<span class="literal">false</span>,</span><br><span class="line">                            contentType:<span class="literal">false</span>,</span><br><span class="line">                            dataType:<span class="string">'json'</span>,</span><br><span class="line">                            success : <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">                                <span class="keyword">if</span>(data.code === <span class="number">0</span>)&#123;</span><br><span class="line">                                    <span class="keyword">var</span> element = CKEDITOR.dom.element.createFromHtml( <span class="string">'&lt;img style="width: auto;" src="'</span> + data.fileurl +<span class="string">'" border="0" /&gt;'</span> ); <span class="comment">//ä¸Šä¼ æˆåŠŸåæ·»åŠ ä¸Šä¼ å®Œæˆçš„å›¾ç‰‡å…ƒç´ åˆ°å¯Œæ–‡æœ¬å†…å®¹ä¸­</span></span><br><span class="line">                                    editor.insertElement( element );<span class="comment">//æ’å…¥å…ƒç´ </span></span><br><span class="line">                                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                                    alert(<span class="string">"å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼"</span>)</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;,</span><br><span class="line">                            error : <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                                alert(<span class="string">"ajaxå›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼"</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="keyword">async</span> : <span class="literal">true</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        editor.ui.addButton &amp;&amp; editor.ui.addButton(pluginName, &#123; <span class="comment">//æ·»åŠ ä¸€ä¸ªä¸Šä¼ å›¾ç‰‡çš„æŒ‰é’®</span></span><br><span class="line">            label: <span class="string">'å›¾ç‰‡ä¸Šä¼ '</span>,<span class="comment">//æŒ‰é’®æç¤ºå</span></span><br><span class="line">            command: <span class="string">'openFileComm'</span>,<span class="comment">//å½“æŒ‰é’®è¢«ç‚¹å‡»æ—¶æ‰§è¡Œä¸Šé¢å®šä¹‰å¥½çš„å‘½ä»¤</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * æ·»åŠ è‡ªå®šä¹‰æŒ‰é’®å›¾ç‰‡</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            icon: <span class="keyword">this</span>.path + <span class="string">'./upload.png'</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h1 id="äºŒ-åˆ©ç”¨Ckeditorå†…ç½®çš„é’©å­æ¥ä¸Šä¼ å›¾ç‰‡"><a href="#äºŒ-åˆ©ç”¨Ckeditorå†…ç½®çš„é’©å­æ¥ä¸Šä¼ å›¾ç‰‡" class="headerlink" title="äºŒ.  åˆ©ç”¨Ckeditorå†…ç½®çš„é’©å­æ¥ä¸Šä¼ å›¾ç‰‡"></a>äºŒ.  åˆ©ç”¨Ckeditorå†…ç½®çš„é’©å­æ¥ä¸Šä¼ å›¾ç‰‡</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// editor.module.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; NgModule, CUSTOM_ELEMENTS_SCHEMA &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ShareModule &#125; <span class="keyword">from</span> <span class="string">'../../../share/share.module'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CKEditorModule &#125; <span class="keyword">from</span> <span class="string">'ng2-ckeditor'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; CkEditorComponent &#125; <span class="keyword">from</span> <span class="string">'./ckeditor/ckeditor.component'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@NgModule(&#123;</span><br><span class="line">    declarations: [</span><br><span class="line">        CkEditorComponent,</span><br><span class="line">    ],</span><br><span class="line">    imports: [</span><br><span class="line">        ShareModule,</span><br><span class="line">        CKEditorModule,</span><br><span class="line">    ],</span><br><span class="line">    exports: [</span><br><span class="line">        CkEditorComponent</span><br><span class="line">    ],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">NewsEditorModule</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CkEditorComponentå…³é”®æ€§ä»£ç </span></span><br><span class="line"><span class="comment">// this.actionURLä¸Šä¼ é“¾æ¥</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> CkEditorComponent <span class="keyword">implements</span> ControlValueAccessor, OnInit,OnChanges, AfterViewInit &#123;</span><br><span class="line">  ngOnInit() &#123;</span><br><span class="line">        <span class="keyword">this</span>.ckeConfig =  &#123;</span><br><span class="line">            allowedContent: <span class="literal">false</span>,</span><br><span class="line">            extraPlugins: <span class="string">'divarea'</span>,</span><br><span class="line">            forcePasteAsPlainText: <span class="literal">false</span>,</span><br><span class="line">            height: <span class="number">500</span>,</span><br><span class="line">            toolbar: <span class="string">'Basic'</span>,</span><br><span class="line">            toolbarGroups: [</span><br><span class="line">                <span class="comment">// &#123; name: 'clipboard', groups: [ 'clipboard', 'undo' ] &#125;,</span></span><br><span class="line">                &#123; name: <span class="string">'editing'</span>, groups: [<span class="string">'find'</span>, <span class="string">'selection'</span>] &#125;, <span class="comment">// 'spellchecker'</span></span><br><span class="line">                &#123; name: <span class="string">'links'</span> &#125;,</span><br><span class="line">                &#123; name: <span class="string">'insert'</span> &#125;,</span><br><span class="line">                &#123; name: <span class="string">'forms'</span> &#125;,</span><br><span class="line">                &#123; name: <span class="string">'tools'</span> &#125;,</span><br><span class="line">                &#123; name: <span class="string">'document'</span>, groups: [<span class="string">'mode'</span>, <span class="string">'document'</span>, <span class="string">'doctools'</span>] &#125;,</span><br><span class="line">                &#123; name: <span class="string">'others'</span> &#125;,</span><br><span class="line">                &#123; name: <span class="string">'basicstyles'</span>, groups: [<span class="string">'basicstyles'</span>, <span class="string">'cleanup'</span>] &#125;,</span><br><span class="line">                &#123; name: <span class="string">'paragraph'</span>, groups: [<span class="string">'list'</span>, <span class="string">'indent'</span>, <span class="string">'align'</span>] &#125;,</span><br><span class="line">                &#123; name: <span class="string">'styles'</span> &#125;,</span><br><span class="line">                &#123; name: <span class="string">'colors'</span> &#125;,</span><br><span class="line">                <span class="comment">// &#123; name: 'about' &#125;</span></span><br><span class="line">            ],</span><br><span class="line">            filebrowserImageUploadUrl: <span class="keyword">this</span>.actionURL,</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">ngAfterViewInit() &#123;</span><br><span class="line">        <span class="keyword">const</span> self = <span class="keyword">this</span>;</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> instanceName <span class="keyword">in</span> CKEDITOR.instances) &#123;</span><br><span class="line">                self.editor = CKEDITOR.instances[instanceName];</span><br><span class="line">                self.editor.on(<span class="string">"instanceReady"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">ev: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">let</span> editor = ev.editor;</span><br><span class="line">                    <span class="comment">// ç›‘å¬ä¸Šä¼ äº‹ä»¶</span></span><br><span class="line">                    editor.on(<span class="string">'fileUploadRequest'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">evt</span>) </span>&#123;</span><br><span class="line">                        <span class="keyword">var</span> fileLoader = evt.data.fileLoader,</span><br><span class="line">                            formData = <span class="keyword">new</span> FormData(),</span><br><span class="line">                            xhr = fileLoader.xhr;</span><br><span class="line"></span><br><span class="line">                        xhr.open(<span class="string">'POST'</span>, fileLoader.uploadUrl, <span class="literal">true</span>);</span><br><span class="line">                        xhr.setRequestHeader(<span class="string">'TOKEN'</span>, self._cookie.get(CookiesService.KEY));</span><br><span class="line"></span><br><span class="line">                        formData.append(<span class="string">'upload'</span>, fileLoader.file, fileLoader.fileName);</span><br><span class="line">                        fileLoader.xhr.send(formData);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Prevented the default behavior.</span></span><br><span class="line">                        evt.stop();</span><br><span class="line">                    &#125;, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">4</span>);</span><br><span class="line">                    <span class="comment">// ç›‘å¬è¿”å›äº‹ä»¶</span></span><br><span class="line">                    editor.on(<span class="string">'fileUploadResponse'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">evt</span>) </span>&#123;</span><br><span class="line">                        <span class="comment">// Prevent the default response handler.</span></span><br><span class="line">                        evt.stop();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Get XHR and response.</span></span><br><span class="line">                        <span class="keyword">var</span> data = evt.data,</span><br><span class="line">                            xhr = data.fileLoader.xhr,</span><br><span class="line">                            response = xhr.responseText.split(<span class="string">'|'</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (response[<span class="number">1</span>]) &#123;</span><br><span class="line">                            <span class="comment">// An error occurred during upload.</span></span><br><span class="line">                            data.message = response[<span class="number">1</span>];</span><br><span class="line">                            evt.cancel();</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> (response[<span class="number">0</span>]) &#123;</span><br><span class="line">                                    <span class="keyword">const</span> res = <span class="built_in">JSON</span>.parse(response[<span class="number">0</span>]);</span><br><span class="line">                                    <span class="keyword">if</span> (res.code === <span class="number">0</span>) &#123;</span><br><span class="line">                                        data.url = res.data &amp;&amp; res.data.key;</span><br><span class="line">                                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                        data.message = res.msg;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    data.message = <span class="string">"ä¸Šä¼ å¤±è´¥äº†"</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                                <span class="built_in">console</span>.log(<span class="string">"ä¸Šä¼ å›¾ç‰‡å‡ºé”™"</span>, error);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      ckedioræ€ä¹ˆå†™æ’ä»¶ï¼Œckediorä¸Šä¼ å›¾ç‰‡pluginsï¼Œng2-ckediorä¸Šä¼ å›¾ç‰‡çš„ä¸€äº›æ‘¸ç´¢ï¼Œä¸»è¦æ˜¯ngAfterViewInitä¸­çš„ä¸¤ä¸ªäº‹ä»¶ç›‘å¬
    
    </summary>
    
      <category term="é»˜è®¤åˆ†ç±»" scheme="https://kitions.github.io/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/"/>
    
    
      <category term="Angnular" scheme="https://kitions.github.io/tags/Angnular/"/>
    
      <category term="CKeditor" scheme="https://kitions.github.io/tags/CKeditor/"/>
    
  </entry>
  
  <entry>
    <title>Next.js - FQ</title>
    <link href="https://kitions.github.io/2020/03/03/Next.js%20-%20FQ/"/>
    <id>https://kitions.github.io/2020/03/03/Next.js - FQ/</id>
    <published>2020-03-03T10:15:37.000Z</published>
    <updated>2020-03-03T10:12:38.259Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Next-js-FQ"><a href="#Next-js-FQ" class="headerlink" title="Next.js - FQ"></a>Next.js - FQ</h1><h2 id="How-to-use-cssModules"><a href="#How-to-use-cssModules" class="headerlink" title="How to use cssModules"></a>How to use cssModules</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># install next-css</span><br><span class="line"></span><br><span class="line">yarn add @zeit/next-css</span><br><span class="line"></span><br><span class="line"># use nextCss warpped the config</span><br><span class="line"><span class="comment">// next.config.js</span></span><br><span class="line"><span class="keyword">const</span> withLess = <span class="built_in">require</span>(<span class="string">'@zeit/next-less'</span>);</span><br><span class="line"><span class="keyword">const</span> withCSS = <span class="built_in">require</span>(<span class="string">'@zeit/next-css'</span>);</span><br><span class="line">...</span><br><span class="line"><span class="built_in">module</span>.exports = withCSS(</span><br><span class="line">  withLess(&#123;</span><br><span class="line">    cssModules: <span class="literal">true</span>,</span><br><span class="line">    ... <span class="comment">// other config</span></span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"># use css modules</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> css <span class="keyword">from</span> <span class="string">"../style.css"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Component = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=&#123;css.example&#125;&gt;</span><br><span class="line">      ...</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Component;</span></span><br></pre></td></tr></table></figure><h2 id="How-to-listen-for-routing-changes"><a href="#How-to-listen-for-routing-changes" class="headerlink" title="How to listen for routing changes?"></a>How to listen for routing changes?</h2><p>The router of next provide some APIs that are used to listen for routing changes for us. <code>For example: beforeHistoryChange, routeChangeComplete...</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// _app.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Router <span class="keyword">from</span> <span class="string">'next/router'</span>;</span><br><span class="line">...</span><br><span class="line"><span class="comment">// Listen the route path change</span></span><br><span class="line">Router.events.on(<span class="string">'routeChangeStart'</span>, (path) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'route start change, the next route is:'</span>, path);</span><br><span class="line">  <span class="comment">// do something what you want to do.</span></span><br><span class="line">  ...</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="The-solution-of-ant-design-in-the-development-environment-style-load-is-incomplete"><a href="#The-solution-of-ant-design-in-the-development-environment-style-load-is-incomplete" class="headerlink" title="The solution of ant-design in the development environment style load is incomplete."></a>The solution of <code>ant-design</code> in the development environment style load is incomplete.</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// next.config.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isDev = process.env.NODE_ENV !== <span class="string">'production'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// fix antd bug in dev development</span></span><br><span class="line"><span class="keyword">const</span> devAntd = <span class="string">'@import "~antd/dist/antd.less";\n'</span>;</span><br><span class="line"><span class="keyword">const</span> stylesData = fs.readFileSync(</span><br><span class="line">  path.resolve(__dirname, <span class="string">'./assets/_styles.less'</span>),</span><br><span class="line">  <span class="string">'utf-8'</span></span><br><span class="line">);</span><br><span class="line">fs.writeFileSync(</span><br><span class="line">  path.resolve(__dirname, <span class="string">'./assets/self-styles.less'</span>),</span><br><span class="line">  isDev ? <span class="string">`<span class="subst">$&#123;devAntd&#125;</span><span class="subst">$&#123;stylesData&#125;</span>`</span> : stylesData,</span><br><span class="line">  <span class="string">'utf-8'</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><h2 id="The-solution-of-min-css-extract-plugin-warning-in-the-console"><a href="#The-solution-of-min-css-extract-plugin-warning-in-the-console" class="headerlink" title="The solution of min-css-extract-plugin warning in the console"></a>The solution of <code>min-css-extract-plugin</code> warning in the console</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chunk commons [mini-css-extract-plugin]</span><br><span class="line">Conflicting order between:</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>// next.config.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// define the webpack plugn</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FilterPlugin</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(options) &#123;</span><br><span class="line">    <span class="keyword">this</span>.options = options;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    compiler.hooks.afterEmit.tap(</span><br><span class="line">      <span class="string">'FilterPlugin'</span>,</span><br><span class="line">      (compilation) =&gt; &#123;</span><br><span class="line">        compilation.warnings = (compilation.warnings).filter(</span><br><span class="line">          warning =&gt; !<span class="keyword">this</span>.options.filter.test(warning.message)</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">webpack: <span class="function">(<span class="params">config, &#123;...args&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  config.plugins.push(</span><br><span class="line">    ...[</span><br><span class="line">      <span class="comment">// Instantiate the plugin and add it as a Webpack plugin</span></span><br><span class="line">      <span class="keyword">new</span> FilterPlugin(</span><br><span class="line">        &#123; <span class="attr">filter</span>: <span class="regexp">/chunk styles \[mini-css-extract-plugin]\nConflicting order between:/</span> &#125;</span><br><span class="line">      )</span><br><span class="line">    ]</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="How-to-polyfill-IE10-IE9-in-this-scaffold"><a href="#How-to-polyfill-IE10-IE9-in-this-scaffold" class="headerlink" title="How to polyfill IE10/IE9 in this scaffold?"></a>How to polyfill IE10/IE9 in this scaffold?</h2><h4 id="Add-polyfills-js-in-your-project"><a href="#Add-polyfills-js-in-your-project" class="headerlink" title="Add polyfills.js in your project."></a>Add polyfills.js in your project.</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /core/polyfills.js</span></span><br><span class="line"><span class="comment">/* eslint no-extend-native: 0 */</span></span><br><span class="line"><span class="comment">// core-js comes with Next.js. So, you can import it like below</span></span><br><span class="line"><span class="keyword">import</span> includes <span class="keyword">from</span> <span class="string">'core-js/library/fn/string/virtual/includes'</span>;</span><br><span class="line"><span class="keyword">import</span> repeat <span class="keyword">from</span> <span class="string">'core-js/library/fn/string/virtual/repeat'</span>;</span><br><span class="line"><span class="keyword">import</span> assign <span class="keyword">from</span> <span class="string">'core-js/library/fn/object/assign'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'core-js/es6/map'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'core-js/es6/set'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add your polyfills</span></span><br><span class="line"><span class="comment">// This files runs at the very beginning (even before React and Next.js core)</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Load your polyfills'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">String</span>.prototype.includes = includes;</span><br><span class="line"><span class="built_in">String</span>.prototype.repeat = repeat;</span><br><span class="line"><span class="built_in">Object</span>.assign = assign;</span><br></pre></td></tr></table></figure><h4 id="How-to-alias-folder-path"><a href="#How-to-alias-folder-path" class="headerlink" title="How to alias folder path?"></a>How to alias folder path?</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// next.config.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// config alias</span></span><br><span class="line">config.resolve.alias[<span class="string">'@containers'</span>] =</span><br><span class="line">  path.resolve(__dirname, <span class="string">'./src/containers'</span>);</span><br></pre></td></tr></table></figure><h4 id="Config-the-next-config-js"><a href="#Config-the-next-config-js" class="headerlink" title="Config the next.config.js"></a>Config the next.config.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// next.config.js</span></span><br><span class="line">...</span><br><span class="line">webpack: <span class="function"><span class="keyword">function</span> (<span class="params">cfg</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> originalEntry = cfg.entry</span><br><span class="line">    cfg.entry = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> entries = <span class="keyword">await</span> originalEntry()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        entries[<span class="string">'main.js'</span>] &amp;&amp;</span><br><span class="line">        !entries[<span class="string">'main.js'</span>].includes(<span class="string">'./core/polyfills.js'</span>)</span><br><span class="line">      ) &#123;</span><br><span class="line">        entries[<span class="string">'main.js'</span>].unshift(<span class="string">'./core/polyfills.js'</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> entries</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cfg</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h4 id="Downgrade-your-Next-version-to-â€˜7-0-2â€™"><a href="#Downgrade-your-Next-version-to-â€˜7-0-2â€™" class="headerlink" title="Downgrade your Next version to â€˜7.0.2â€™"></a>Downgrade your Next version to â€˜7.0.2â€™</h4><h2 id="The-ant-design-style-flash-when-page-refresh"><a href="#The-ant-design-style-flash-when-page-refresh" class="headerlink" title="The ant-design style flash when page refresh!"></a>The ant-design style flash when page refresh!</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// _app.js -&gt; getInitialProps</span></span><br><span class="line">  <span class="comment">/* åˆ·æ–°é¡µé¢ antdé—ªåŠ¨ */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">"undefined"</span>) &#123;</span><br><span class="line">    <span class="built_in">window</span>.onload = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">document</span>.getElementById(<span class="string">"flashStyle"</span>).remove();</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// _app.js -&gt; &lt;Head&gt;&lt;/Head&gt;</span></span><br><span class="line">&lt;style</span><br><span class="line">  id=<span class="string">'flashStyle'</span></span><br><span class="line">  dangerouslySetInnerHTML=&#123;&#123;</span><br><span class="line">    __html: <span class="string">`</span></span><br><span class="line"><span class="string">      *, *::before, *::after &#123;</span></span><br><span class="line"><span class="string">        transition: none!important;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">  &#125;&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure><h2 id="How-to-speed-up-packing-in-production"><a href="#How-to-speed-up-packing-in-production" class="headerlink" title="How to speed up packing in production?"></a>How to speed up packing in production?</h2><h4 id="1-tenser-webpack-plugin-gt-cache"><a href="#1-tenser-webpack-plugin-gt-cache" class="headerlink" title="1. tenser-webpack-plugin -&gt; cache"></a>1. tenser-webpack-plugin -&gt; cache</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> TerserPlugin(&#123;</span><br><span class="line">  cache: <span class="literal">true</span>, <span class="comment">// add this line</span></span><br><span class="line">  terserOptions: &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;),</span><br></pre></td></tr></table></figure><h4 id="2-Add-thread-loader"><a href="#2-Add-thread-loader" class="headerlink" title="2. Add thread-loader"></a>2. Add thread-loader</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">config.module.rules.push(&#123;</span><br><span class="line">  test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">  include: [</span><br><span class="line">    path.resolve(<span class="string">'src'</span>)</span><br><span class="line">    ...</span><br><span class="line">  ],</span><br><span class="line">  options: &#123;</span><br><span class="line">    workerParallelJobs: <span class="number">50</span>,</span><br><span class="line">    <span class="comment">// additional node.js arguments</span></span><br><span class="line">    workerNodeArgs: [<span class="string">'--max-old-space-size=1024'</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">  loader: <span class="string">'thread-loader'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="How-to-optimize-bundle-size"><a href="#How-to-optimize-bundle-size" class="headerlink" title="How to optimize bundle size?"></a>How to optimize bundle size?</h2><h4 id="Optimize-moment-local"><a href="#Optimize-moment-local" class="headerlink" title="Optimize moment local."></a>Optimize moment local.</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// next.config.js</span></span><br><span class="line"><span class="keyword">const</span> myWebpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</span><br><span class="line">...</span><br><span class="line"><span class="keyword">new</span> myWebpack.ContextReplacementPlugin(<span class="regexp">/moment[\/\\]locale$/</span>, /zh-cn|en/),</span><br></pre></td></tr></table></figure><h4 id="Optimize-antd-icon-dist"><a href="#Optimize-antd-icon-dist" class="headerlink" title="Optimize antd icon dist."></a>Optimize antd icon dist.</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// next.config.js</span></span><br><span class="line">...</span><br><span class="line">config.resolve.alias[<span class="string">'@ant-design/icons/lib/dist$'</span>] = path.resolve(__dirname, <span class="string">'./assets/icons.js'</span>);</span><br><span class="line"><span class="comment">// /assets/icons.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½ è‡ªå·±æ‰‹åŠ¨å¼•å…¥çš„Iconï¼Œé»˜è®¤æ˜¯outline</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  <span class="keyword">default</span> <span class="keyword">as</span> LoginOutline</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@ant-design/icons/lib/outline/LoginOutline'</span>;</span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  <span class="keyword">default</span> <span class="keyword">as</span> LogoutOutline</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@ant-design/icons/lib/outline/LogoutOutline'</span>;</span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  <span class="keyword">default</span> <span class="keyword">as</span> UserOutline</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@ant-design/icons/lib/outline/UserOutline'</span>;</span><br><span class="line">...</span><br><span class="line"><span class="comment">// ä¸‹é¢çš„ ä¸æ˜¯è‡ªå·±å¼•å…¥çš„ï¼Œè€Œæ˜¯å†…ç½®ç»„ä»¶å¼•å…¥çš„ï¼Œæ¯”å¦‚Input/Select/Datepickerç­‰</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  <span class="keyword">default</span> <span class="keyword">as</span> SearchOutline</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@ant-design/icons/lib/outline/SearchOutline'</span>;</span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  <span class="keyword">default</span> <span class="keyword">as</span> DownOutline</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@ant-design/icons/lib/outline/DownOutline'</span>;</span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  <span class="keyword">default</span> <span class="keyword">as</span> UpOutline</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@ant-design/icons/lib/outline/UpOutline'</span>;</span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  <span class="keyword">default</span> <span class="keyword">as</span> CalendarOutline</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'@ant-design/icons/lib/outline/CalendarOutline'</span>;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"><span class="keyword">const</span> withSass = <span class="built_in">require</span>(<span class="string">'@zeit/next-sass'</span>)</span><br><span class="line"><span class="keyword">const</span> withCss = <span class="built_in">require</span>(<span class="string">'@zeit/next-css'</span>);</span><br><span class="line"><span class="keyword">const</span> withBundleAnalyzer = <span class="built_in">require</span>(<span class="string">"@zeit/next-bundle-analyzer"</span>);</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PROD_FILE = <span class="string">"./config/prod.json"</span>;</span><br><span class="line"><span class="keyword">const</span> DEV_FILE = <span class="string">"./config/dev.json"</span>;</span><br><span class="line"><span class="keyword">const</span> LOCAL_FILE = <span class="string">"./config/local.json"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> readConfig = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">const</span> prod = fs.existsSync(PROD_FILE);</span><br><span class="line"><span class="keyword">if</span> (prod) &#123;</span><br><span class="line"><span class="keyword">return</span> fs.readFileSync(PROD_FILE)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'production'</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> fs.readFileSync(DEV_FILE)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fs.readFileSync(LOCAL_FILE)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// return prod ?</span></span><br><span class="line"><span class="comment">// fs.readFileSync(PROD_FILE) :</span></span><br><span class="line"><span class="comment">// !fs.existsSync(LOCAL_FILE) ?</span></span><br><span class="line"><span class="comment">// fs.readFileSync(DEV_FILE) :</span></span><br><span class="line"><span class="comment">// fs.readFileSync(LOCAL_FILE)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// fix: prevents error when .css files are required by node</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">require</span> !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line"><span class="built_in">require</span>.extensions[<span class="string">'.css'</span>] = <span class="function"><span class="params">file</span> =&gt;</span> &#123;&#125;</span><br><span class="line"><span class="built_in">require</span>.extensions[<span class="string">'.scss'</span>] = <span class="function"><span class="params">file</span> =&gt;</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">JSON</span>.parse(readConfig().toString());</span><br><span class="line"><span class="comment">// console.log("config is  :", config);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> webpackConfig = <span class="function">(<span class="params">config, &#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">const</span> originalEntry = config.entry;</span><br><span class="line">    config.entry = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line"><span class="keyword">const</span> entries = <span class="keyword">await</span> originalEntry();</span><br><span class="line"><span class="keyword">if</span> (entries[<span class="string">'main.js'</span>]) &#123;</span><br><span class="line">entries[<span class="string">'main.js'</span>].unshift(<span class="string">'./polyfills.js'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> entries;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">config.module.rules.push(&#123;</span><br><span class="line">test: [<span class="regexp">/\.bmp$/</span>, /\.gif$/, /\.jpe?g$/, /\.png$/],</span><br><span class="line">use: [&#123;</span><br><span class="line">loader: <span class="string">'url-loader'</span>,</span><br><span class="line">options: &#123;</span><br><span class="line">limit: <span class="number">10000</span>,</span><br><span class="line">name: <span class="string">'static/media/[name].[hash:8].[ext]'</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;]</span><br><span class="line">&#125;),</span><br><span class="line">config.plugins.push(</span><br><span class="line"><span class="keyword">new</span> webpack.ContextReplacementPlugin(<span class="regexp">/moment[/\\]locale$/</span>, /zh-cn|en/),</span><br><span class="line">);</span><br><span class="line"><span class="comment">// comstom antd icon</span></span><br><span class="line">config.resolve.alias[<span class="string">"@ant-design/icons/lib/dist$"</span>] = path.resolve(__dirname, <span class="string">'./common/icon.ts'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> config;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = withSass(withCss(withBundleAnalyzer(&#123;</span><br><span class="line">analyzeServer: [<span class="string">"server"</span>, <span class="string">"both"</span>].includes(</span><br><span class="line">process.env.BUNDLE_ANALYZE</span><br><span class="line">),</span><br><span class="line">analyzeBrowser: [<span class="string">"browser"</span>, <span class="string">"both"</span>].includes(</span><br><span class="line">process.env.BUNDLE_ANALYZE</span><br><span class="line">),</span><br><span class="line">bundleAnalyzerConfig: &#123;</span><br><span class="line">server: &#123;</span><br><span class="line">analyzerMode: <span class="string">"static"</span>,</span><br><span class="line">reportFilename: <span class="string">"../bundles/server.html"</span></span><br><span class="line">&#125;,</span><br><span class="line">browser: &#123;</span><br><span class="line">analyzerMode: <span class="string">"static"</span>,</span><br><span class="line">reportFilename: <span class="string">"../bundles/client.html"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">serverRuntimeConfig: config.server,</span><br><span class="line">publicRuntimeConfig: config.client,</span><br><span class="line">distDir: <span class="string">"_next"</span>,</span><br><span class="line">webpack: webpackConfig,</span><br><span class="line">assetPrefix: process.env.NODE_CDN == <span class="string">"true"</span> &amp;&amp; config ?</span><br><span class="line">config.deploy.host + config.deploy.version : <span class="string">""</span></span><br><span class="line">&#125;)));</span><br></pre></td></tr></table></figure><p>Thanks: <a href="https://github.com/luffyZh" target="_blank" rel="noopener">luffyZh</a> <a href="https://github.com/luffyZh/next-antd-scaffold/commit/420cdf9f4d00ba8d823fcb61ebaa35556337e7cb" target="_blank" rel="noopener">update FAQ</a></p>]]></content>
    
    <summary type="html">
    
      Next.js - ä¸€äº›é—®é¢˜ï¼Œå¸¸è§çš„é—®é¢˜ï¼Œé…ç½®
    
    </summary>
    
      <category term="é»˜è®¤åˆ†ç±»" scheme="https://kitions.github.io/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/"/>
    
    
      <category term="next.js" scheme="https://kitions.github.io/tags/next-js/"/>
    
  </entry>
  
  <entry>
    <title>golang ä¸€ç»´æ•°ç»„å˜äºŒç»´æ•°ç»„ï¼Œæ ¹æ®å­—æ®µæ’åºéšæœº</title>
    <link href="https://kitions.github.io/2019/12/30/golang%E4%B8%80%E7%BB%B4%E6%95%B0%E7%BB%84%E5%8F%98%E4%BA%8C%E7%BB%B4%E6%95%B0%E7%BB%84%EF%BC%8C%E6%A0%B9%E6%8D%AE%E5%AD%97%E6%AE%B5%E6%8E%92%E5%BA%8F%E9%9A%8F%E6%9C%BA/"/>
    <id>https://kitions.github.io/2019/12/30/golangä¸€ç»´æ•°ç»„å˜äºŒç»´æ•°ç»„ï¼Œæ ¹æ®å­—æ®µæ’åºéšæœº/</id>
    <published>2019-12-30T03:15:37.000Z</published>
    <updated>2019-12-30T03:16:33.268Z</updated>
    
    <content type="html"><![CDATA[<h1 id="golang-ä¸€ç»´æ•°ç»„å˜äºŒç»´æ•°ç»„ï¼Œæ ¹æ®å­—æ®µæ’åºéšæœº"><a href="#golang-ä¸€ç»´æ•°ç»„å˜äºŒç»´æ•°ç»„ï¼Œæ ¹æ®å­—æ®µæ’åºéšæœº" class="headerlink" title="golang ä¸€ç»´æ•°ç»„å˜äºŒç»´æ•°ç»„ï¼Œæ ¹æ®å­—æ®µæ’åºéšæœº"></a>golang ä¸€ç»´æ•°ç»„å˜äºŒç»´æ•°ç»„ï¼Œæ ¹æ®å­—æ®µæ’åºéšæœº</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"encoding/json"</span></span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"math/rand"</span></span><br><span class="line"><span class="string">"sort"</span></span><br><span class="line"><span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> DemoItemModel <span class="keyword">struct</span> &#123;</span><br><span class="line">ID        <span class="keyword">int</span>    <span class="string">`json:"id"`</span></span><br><span class="line">Name      <span class="keyword">string</span> <span class="string">`json:"name"`</span></span><br><span class="line">SortValue <span class="keyword">int</span>    <span class="string">`json:"sort_value"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> DemoModel []DemoItemModel</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SortKeys []<span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Groups <span class="keyword">struct</span> &#123;</span><br><span class="line">sortNum SortKeys</span><br><span class="line">data    <span class="keyword">map</span>[<span class="keyword">int</span>]DemoModel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s SortKeys)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span>           &#123; <span class="keyword">return</span> <span class="built_in">len</span>(s) &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s SortKeys)</span> <span class="title">Swap</span><span class="params">(i, j <span class="keyword">int</span>)</span></span>      &#123; s[i], s[j] = s[j], s[i] &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s SortKeys)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123; <span class="keyword">return</span> s[i] &lt; s[j] &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewGroups</span><span class="params">()</span> *<span class="title">Groups</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;Groups&#123;</span><br><span class="line">sortNum: <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>),</span><br><span class="line">data:    <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]DemoModel, <span class="number">0</span>),</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *Groups)</span> <span class="title">sortKey</span><span class="params">()</span> []<span class="title">int</span></span> &#123;</span><br><span class="line">sort.Sort(a.sortNum)</span><br><span class="line"><span class="keyword">return</span> a.sortNum</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *Groups)</span> <span class="title">append</span><span class="params">(key <span class="keyword">int</span>, item DemoItemModel)</span></span> &#123;</span><br><span class="line">a.data[key] = <span class="built_in">append</span>(a.data[key], item)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewGroup</span><span class="params">()</span> <span class="title">DemoModel</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">make</span>([]DemoItemModel, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *Groups)</span> <span class="title">Add</span><span class="params">(num <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">a.sortNum = <span class="built_in">append</span>(a.sortNum, num)</span><br><span class="line">a.data[num] = NewGroup()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *Groups)</span> <span class="title">Exits</span><span class="params">(num <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> a.data[num] == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetRandomItems</span><span class="params">(a DemoModel)</span> []<span class="title">DemoItemModel</span></span> &#123;</span><br><span class="line">groups := NewGroups()</span><br><span class="line"><span class="keyword">for</span> _, item := <span class="keyword">range</span> a &#123;</span><br><span class="line">sort := item.SortValue</span><br><span class="line"><span class="keyword">if</span> !groups.Exits(sort) &#123;</span><br><span class="line">groups.Add(sort)</span><br><span class="line">&#125;</span><br><span class="line">groups.<span class="built_in">append</span>(sort, item)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> groups.Sort()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *DemoModel)</span> <span class="title">Random</span><span class="params">()</span> <span class="title">DemoModel</span></span> &#123;</span><br><span class="line">length := <span class="built_in">len</span>(*a)</span><br><span class="line">temp := <span class="built_in">make</span>([]DemoItemModel, <span class="number">0</span>)</span><br><span class="line">r := rand.New(rand.NewSource(time.Now().UnixNano()))</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">random := r.Intn(length)</span><br><span class="line">temp = <span class="built_in">append</span>(temp, (*a)[random])</span><br><span class="line">*a = <span class="built_in">append</span>((*a)[:random], (*a)[random+<span class="number">1</span>:]...)</span><br><span class="line">length = <span class="built_in">len</span>(*a)</span><br><span class="line"><span class="keyword">if</span> length &lt; <span class="number">1</span> &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">*a = temp</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> temp</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *Groups)</span> <span class="title">Sort</span><span class="params">()</span> []<span class="title">DemoItemModel</span></span> &#123;</span><br><span class="line">temp := <span class="built_in">make</span>([]DemoItemModel, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> _, item := <span class="keyword">range</span> a.sortKey() &#123;</span><br><span class="line">data := a.data[item]</span><br><span class="line">temp = <span class="built_in">append</span>(temp, data.Random()...)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> temp</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">objString := <span class="string">`[&#123;"id":1,"name":"1-1","sort_value":1&#125;,&#123;"id":2,"name":"1-2","sort_value":1&#125;,&#123;"id":3,"name":"2-1","sort_value":2&#125;,&#123;"id":4,"name":"2-2","sort_value":2&#125;,&#123;"id":5,"name":"2-3","sort_value":2&#125;,&#123;"id":6,"name":"5-1","sort_value":5&#125;]`</span></span><br><span class="line"><span class="keyword">var</span> someOne []DemoItemModel</span><br><span class="line"><span class="keyword">if</span> err := json.Unmarshal([]<span class="keyword">byte</span>(objString), &amp;someOne); err == <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">"================json str è½¬struct=="</span>)</span><br><span class="line">fmt.Println(someOne)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="number">22</span>, GetRandomItems(someOne))</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      golang ä¸€ç»´æ•°ç»„å˜äºŒç»´æ•°ç»„ï¼Œjsonæ ¹æ®sortå­—æ®µéšæœºæ’åº
    
    </summary>
    
      <category term="é»˜è®¤åˆ†ç±»" scheme="https://kitions.github.io/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/"/>
    
    
      <category term="go" scheme="https://kitions.github.io/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>gitignoreè§„åˆ™ä¸ç”Ÿæ•ˆ</title>
    <link href="https://kitions.github.io/2019/10/11/gitignore/"/>
    <id>https://kitions.github.io/2019/10/11/gitignore/</id>
    <published>2019-10-11T09:04:52.000Z</published>
    <updated>2019-10-11T09:09:55.657Z</updated>
    
    <content type="html"><![CDATA[<h1 id="gitignore"><a href="#gitignore" class="headerlink" title=".gitignore"></a>.gitignore</h1><p>è§„åˆ™ ä½œç”¨<br>/mtk è¿‡æ»¤æ•´ä¸ªæ–‡ä»¶å¤¹<br>*.zip è¿‡æ»¤æ‰€æœ‰.zipæ–‡ä»¶<br>/mtk/do.c è¿‡æ»¤æŸä¸ªå…·ä½“æ–‡ä»¶<br>!/mtk/one.txt è¿½è¸ªï¼ˆä¸è¿‡æ»¤ï¼‰æŸä¸ªå…·ä½“æ–‡ä»¶<br>æ³¨æ„ï¼šå¦‚æœä½ åˆ›å»º.gitignoreæ–‡ä»¶ä¹‹å‰å°±pushäº†æŸä¸€æ–‡ä»¶ï¼Œé‚£ä¹ˆå³ä½¿ä½ åœ¨.gitignoreæ–‡ä»¶ä¸­å†™å…¥è¿‡æ»¤è¯¥æ–‡ä»¶çš„è§„åˆ™ï¼Œè¯¥è§„åˆ™ä¹Ÿä¸ä¼šèµ·ä½œç”¨ï¼Œgitä»ç„¶ä¼šå¯¹è¯¥æ–‡ä»¶è¿›è¡Œç‰ˆæœ¬ç®¡ç†ã€‚</p><p>é…ç½®è¯­æ³•<br>ä»¥æ–œæ â€œ/â€å¼€å¤´è¡¨ç¤ºç›®å½•ï¼›<br>ä»¥æ˜Ÿå·â€œ*â€é€šé…å¤šä¸ªå­—ç¬¦ï¼›<br>ä»¥é—®å·â€œ?â€é€šé…å•ä¸ªå­—ç¬¦<br>ä»¥æ–¹æ‹¬å·â€œ[]â€åŒ…å«å•ä¸ªå­—ç¬¦çš„åŒ¹é…åˆ—è¡¨ï¼›<br>ä»¥å¹å·â€œ!â€è¡¨ç¤ºä¸å¿½ç•¥(è·Ÿè¸ª)åŒ¹é…åˆ°çš„æ–‡ä»¶æˆ–ç›®å½•ã€‚<br>æ³¨æ„ï¼š git å¯¹äº .gitignoreé…ç½®æ–‡ä»¶æ˜¯æŒ‰è¡Œä»ä¸Šåˆ°ä¸‹è¿›è¡Œè§„åˆ™åŒ¹é…çš„</p><h2 id="gitignoreè§„åˆ™ä¸ç”Ÿæ•ˆ"><a href="#gitignoreè§„åˆ™ä¸ç”Ÿæ•ˆ" class="headerlink" title=".gitignoreè§„åˆ™ä¸ç”Ÿæ•ˆ"></a>.gitignoreè§„åˆ™ä¸ç”Ÿæ•ˆ</h2><p>.gitignoreåªèƒ½å¿½ç•¥é‚£äº›åŸæ¥æ²¡æœ‰è¢«trackçš„æ–‡ä»¶ï¼Œå¦‚æœæŸäº›æ–‡ä»¶å·²ç»è¢«çº³å…¥äº†ç‰ˆæœ¬ç®¡ç†ä¸­ï¼Œåˆ™ä¿®æ”¹.gitignoreæ˜¯æ— æ•ˆçš„ã€‚</p><p>è§£å†³æ–¹æ³•å°±æ˜¯å…ˆæŠŠæœ¬åœ°ç¼“å­˜åˆ é™¤ï¼ˆæ”¹å˜æˆæœªtrackçŠ¶æ€ï¼‰ï¼Œç„¶åå†æäº¤:</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git rm -r --cached .</span><br><span class="line">git <span class="keyword">add</span> .</span><br><span class="line">git commit -m <span class="string">'update .gitignore'</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      .gitignoreè§„åˆ™ä¸ç”Ÿæ•ˆ
    
    </summary>
    
      <category term="é»˜è®¤åˆ†ç±»" scheme="https://kitions.github.io/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/"/>
    
    
  </entry>
  
  <entry>
    <title>åˆè¯†React-hooks</title>
    <link href="https://kitions.github.io/2019/06/20/React%20hooks/"/>
    <id>https://kitions.github.io/2019/06/20/React hooks/</id>
    <published>2019-06-20T03:53:52.000Z</published>
    <updated>2019-06-20T10:24:52.645Z</updated>
    
    <content type="html"><![CDATA[<h1 id="React-hooks"><a href="#React-hooks" class="headerlink" title="React hooks"></a>React hooks</h1><p><em>Hook</em> æ˜¯ React 16.8 çš„æ–°å¢ç‰¹æ€§ã€‚å®ƒå¯ä»¥è®©ä½ åœ¨ä¸ç¼–å†™ class çš„æƒ…å†µä¸‹ä½¿ç”¨ state ä»¥åŠå…¶ä»–çš„ React ç‰¹æ€§ï¼ˆç”Ÿå‘½å‘¨æœŸç­‰ç‰¹æ€§ï¼‰ã€‚</p><h2 id="0-èƒŒæ™¯"><a href="#0-èƒŒæ™¯" class="headerlink" title="0. èƒŒæ™¯"></a>0. èƒŒæ™¯</h2><p> é•¿æœŸä»¥æ¥å¾ˆå¤šäººä¼šæŠŠ <code>Stateless Component</code> å’Œ <code>Functional Component</code> æ··ä¸ºä¸€è°ˆï¼›</p><p> Hooks çš„å‡ºç°æœ¬è´¨æ˜¯æŠŠè¿™ç§<strong>é¢å‘ç”Ÿå‘½å‘¨æœŸç¼–ç¨‹</strong>å˜æˆäº†<strong>é¢å‘ä¸šåŠ¡é€»è¾‘ç¼–ç¨‹</strong>ï¼Œä½ ä¸ç”¨å†å»å…³å¿ƒæœ¬ä¸è¯¥å…³å¿ƒçš„ç”Ÿå‘½å‘¨æœŸï¼Œå†™æ³•ä¸Šå¸¦æ¥çš„ä¼˜åŒ–åªæ˜¯é¡ºå¸¦çš„ã€‚</p><h2 id="1-ä¼˜åŠ¿"><a href="#1-ä¼˜åŠ¿" class="headerlink" title="1. ä¼˜åŠ¿"></a>1. ä¼˜åŠ¿</h2><p>â€‹     å¸¦æ¥çš„å¥½å¤„ä¸ä»…æ˜¯ â€œæ›´ FPï¼Œæ›´æ–°ç²’åº¦æ›´ç»†ï¼Œä»£ç æ›´æ¸…æ™°â€</p><p>å®˜æ–¹ï¼š</p><ul><li><strong>å®Œå…¨å¯é€‰çš„ã€‚</strong> ä½ æ— éœ€é‡å†™ä»»ä½•å·²æœ‰ä»£ç å°±å¯ä»¥åœ¨ä¸€äº›ç»„ä»¶ä¸­å°è¯• Hookã€‚ä½†æ˜¯å¦‚æœä½ ä¸æƒ³ï¼Œä½ ä¸å¿…ç°åœ¨å°±å»å­¦ä¹ æˆ–ä½¿ç”¨ Hookã€‚</li><li><strong>100% å‘åå…¼å®¹çš„ã€‚</strong> Hook ä¸åŒ…å«ä»»ä½•ç ´åæ€§æ”¹åŠ¨ã€‚</li><li><strong>ç°åœ¨å¯ç”¨ã€‚</strong>  v16.8.0ä»¥åç‰ˆæœ¬éƒ½å¯ä»¥ä½¿ç”¨ã€‚</li><li><strong>æ¸è¿›ç­–ç•¥</strong>ã€‚ Hook å’Œç°æœ‰ä»£ç å¯ä»¥åŒæ—¶å·¥ä½œï¼Œä½ å¯ä»¥æ¸è¿›å¼åœ°ä½¿ç”¨ä»–ä»¬ã€‚</li></ul><p>éå®˜æ–¹ï¼š</p><ul><li>æ›´å®¹æ˜“å°†ç»„ä»¶çš„ UI ä¸çŠ¶æ€åˆ†ç¦», çŠ¶æ€ä¸ UI çš„ç•Œé™ä¼šè¶Šæ¥è¶Šæ¸…æ™°ã€‚</li><li>å¤šä¸ªçŠ¶æ€ä¸ä¼šäº§ç”ŸåµŒå¥—ï¼Œå†™æ³•è¿˜æ˜¯å¹³é“ºçš„</li><li>Hooks å¯ä»¥å¼•ç”¨å…¶ä»– Hooksã€‚</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props)&#123;</span><br><span class="line">    <span class="keyword">super</span>(props)</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      count : <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;p&gt;You clicked &#123;<span class="keyword">this</span>.state.count&#125; times&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button onClick=&#123;() =&gt; this.setState(&#123;count:this.state.count + 1&#125;)&#125;&gt;</span></span><br><span class="line"><span class="regexp">        Click me</span></span><br><span class="line"><span class="regexp">      &lt;/</span>button&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Example</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å£°æ˜ä¸€ä¸ªå« â€œcountâ€ çš„ state å˜é‡ã€‚</span></span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;p&gt;You clicked &#123;count&#125; times&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button onClick=&#123;() =&gt; setCount(count + 1)&#125;&gt;</span></span><br><span class="line"><span class="regexp">        Click me</span></span><br><span class="line"><span class="regexp">      &lt;/</span>button&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>Example</code>å˜æˆäº†ä¸€ä¸ªå‡½æ•°ï¼Œä½†è¿™ä¸ªå‡½æ•°å´æœ‰è‡ªå·±çš„çŠ¶æ€ï¼ˆcountï¼‰ï¼ŒåŒæ—¶å®ƒè¿˜å¯ä»¥æ›´æ–°è‡ªå·±çš„çŠ¶æ€ï¼ˆsetCountï¼‰ã€‚è¿™ä¸ªå‡½æ•°ä¹‹æ‰€ä»¥è¿™ä¹ˆäº†ä¸å¾—ï¼Œå°±æ˜¯å› ä¸ºå®ƒæ³¨å…¥äº†ä¸€ä¸ªhookâ€“<code>useState</code>ï¼Œå°±æ˜¯è¿™ä¸ªhookè®©æˆ‘ä»¬çš„å‡½æ•°å˜æˆäº†ä¸€ä¸ªæœ‰çŠ¶æ€çš„å‡½æ•°ã€‚</p><h2 id="2-åŠ¨æœº"><a href="#2-åŠ¨æœº" class="headerlink" title="2. åŠ¨æœº"></a>2. åŠ¨æœº</h2><h3 id="ï¼ˆ1ï¼‰æœ‰çŠ¶æ€çš„ç»„ä»¶ä¹‹é—´å¤ç”¨çŠ¶æ€é€»è¾‘å¾ˆéš¾"><a href="#ï¼ˆ1ï¼‰æœ‰çŠ¶æ€çš„ç»„ä»¶ä¹‹é—´å¤ç”¨çŠ¶æ€é€»è¾‘å¾ˆéš¾" class="headerlink" title="ï¼ˆ1ï¼‰æœ‰çŠ¶æ€çš„ç»„ä»¶ä¹‹é—´å¤ç”¨çŠ¶æ€é€»è¾‘å¾ˆéš¾"></a>ï¼ˆ1ï¼‰æœ‰çŠ¶æ€çš„ç»„ä»¶ä¹‹é—´å¤ç”¨çŠ¶æ€é€»è¾‘å¾ˆéš¾</h3><p>é—®é¢˜ï¼šReact éœ€è¦ä¸ºå…±äº«çŠ¶æ€é€»è¾‘æä¾›æ›´å¥½çš„åŸç”Ÿé€”å¾„ã€‚</p><p>è§£å†³ï¼šHook ä½¿ä½ åœ¨æ— éœ€ä¿®æ”¹ç»„ä»¶ç»“æ„çš„æƒ…å†µä¸‹å¤ç”¨çŠ¶æ€é€»è¾‘</p><p>æˆ‘ä»¬éƒ½çŸ¥é“reactçš„<strong>æ ¸å¿ƒæ€æƒ³</strong>å°±æ˜¯ï¼Œå°†ä¸€ä¸ªé¡µé¢æ‹†æˆä¸€å †ç‹¬ç«‹çš„ï¼Œå¯å¤ç”¨çš„ç»„ä»¶ï¼Œå¹¶ä¸”ç”¨è‡ªä¸Šè€Œä¸‹çš„å•å‘æ•°æ®æµçš„å½¢å¼å°†è¿™äº›ç»„ä»¶ä¸²è”èµ·æ¥ã€‚ä½†å‡å¦‚ä½ åœ¨å¤§å‹çš„å·¥ä½œé¡¹ç›®ä¸­ç”¨reactï¼Œä½ ä¼šå‘ç°ä½ çš„é¡¹ç›®ä¸­å®é™…ä¸Šå¾ˆå¤šreactç»„ä»¶å†—é•¿ä¸”éš¾ä»¥å¤ç”¨ã€‚å°¤å…¶æ˜¯é‚£äº›å†™æˆclassçš„ç»„ä»¶ï¼Œå®ƒä»¬æœ¬èº«åŒ…å«äº†çŠ¶æ€ï¼ˆstateï¼‰ï¼Œæ‰€ä»¥å¤ç”¨è¿™ç±»ç»„ä»¶å°±å˜å¾—å¾ˆéº»çƒ¦ã€‚</p><p>ä¹‹å‰ï¼Œå®˜æ–¹æ¨èæ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼š<a href="https://reactjs.org/docs/render-props.html" target="_blank" rel="noopener">æ¸²æŸ“å±æ€§ï¼ˆRender Propsï¼‰</a>å’Œ<a href="https://segmentfault.com/img/bVbjfuz" target="_blank" rel="noopener">é«˜é˜¶ç»„ä»¶ï¼ˆHigher-Order Componentsï¼‰</a>ã€‚æˆ‘ä»¬å¯ä»¥ç¨å¾®è·‘ä¸‹é¢˜ç®€å•çœ‹ä¸€ä¸‹è¿™ä¸¤ç§æ¨¡å¼ã€‚</p><h4 id="æ¸²æŸ“å±æ€§ï¼ˆRender-Propsï¼‰"><a href="#æ¸²æŸ“å±æ€§ï¼ˆRender-Propsï¼‰" class="headerlink" title="- æ¸²æŸ“å±æ€§ï¼ˆRender Propsï¼‰"></a>- æ¸²æŸ“å±æ€§ï¼ˆRender Propsï¼‰</h4><p>æ¸²æŸ“å±æ€§æŒ‡çš„æ˜¯ä½¿ç”¨ä¸€ä¸ªå€¼ä¸ºå‡½æ•°çš„propæ¥ä¼ é€’éœ€è¦åŠ¨æ€æ¸²æŸ“çš„nodesæˆ–ç»„ä»¶ã€‚å¦‚ä¸‹é¢çš„ä»£ç å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„<code>DataProvider</code>ç»„ä»¶åŒ…å«äº†æ‰€æœ‰è·ŸçŠ¶æ€ç›¸å…³çš„ä»£ç ï¼Œè€Œ<code>Cat</code>ç»„ä»¶åˆ™å¯ä»¥æ˜¯ä¸€ä¸ªå•çº¯çš„å±•ç¤ºå‹ç»„ä»¶ï¼Œè¿™æ ·ä¸€æ¥<code>DataProvider</code>å°±å¯ä»¥å•ç‹¬å¤ç”¨äº†ã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Cat <span class="keyword">from</span> <span class="string">'components/cat'</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataProvider</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123; <span class="attr">target</span>: <span class="string">'Zac'</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &#123;<span class="keyword">this</span>.props.render(<span class="keyword">this</span>.state)&#125;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;DataProvider render=&#123;data =&gt; (</span></span><br><span class="line"><span class="regexp">  &lt;Cat target=&#123;data.target&#125; /</span>&gt;</span><br><span class="line">)&#125;/&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸Šä¸‹ç­‰åŒ</span></span><br><span class="line">&lt;DataProvider&gt;</span><br><span class="line">  &#123;data =&gt; (</span><br><span class="line">    &lt;Cat target=&#123;data.target&#125; /&gt;</span><br><span class="line">  )&#125;</span><br><span class="line">&lt;<span class="regexp">/DataProvider&gt;</span></span><br></pre></td></tr></table></figure><h4 id="é«˜é˜¶ç»„ä»¶"><a href="#é«˜é˜¶ç»„ä»¶" class="headerlink" title="- é«˜é˜¶ç»„ä»¶"></a>- é«˜é˜¶ç»„ä»¶</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> withUser = <span class="function"><span class="params">WrappedComponent</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> user = sessionStorage.getItem(<span class="string">"user"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">props</span> =&gt;</span> &lt;WrappedComponent user=&#123;user&#125; &#123;...props&#125; /&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UserPage = <span class="function"><span class="params">props</span> =&gt;</span> (</span><br><span class="line">  &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"user-container"</span>&gt;</span><br><span class="line">    &lt;p&gt;My name is &#123;props.user&#125;!<span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">  &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default withUser(UserPage);</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šè¿™ä¸¤ç§æ¨¡å¼çœ‹ä¸Šå»éƒ½æŒºä¸é”™çš„ï¼Œå¾ˆå¤šåº“ä¹Ÿè¿ç”¨äº†è¿™ç§æ¨¡å¼ï¼Œä½†æˆ‘ä»¬ä»”ç»†çœ‹è¿™ä¸¤ç§æ¨¡å¼ï¼Œä¼šå‘ç°å®ƒä»¬ä¼šå¢åŠ æˆ‘ä»¬ä»£ç çš„å±‚çº§å…³ç³»ï¼Œè¿™æ—¶å€™å†å›è¿‡å¤´çœ‹hooksä¾‹å­ï¼Œæ˜¯ä¸æ˜¯ç®€æ´å¤šäº†ï¼Œæ²¡æœ‰å¤šä½™çš„å±‚çº§åµŒå¥—</p><p><img src="https://img.alicdn.com/tfs/TB1oipbryrpK1RjSZFhXXXSdXXa-2048-860.jpg" alt="img"></p><h3 id="ï¼ˆ2ï¼‰å¤æ‚ç»„ä»¶å˜å¾—éš¾ä»¥ç†è§£"><a href="#ï¼ˆ2ï¼‰å¤æ‚ç»„ä»¶å˜å¾—éš¾ä»¥ç†è§£" class="headerlink" title="ï¼ˆ2ï¼‰å¤æ‚ç»„ä»¶å˜å¾—éš¾ä»¥ç†è§£"></a>ï¼ˆ2ï¼‰å¤æ‚ç»„ä»¶å˜å¾—éš¾ä»¥ç†è§£</h3><p>é—®é¢˜ï¼šç»„ä»¶èµ·åˆå¾ˆç®€å•ï¼Œä½†æ˜¯é€æ¸ä¼šè¢«çŠ¶æ€é€»è¾‘å’Œå‰¯ä½œç”¨å……æ–¥ã€‚ç›¸äº’å…³è”ä¸”éœ€è¦å¯¹ç…§ä¿®æ”¹çš„ä»£ç è¢«è¿›è¡Œäº†æ‹†åˆ†ï¼Œè€Œå®Œå…¨ä¸ç›¸å…³çš„ä»£ç å´åœ¨åŒä¸€ä¸ªæ–¹æ³•ä¸­ç»„åˆåœ¨ä¸€èµ·</p><p>è§£å†³ï¼šHook å°†ç»„ä»¶ä¸­ç›¸äº’å…³è”çš„éƒ¨åˆ†æ‹†åˆ†æˆæ›´å°çš„å‡½æ•°ï¼ˆæ¯”å¦‚è®¾ç½®è®¢é˜…æˆ–è¯·æ±‚æ•°æ®ï¼‰</p><h3 id="ï¼ˆ3ï¼‰éš¾ä»¥ç†è§£çš„-class"><a href="#ï¼ˆ3ï¼‰éš¾ä»¥ç†è§£çš„-class" class="headerlink" title="ï¼ˆ3ï¼‰éš¾ä»¥ç†è§£çš„ class"></a>ï¼ˆ3ï¼‰éš¾ä»¥ç†è§£çš„ class</h3><p>é—®é¢˜ï¼šjsçš„<code>this</code> çš„å·¥ä½œæ–¹å¼ï¼›ç»‘å®šäº‹ä»¶å¤„ç†å™¨ï¼›å¯¹äºå‡½æ•°ç»„ä»¶ä¸ class ç»„ä»¶çš„å·®å¼‚ä¹Ÿå­˜åœ¨åˆ†æ­§</p><p>è§£å†³ï¼šHook ä½¿ä½ åœ¨é class çš„æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨æ›´å¤šçš„ React ç‰¹æ€§ï¼ŒHook åˆ™æ‹¥æŠ±äº†å‡½æ•°</p><p>æˆ‘ä»¬ç»å¸¸åœ¨å†™ä¸€ä¸ªç»„ä»¶çš„æ—¶å€™ï¼ŒæŠŠç»„ä»¶å†™æˆæ— çŠ¶æ€ç»„ä»¶çš„å½¢å¼ï¼Œè¿™æ ·æ›´æ–¹ä¾¿å¤ç”¨ï¼Œç‹¬ç«‹å•æ‰€ï¼Œç„¶è€Œå¾ˆå¤šæ—¶å€™ï¼Œç”¨SFC å†™äº†ä¸€ä¸ªç®€æ´å®Œç¾çš„æ— çŠ¶æ€ç»„ä»¶ï¼Œåæ¥å› ä¸ºéœ€æ±‚å˜åŠ¨ï¼Œå¿…é¡»å¾—æœ‰çŠ¶æ€ï¼Œåˆå¾—å¾ˆéº»çƒ¦çš„æ”¹æˆclassç»„ä»¶ã€‚å°±å¾ˆçƒ¦ï¼Œæœ‰äº†hookï¼Œå°±å¯ä»¥é¿å…è¿™æ ·çš„é—®é¢˜</p><h3 id="ï¼ˆ4ï¼‰ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°é‡Œçš„é€»è¾‘å¤ªä¹±ï¼"><a href="#ï¼ˆ4ï¼‰ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°é‡Œçš„é€»è¾‘å¤ªä¹±ï¼" class="headerlink" title="ï¼ˆ4ï¼‰ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°é‡Œçš„é€»è¾‘å¤ªä¹±ï¼"></a>ï¼ˆ4ï¼‰ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°é‡Œçš„é€»è¾‘å¤ªä¹±ï¼</h3><p>æˆ‘ä»¬é€šå¸¸å¸Œæœ›ä¸€ä¸ªå‡½æ•°åªåšä¸€ä»¶äº‹æƒ…ï¼Œä½†æˆ‘ä»¬çš„ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°é‡Œé€šå¸¸åŒæ—¶åšäº†å¾ˆå¤šäº‹æƒ…ã€‚æ¯”å¦‚æˆ‘ä»¬éœ€è¦åœ¨<code>componentDidMount</code>ä¸­å‘èµ·ajaxè¯·æ±‚è·å–æ•°æ®ï¼Œç»‘å®šä¸€äº›äº‹ä»¶ç›‘å¬ç­‰ç­‰ã€‚åŒæ—¶ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬è¿˜éœ€è¦åœ¨<code>componentDidUpdate</code>åšä¸€éåŒæ ·çš„äº‹æƒ…ã€‚å½“é¡¹ç›®å˜å¤æ‚åï¼Œè¿™ä¸€å—çš„ä»£ç ä¹Ÿå˜å¾—ä¸é‚£ä¹ˆç›´è§‚ã€‚</p><h2 id="3-useState"><a href="#3-useState" class="headerlink" title="3. useState"></a>3. useState</h2><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useState &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Example</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br></pre></td></tr></table></figure><p><code>useState</code>æ˜¯reactè‡ªå¸¦çš„ä¸€ä¸ªhookå‡½æ•°ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯ç”¨æ¥å£°æ˜çŠ¶æ€å˜é‡ã€‚<code>useState</code>è¿™ä¸ªå‡½æ•°æ¥æ”¶çš„å‚æ•°æ˜¯æˆ‘ä»¬çš„çŠ¶æ€åˆå§‹å€¼ï¼ˆinitial stateï¼‰ï¼Œå®ƒè¿”å›äº†ä¸€ä¸ªæ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„çš„ç¬¬<code>[0]</code>é¡¹æ˜¯å½“å‰å½“å‰çš„çŠ¶æ€å€¼ï¼Œç¬¬<code>[1]</code>é¡¹æ˜¯å¯ä»¥æ”¹å˜çŠ¶æ€å€¼çš„æ–¹æ³•å‡½æ•°ã€‚</p><h3 id="è¯»å–çŠ¶æ€å€¼"><a href="#è¯»å–çŠ¶æ€å€¼" class="headerlink" title="è¯»å–çŠ¶æ€å€¼"></a>è¯»å–çŠ¶æ€å€¼</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;You clicked &#123;count&#125; times&lt;<span class="regexp">/p&gt;</span></span><br></pre></td></tr></table></figure><h3 id="æ›´æ–°çŠ¶æ€"><a href="#æ›´æ–°çŠ¶æ€" class="headerlink" title="æ›´æ–°çŠ¶æ€"></a>æ›´æ–°çŠ¶æ€</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;button onClick=&#123;() =&gt; setCount(count + <span class="number">1</span>)&#125;&gt;</span><br><span class="line">  Click me</span><br><span class="line">&lt;<span class="regexp">/button&gt;</span></span><br></pre></td></tr></table></figure><h3 id="å¤šä¸ªçŠ¶æ€å€¼"><a href="#å¤šä¸ªçŠ¶æ€å€¼" class="headerlink" title="å¤šä¸ªçŠ¶æ€å€¼"></a>å¤šä¸ªçŠ¶æ€å€¼</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ExampleWithManyStates</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [age, setAge] = useState(<span class="number">42</span>);</span><br><span class="line">  <span class="keyword">const</span> [fruit, setFruit] = useState(<span class="string">'banana'</span>);</span><br><span class="line">  <span class="keyword">const</span> [todos, setTodos] = useState([&#123; <span class="attr">text</span>: <span class="string">'Learn Hooks'</span> &#125;]);</span><br></pre></td></tr></table></figure><p>ä»ExampleWithManyStateså‡½æ•°æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒuseStateæ— è®ºè°ƒç”¨å¤šå°‘æ¬¡ï¼Œç›¸äº’ä¹‹é—´æ˜¯ç‹¬ç«‹çš„</p><p>ï¼ˆ<a href="https://zh-hans.reactjs.org/docs/hooks-intro.html#gradual-adoption-strategy" target="_blank" rel="noopener">ä¸æ¨è</a>æŠŠä½ å·²æœ‰çš„ç»„ä»¶å…¨éƒ¨é‡å†™ï¼Œä½†æ˜¯ä½ å¯ä»¥åœ¨æ–°ç»„ä»¶é‡Œå¼€å§‹ä½¿ç”¨ Hookã€‚ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">import React, &#123; useState, useEffect &#125; from &apos;react&apos;;</span><br><span class="line"></span><br><span class="line">function Example() &#123;</span><br><span class="line">  const [count, setCount] = useState(0);</span><br><span class="line"></span><br><span class="line">  // ç›¸å½“äº componentDidMount å’Œ componentDidUpdate:</span><br><span class="line">  useEffect(() =&gt; &#123;</span><br><span class="line">    // ä½¿ç”¨æµè§ˆå™¨çš„ API æ›´æ–°é¡µé¢æ ‡é¢˜</span><br><span class="line">    document.title = `You clicked $&#123;count&#125; times`;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  return (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;p&gt;You clicked &#123;count&#125; times&lt;/p&gt;</span><br><span class="line">      &lt;button onClick=&#123;() =&gt; setCount(count + 1)&#125;&gt;</span><br><span class="line">        Click me</span><br><span class="line">      &lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-useEffect"><a href="#4-useEffect" class="headerlink" title="4. useEffect"></a>4. useEffect</h2><p>å¯ä»¥æŠŠ <code>useEffect</code> Hook çœ‹åš <code>componentDidMount</code>ï¼Œ<code>componentDidUpdate</code> å’Œ <code>componentWillUnmount</code> è¿™ä¸‰ä¸ªå‡½æ•°çš„ç»„åˆã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒåœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“ä¹‹å<em>å’Œ</em> æ¯æ¬¡æ›´æ–°ä¹‹åéƒ½ä¼šæ‰§è¡Œã€‚</p><h3 id="Class"><a href="#Class" class="headerlink" title="Class"></a>Class</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">class Example extends React.Component &#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    super(props);</span><br><span class="line">    this.state = &#123;</span><br><span class="line">      count: 0</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    document.title = `You clicked $&#123;this.state.count&#125; times`;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidUpdate() &#123;</span><br><span class="line">    document.title = `You clicked $&#123;this.state.count&#125; times`;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;p&gt;You clicked &#123;this.state.count&#125; times&lt;/p&gt;</span><br><span class="line">        &lt;button onClick=&#123;() =&gt; this.setState(&#123; count: this.state.count + 1 &#125;)&#125;&gt;</span><br><span class="line">          Click me</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="hook"><a href="#hook" class="headerlink" title="hook"></a>hook</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">import &#123; useState, useEffect &#125; from &apos;react&apos;;</span><br><span class="line"></span><br><span class="line">function Example() &#123;</span><br><span class="line">  const [count, setCount] = useState(0);</span><br><span class="line"></span><br><span class="line">  // ç±»ä¼¼äºcomponentDidMount å’Œ componentDidUpdate:</span><br><span class="line">  useEffect(() =&gt; &#123;</span><br><span class="line">    // æ›´æ–°æ–‡æ¡£çš„æ ‡é¢˜</span><br><span class="line">    document.title = `You clicked $&#123;count&#125; times`;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  return (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;p&gt;You clicked &#123;count&#125; times&lt;/p&gt;</span><br><span class="line">      &lt;button onClick=&#123;() =&gt; setCount(count + 1)&#125;&gt;</span><br><span class="line">        Click me</span><br><span class="line">      &lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>effect æœ‰å¯é€‰çš„æ¸…é™¤æœºåˆ¶ã€‚æ¯ä¸ª effect éƒ½å¯ä»¥è¿”å›ä¸€ä¸ªæ¸…é™¤å‡½æ•°ã€‚å¦‚æ­¤å¯ä»¥å°†æ·»åŠ å’Œç§»é™¤è®¢é˜…çš„é€»è¾‘æ”¾åœ¨ä¸€èµ·ã€‚å®ƒä»¬éƒ½å±äº effect çš„ä¸€éƒ¨åˆ†ã€‚</p><h3 id="React-ä½•æ—¶æ¸…é™¤-effectï¼Ÿ"><a href="#React-ä½•æ—¶æ¸…é™¤-effectï¼Ÿ" class="headerlink" title="React ä½•æ—¶æ¸…é™¤ effectï¼Ÿ"></a>React ä½•æ—¶æ¸…é™¤ effectï¼Ÿ</h3><p> React ä¼šåœ¨ç»„ä»¶å¸è½½çš„æ—¶å€™æ‰§è¡Œæ¸…é™¤æ“ä½œã€‚effect åœ¨æ¯æ¬¡æ¸²æŸ“çš„æ—¶å€™éƒ½ä¼šæ‰§è¡Œã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ React <em>ä¼š</em>åœ¨æ‰§è¡Œå½“å‰ effect ä¹‹å‰å¯¹ä¸Šä¸€ä¸ª effect è¿›è¡Œæ¸…é™¤ã€‚ç¨å<a href="https://zh-hans.reactjs.org/docs/hooks-effect.html#explanation-why-effects-run-on-each-update" target="_blank" rel="noopener">ä¸ºä»€ä¹ˆè¿™å°†åŠ©äºé¿å… bug</a>ä»¥åŠ<a href="https://zh-hans.reactjs.org/docs/hooks-effect.html#tip-optimizing-performance-by-skipping-effects" target="_blank" rel="noopener">å¦‚ä½•åœ¨é‡åˆ°æ€§èƒ½é—®é¢˜æ—¶è·³è¿‡æ­¤è¡Œä¸º</a>ã€‚</p><blockquote><p>Tips</p><p>ä¸ <code>componentDidMount</code> æˆ– <code>componentDidUpdate</code> ä¸åŒï¼Œä½¿ç”¨ <code>useEffect</code> è°ƒåº¦çš„ effect ä¸ä¼šé˜»å¡æµè§ˆå™¨æ›´æ–°å±å¹•ï¼Œè¿™è®©ä½ çš„åº”ç”¨çœ‹èµ·æ¥å“åº”æ›´å¿«ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œeffect ä¸éœ€è¦åŒæ­¥åœ°æ‰§è¡Œã€‚åœ¨ä¸ªåˆ«æƒ…å†µä¸‹ï¼ˆä¾‹å¦‚æµ‹é‡å¸ƒå±€ï¼‰ï¼Œæœ‰å•ç‹¬çš„ <a href="https://zh-hans.reactjs.org/docs/hooks-reference.html#uselayouteffect" target="_blank" rel="noopener"><code>useLayoutEffect</code></a> Hook ä¾›ä½ ä½¿ç”¨ï¼Œå…¶ API ä¸ <code>useEffect</code> ç›¸åŒã€‚</p></blockquote><h3 id="é€šè¿‡è·³è¿‡-Effect-è¿›è¡Œæ€§èƒ½ä¼˜åŒ–"><a href="#é€šè¿‡è·³è¿‡-Effect-è¿›è¡Œæ€§èƒ½ä¼˜åŒ–" class="headerlink" title="é€šè¿‡è·³è¿‡ Effect è¿›è¡Œæ€§èƒ½ä¼˜åŒ–"></a>é€šè¿‡è·³è¿‡ Effect è¿›è¡Œæ€§èƒ½ä¼˜åŒ–</h3><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ¯æ¬¡æ¸²æŸ“åéƒ½æ‰§è¡Œæ¸…ç†æˆ–è€…æ‰§è¡Œ effect å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚åœ¨ class ç»„ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ <code>componentDidUpdate</code> ä¸­æ·»åŠ å¯¹ <code>prevProps</code> æˆ– <code>prevState</code> çš„æ¯”è¾ƒé€»è¾‘è§£å†³ï¼š</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">componentDidUpdate(prevProps, prevState) &#123;</span><br><span class="line">  <span class="keyword">if</span> (prevState.count !== <span class="keyword">this</span>.state.count) &#123;</span><br><span class="line">    <span class="built_in">document</span>.title = <span class="string">`You clicked <span class="subst">$&#123;<span class="keyword">this</span>.state.count&#125;</span> times`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹        è¿™æ˜¯å¾ˆå¸¸è§çš„éœ€æ±‚ï¼Œæ‰€ä»¥å®ƒè¢«å†…ç½®åˆ°äº† <code>useEffect</code> çš„ Hook API ä¸­ã€‚å¦‚æœæŸäº›ç‰¹å®šå€¼åœ¨ä¸¤æ¬¡é‡æ¸²æŸ“ä¹‹é—´æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä½ å¯ä»¥é€šçŸ¥ React <strong>è·³è¿‡ </strong>å¯¹ effect çš„è°ƒç”¨ï¼Œåªè¦ä¼ é€’æ•°ç»„ä½œä¸º <code>useEffect</code> çš„ç¬¬äºŒä¸ªå¯é€‰å‚æ•°å³å¯ï¼š</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">document</span>.title = <span class="string">`You clicked <span class="subst">$&#123;count&#125;</span> times`</span>;</span><br><span class="line">&#125;, [count]); <span class="comment">// ä»…åœ¨ count æ›´æ”¹æ—¶æ›´æ–°</span></span><br></pre></td></tr></table></figure><p>â€‹        è¿™ä¸ªå‚æ•°æ˜¯ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿå¦‚æœ <code>count</code>çš„å€¼æ˜¯ <code>5</code>ï¼Œè€Œä¸”æˆ‘ä»¬çš„ç»„ä»¶é‡æ¸²æŸ“çš„æ—¶å€™ <code>count</code> è¿˜æ˜¯ç­‰äº <code>5</code>ï¼ŒReact å°†å¯¹å‰ä¸€æ¬¡æ¸²æŸ“çš„ <code>[5]</code>å’Œåä¸€æ¬¡æ¸²æŸ“çš„ <code>[5]</code> è¿›è¡Œæ¯”è¾ƒã€‚å› ä¸ºæ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½æ˜¯ç›¸ç­‰çš„(<code>5 === 5</code>)ï¼ŒReact ä¼šè·³è¿‡è¿™ä¸ª effectï¼Œè¿™å°±å®ç°äº†æ€§èƒ½çš„ä¼˜åŒ–ã€‚</p><blockquote><p>å¦‚æœæƒ³æ‰§è¡Œåªè¿è¡Œä¸€æ¬¡çš„ effectï¼ˆä»…åœ¨ç»„ä»¶æŒ‚è½½å’Œå¸è½½æ—¶æ‰§è¡Œï¼‰ï¼Œå¯ä»¥ä¼ é€’ä¸€ä¸ªç©ºæ•°ç»„ï¼ˆ<code>[]</code>ï¼‰ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ã€‚è¿™å°±å‘Šè¯‰ React ä½ çš„ effect ä¸ä¾èµ–äº props æˆ– state ä¸­çš„ä»»ä½•å€¼ï¼Œæ‰€ä»¥å®ƒæ°¸è¿œéƒ½ä¸éœ€è¦é‡å¤æ‰§è¡Œ</p></blockquote><h2 id="5-è¿˜æœ‰å“ªäº›è‡ªå¸¦çš„Effect-Hooks"><a href="#5-è¿˜æœ‰å“ªäº›è‡ªå¸¦çš„Effect-Hooks" class="headerlink" title="5. è¿˜æœ‰å“ªäº›è‡ªå¸¦çš„Effect Hooks?"></a>5. è¿˜æœ‰å“ªäº›è‡ªå¸¦çš„Effect Hooks?</h2><p>é™¤äº†ä¸Šé¢ä»‹ç»çš„useStateå’ŒuseEffectï¼Œreactè¿˜ç»™æˆ‘ä»¬æä¾›æ¥å¾ˆå¤šæœ‰ç”¨çš„hooksï¼š</p><p>useContext<br>useReducer<br>useCallback<br>useMemo<br>useRef<br>useImperativeMethods<br>useMutationEffect<br>useLayoutEffect</p><p>æˆ‘ä¸å†ä¸€ä¸€ä»‹ç»ï¼Œå¤§å®¶è‡ªè¡Œå»æŸ¥é˜…å®˜æ–¹æ–‡æ¡£ã€‚</p><h2 id="6-è‡ªå®šä¹‰hook"><a href="#6-è‡ªå®šä¹‰hook" class="headerlink" title="6. è‡ªå®šä¹‰hook"></a>6. è‡ªå®šä¹‰hook</h2><p>å½“æˆ‘ä»¬æƒ³åœ¨ä¸¤ä¸ªå‡½æ•°ä¹‹é—´å…±äº«é€»è¾‘æ—¶ï¼Œæˆ‘ä»¬ä¼šæŠŠå®ƒæå–åˆ°ç¬¬ä¸‰ä¸ªå‡½æ•°ä¸­ã€‚è€Œç»„ä»¶å’Œ Hook éƒ½æ˜¯å‡½æ•°ï¼Œæ‰€ä»¥ä¹ŸåŒæ ·é€‚ç”¨è¿™ç§æ–¹å¼ã€‚</p><p><strong>è‡ªå®šä¹‰ Hook æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå…¶åç§°ä»¥ â€œuseâ€ å¼€å¤´ï¼Œå‡½æ•°å†…éƒ¨å¯ä»¥è°ƒç”¨å…¶ä»–çš„ Hookã€‚</strong> </p><blockquote><p>Hook å‡½æ•°å¿…é¡»ä»¥ â€œuseâ€ å‘½åå¼€å¤´ï¼Œè¿™ç§å£°æ˜ç›®å‰æ˜¯é€šè¿‡å¾ˆå¼±çš„ <code>use</code> å‰ç¼€æ ‡è¯†çš„ï¼ˆä½†æ˜¯è®¾è®¡ä¸Šä¼šç®€æ´å¾ˆå¤šï¼‰ï¼Œä¸ºäº†ä¸å¼„é”™æ¯ä¸ªç›’å­å’ŒçŠ¶æ€çš„å¯¹åº”å…³ç³»ï¼Œä¹¦å†™çš„æ—¶å€™ Hooks éœ€è¦ <code>use</code> å¼€å¤´ä¸”æ”¾åœ¨é¡¶å±‚ä½œç”¨åŸŸï¼Œå³ä¸å¯ä»¥åŒ…è£¹ <code>if/switch/when/try</code> ç­‰ã€‚å¼•å…¥äº†å®˜æ–¹çš„ <a href="https://link.juejin.im/?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Feslint-plugin-react-hooks" target="_blank" rel="noopener">eslint-plugin-react-hooks</a>  å°±ä¸ç”¨æ‹…å¿ƒä¼šå¼„é”™äº†ã€‚</p></blockquote><p>ä¸ºä»€ä¹ˆä¸èƒ½ç”¨ condition åŒ…è£¹ useHook è¯­å¥ï¼Œè¯¦æƒ…å¯ä»¥è§ <a href="https://link.juejin.im/?target=https%3A%2F%2Freactjs.org%2Fdocs%2Fhooks-rules.html%23explanation" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹ã€‚</p><p>React Hooks å¹¶ä¸æ˜¯é€šè¿‡ Proxy æˆ–è€… getters å®ç°çš„ï¼ˆå…·ä½“å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç«  <a href="https://medium.com/@ryardley/react-hooks-not-magic-just-arrays-cd4f1857236e" target="_blank" rel="noopener">React hooks: not magic, just arrays</a>ï¼‰ï¼Œè€Œæ˜¯é€šè¿‡æ•°ç»„å®ç°çš„ï¼Œæ¯æ¬¡ <code>useState</code> éƒ½ä¼šæ”¹å˜ä¸‹æ ‡ï¼Œå¦‚æœ <code>useState</code> è¢«åŒ…è£¹åœ¨ condition ä¸­ï¼Œé‚£æ¯æ¬¡æ‰§è¡Œçš„ä¸‹æ ‡å°±å¯èƒ½å¯¹ä¸ä¸Šï¼Œå¯¼è‡´ <code>useState</code> å¯¼å‡ºçš„ <code>setter</code> æ›´æ–°é”™æ•°æ®ã€‚</p><h2 id="7-æ€»ç»“"><a href="#7-æ€»ç»“" class="headerlink" title="7. æ€»ç»“"></a>7. æ€»ç»“</h2><ul><li>Hooksæœ¬è´¨æ˜¯æŠŠ<strong>é¢å‘ç”Ÿå‘½å‘¨æœŸç¨‹å¼è®¾è®¡</strong>å˜æˆäº†<strong>é¢å‘ä¸šåŠ¡é€»è¾‘ç¨‹å¼è®¾è®¡</strong>ï¼›</li><li>Hooks æ˜¯React çš„æœªæ¥ï¼Œä½†è¿˜æ˜¯æ— æ³•å®Œå…¨æ›¿ä»£åŸå§‹çš„Classã€‚</li></ul><h2 id="Example-1"><a href="#Example-1" class="headerlink" title="Example 1:"></a>Example 1:</h2><p>æˆ‘ä»¬å…ˆå‡æƒ³ä¸€ä¸ªå¸¸è§çš„éœ€æ±‚ï¼Œä¸€ä¸ª Modal é‡Œéœ€è¦å±•ç¤ºä¸€äº›ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯éœ€è¦é€šè¿‡ API è·å–ä¸”è·Ÿ Modal å¼ºä¸šåŠ¡ç›¸å…³, Modal æ‰“å¼€çš„æ—¶å€™æ‰è¿›è¡Œæ•°æ®è·å–ï¼š</p><p><a href="https://codepen.io/int64ago/pen/qQoJOX?editors=0010" target="_blank" rel="noopener">ä»£ç </a></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomUserModal</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      user: &#123;&#125;,</span><br><span class="line">      loading: <span class="literal">false</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">this</span>.fetchData = <span class="keyword">this</span>.fetchData.bind(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.visible) &#123;</span><br><span class="line">      <span class="keyword">this</span>.fetchData();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidUpdate(prevProps) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!prevProps.visible &amp;&amp; <span class="keyword">this</span>.props.visible) &#123;</span><br><span class="line">      <span class="keyword">this</span>.fetchData();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fetchData() &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">loading</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    fetch(<span class="string">'https://randomuser.me/api/'</span>)</span><br><span class="line">      .then(<span class="function"><span class="params">res</span> =&gt;</span> res.json())</span><br><span class="line">      .then(<span class="function"><span class="params">json</span> =&gt;</span> <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">        user: json.results[<span class="number">0</span>],</span><br><span class="line">        loading: <span class="literal">false</span>,</span><br><span class="line">      &#125;));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">this</span>.state.user;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;ReactModal</span><br><span class="line">        isOpen=&#123;<span class="keyword">this</span>.props.visible&#125;</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="keyword">this</span>.props.handleCloseModal&#125;&gt;Close Modal&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">        &#123;this.state.loading ?</span></span><br><span class="line"><span class="regexp">          &lt;div&gt;loading...&lt;/</span>div&gt;</span><br><span class="line">          :</span><br><span class="line">          &lt;ul&gt;</span><br><span class="line">            &lt;li&gt;Name: &#123;<span class="string">`<span class="subst">$&#123;(user.name || &#123;&#125;</span>).first&#125; <span class="subst">$&#123;(user.name || &#123;&#125;</span>).last&#125;`</span>&#125;&lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">            &lt;li&gt;Gender: &#123;user.gender&#125;&lt;/</span>li&gt;</span><br><span class="line">            &lt;li&gt;Phone: &#123;user.phone&#125;&lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">          &lt;/u</span>l&gt;</span><br><span class="line">        &#125;</span><br><span class="line">      &lt;<span class="regexp">/ReactModal&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>ä¸ºäº†å®ç°åœ¨ Modal æ‰“å¼€çš„æ—¶å€™æ‰è¿›è¡Œæ•°æ®è·å–ï¼Œæˆ‘ä»¬éœ€è¦åŒæ—¶åœ¨ <code>componentDidMount</code> å’Œ <code>componentDidUpdate</code> ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸé‡Œå®ç°æ•°æ®è·å–çš„é€»è¾‘ï¼Œè€Œä¸” <code>constructor</code> é‡Œçš„ä¸€äº›åˆå§‹åŒ–æ“ä½œä¹Ÿå°‘ä¸äº†ã€‚</p><p>å…¶å®æˆ‘ä»¬çš„è¦æ±‚å¾ˆç®€å•ï¼šåœ¨åˆé€‚çš„æ—¶å€™é€šè¿‡ API è·å–æ–°çš„ä¿¡æ¯ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æŠ½è±¡å‡ºæ¥çš„ä¸€ä¸ª<strong>ä¸šåŠ¡é€»è¾‘</strong>ï¼Œä¸ºäº†è¿™ä¸ªä¸šåŠ¡é€»è¾‘èƒ½åœ¨ React é‡Œæ­£ç¡®å·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶<strong>æŒ‰ç…§ React ç»„ä»¶ç”Ÿå‘½å‘¨æœŸè¿›è¡Œæ‹†è§£</strong>ã€‚è¿™ç§æ‹†è§£é™¤äº†<strong>ä»£ç å†—ä½™</strong>ï¼Œè¿˜<strong>å¾ˆéš¾å¤ç”¨</strong>ã€‚</p><p><a href="https://codepen.io/int64ago/pen/eQMLNX?editors=0010" target="_blank" rel="noopener">hooksçš„æ”¹é€ å</a>ï¼š</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">RandomUserModal</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = React.useState(&#123;&#125;);</span><br><span class="line">  <span class="keyword">const</span> [loading, setLoading] = React.useState(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  React.useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!props.visible) <span class="keyword">return</span>;</span><br><span class="line">    setLoading(<span class="literal">true</span>);</span><br><span class="line">    fetch(<span class="string">'https://randomuser.me/api/'</span>).then(<span class="function"><span class="params">res</span> =&gt;</span> res.json()).then(<span class="function"><span class="params">json</span> =&gt;</span> &#123;</span><br><span class="line">      setUser(json.results[<span class="number">0</span>]);</span><br><span class="line">      setLoading(<span class="literal">false</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;, [props.visible]);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="comment">// View éƒ¨åˆ†å‡ ä¹ä¸ä¸Šé¢ç›¸åŒ</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾åœ°å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æŠŠ Class å½¢å¼å˜æˆäº† Function å½¢å¼ï¼Œä½¿ç”¨äº†ä¸¤ä¸ª State Hook è¿›è¡Œæ•°æ®ç®¡ç†ï¼ˆç±»æ¯” <code>constructor</code>ï¼‰ï¼Œä¹‹å‰ <code>componentDidMount</code> å’Œ <code>componentDidUpdate</code> ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸé‡Œå¹²çš„äº‹æˆ‘ä»¬ç›´æ¥åœ¨ä¸€ä¸ª Effect Hook é‡Œåšäº†ã€‚åšäº†è¿™äº›ï¼Œæœ€å¤§çš„ä¼˜åŠ¿æ˜¯<strong>ä»£ç ç²¾ç®€</strong>ï¼Œä¸šåŠ¡é€»è¾‘å˜çš„ç´§å‡‘ï¼Œä»£ç è¡Œæ•°ä¹Ÿä» 50+ è¡Œå‡å°‘åˆ° 30+ è¡Œã€‚</p><p>Hooks çš„å¼ºå¤§ä¹‹å¤„è¿˜ä¸ä»…ä»…æ˜¯è¿™ä¸ªï¼Œæœ€é‡è¦çš„æ˜¯è¿™äº›ä¸šåŠ¡é€»è¾‘å¯ä»¥éšæ„åœ°çš„çš„æŠ½ç¦»å‡ºå»ï¼Œè·Ÿæ™®é€šçš„å‡½æ•°æ²¡ä»€ä¹ˆåŒºåˆ«ï¼ˆä»…ä»…æ˜¯çœ‹èµ·æ¥æ²¡åŒºåˆ«ï¼‰ï¼Œäºæ˜¯å°±å˜æˆäº†å¯ä»¥<strong>å¤ç”¨</strong>çš„è‡ªå®šä¹‰ Hookã€‚å…·ä½“å¯ä»¥çœ‹ä¸‹é¢çš„è¿›ä¸€æ­¥æ”¹é€ ï¼š</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è‡ªå®šä¹‰ Hook</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useFetchUser</span>(<span class="params">visible</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = React.useState(&#123;&#125;);</span><br><span class="line">  <span class="keyword">const</span> [loading, setLoading] = React.useState(<span class="literal">false</span>);</span><br><span class="line">  </span><br><span class="line">  React.useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!visible) <span class="keyword">return</span>;</span><br><span class="line">    setLoading(<span class="literal">true</span>);</span><br><span class="line">    fetch(<span class="string">'https://randomuser.me/api/'</span>).then(<span class="function"><span class="params">res</span> =&gt;</span> res.json()).then(<span class="function"><span class="params">json</span> =&gt;</span> &#123;</span><br><span class="line">      setUser(json.results[<span class="number">0</span>]);</span><br><span class="line">      setLoading(<span class="literal">false</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;, [visible]);</span><br><span class="line">  <span class="keyword">return</span> &#123; user, loading &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">RandomUserModal</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; user, loading &#125; = useFetchUser(props.visible);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="comment">// ä¸ä¸Šé¢ç›¸åŒ</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>useFetchUser</code> ä¸ºè‡ªå®šä¹‰ Hookï¼Œå®ƒçš„åœ°ä½è·Ÿè‡ªå¸¦çš„ <code>useState</code> ç­‰æ¯”ä¹Ÿæ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œä½ å¯ä»¥åœ¨å…¶å®ƒç»„ä»¶é‡Œä½¿ç”¨ï¼Œç”šè‡³åœ¨è¿™ä¸ªç»„ä»¶é‡Œä½¿ç”¨ä¸¤æ¬¡ï¼Œå®ƒä»¬ä¼šå¤©ç„¶åœ°éš”ç¦»å¼€ã€‚</p><h2 id="Example-2"><a href="#Example-2" class="headerlink" title="Example 2:"></a>Example 2:</h2><p><a href="https://codesandbox.io/s/jvvkoo8pq3" target="_blank" rel="noopener">å®ä¾‹äºŒ</a></p><p>å‚è€ƒï¼š</p><p> <a href="https://segmentfault.com/a/1190000017182184" target="_blank" rel="noopener">React Hooks æ·±å…¥ä¸æµ…å‡º</a></p><p> <a href="https://segmentfault.com/a/1190000016950339" target="_blank" rel="noopener">30åˆ†é’Ÿç²¾é€šReactä»Šå¹´æœ€åŠ²çˆ†çš„æ–°ç‰¹æ€§â€”â€”React Hooks</a></p><p> <a href="https://medium.com/@ryardley/react-hooks-not-magic-just-arrays-cd4f1857236e" target="_blank" rel="noopener">React hooks: not magic, just arrays </a></p><p> <a href="https://medium.com/@dan_abramov/making-sense-of-react-hooks-fdbde8803889" target="_blank" rel="noopener">Making Sense of React Hooks </a></p><p> <a href="https://overreacted.io/a-complete-guide-to-useeffect/" target="_blank" rel="noopener">A Complete Guide to useEffect  </a>  æ¨è Dan çš„è¿™ç¯‡æ–‡ç« </p><p> <a href="https://medium.com/the-guild/under-the-hood-of-reacts-hooks-system-eb59638c9dba" target="_blank" rel="noopener">Under the hood of Reactâ€™s hooks system</a>  åŸç†  <a href="https://juejin.im/post/5c99a75af265da60ef635898" target="_blank" rel="noopener">ä¸­æ–‡ç‰ˆ</a></p>]]></content>
    
    <summary type="html">
    
      Hook æ˜¯ React 16.8 çš„æ–°å¢ç‰¹æ€§ã€‚å®ƒå¯ä»¥è®©ä½ åœ¨ä¸ç¼–å†™ class çš„æƒ…å†µä¸‹ä½¿ç”¨ state ä»¥åŠå…¶ä»–çš„ React ç‰¹æ€§ï¼ˆç”Ÿå‘½å‘¨æœŸç­‰ç‰¹æ€§ï¼‰ã€‚å¸¦æ¥çš„å¥½å¤„ä¸ä»…æ˜¯ â€œæ›´ FPï¼Œæ›´æ–°ç²’åº¦æ›´ç»†ï¼Œä»£ç æ›´æ¸…æ™°â€
    
    </summary>
    
      <category term="é»˜è®¤åˆ†ç±»" scheme="https://kitions.github.io/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/"/>
    
    
      <category term="React" scheme="https://kitions.github.io/tags/React/"/>
    
  </entry>
  
  <entry>
    <title>WEB-websocket,Notificationé€šçŸ¥</title>
    <link href="https://kitions.github.io/2019/05/07/WEB%20Notification%E9%80%9A%E7%9F%A5/"/>
    <id>https://kitions.github.io/2019/05/07/WEB Notificationé€šçŸ¥/</id>
    <published>2019-05-07T08:27:33.000Z</published>
    <updated>2020-05-09T09:30:00.255Z</updated>
    
    <content type="html"><![CDATA[<h1 id="WEB-websocket-Notificationé€šçŸ¥"><a href="#WEB-websocket-Notificationé€šçŸ¥" class="headerlink" title="WEB-websocket,Notificationé€šçŸ¥"></a>WEB-websocket,Notificationé€šçŸ¥</h1><h3 id="HTML5-æ¡Œé¢é€šçŸ¥ï¼šNotification-API"><a href="#HTML5-æ¡Œé¢é€šçŸ¥ï¼šNotification-API" class="headerlink" title="HTML5 æ¡Œé¢é€šçŸ¥ï¼šNotification API"></a>HTML5 æ¡Œé¢é€šçŸ¥ï¼šNotification API</h3><p>Notification API æ˜¯ HTML5 æ–°å¢çš„æ¡Œé¢é€šçŸ¥ APIï¼Œç”¨äºå‘ç”¨æˆ·æ˜¾ç¤ºé€šçŸ¥ä¿¡æ¯ã€‚è¯¥é€šçŸ¥æ˜¯è„±ç¦»æµè§ˆå™¨çš„ï¼Œå³ä½¿ç”¨æˆ·æ²¡æœ‰åœç•™åœ¨å½“å‰æ ‡ç­¾é¡µï¼Œç”šè‡³æœ€å°åŒ–äº†æµè§ˆå™¨ï¼Œè¯¥é€šçŸ¥ä¿¡æ¯ä¹Ÿä¸€æ ·ä¼šç½®é¡¶æ˜¾ç¤ºå‡ºæ¥ã€‚</p><h4 id="websocketè·å–åˆ°æ•°æ®ï¼Œnotifyé€šçŸ¥"><a href="#websocketè·å–åˆ°æ•°æ®ï¼Œnotifyé€šçŸ¥" class="headerlink" title="websocketè·å–åˆ°æ•°æ®ï¼Œnotifyé€šçŸ¥"></a>websocketè·å–åˆ°æ•°æ®ï¼Œnotifyé€šçŸ¥</h4><p>ç”¨æˆ·å…è®¸ç½‘é¡µçš„é€šçŸ¥ï¼Œåˆ©ç”¨websocketï¼Œå°†å®æ—¶è·å–æ¥çš„æ•°æ®æ¨é€ç»™ç”¨æˆ·ã€‚ä¸»è¦é’ˆå¯¹æµè§ˆå™¨ä¸ºchromeã€ç«ç‹ã€safariç­‰é«˜çº§æµè§ˆå™¨ï¼Œä¸æ”¯æŒIE (ps: æœ¬åœ°æ˜¯ä¸è¡Œçš„ï¼Œåªæœ‰åˆ°https çš„è¿œç¨‹æ‰å¯ä»¥è¿›è¡Œæ¨é€)</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// copyçš„ websocket ç®€æ˜“å°è£…</span></span><br><span class="line"><span class="comment">// SimpleWebSocket </span></span><br><span class="line"><span class="comment">// åæœŸå¯ä»¥å†™ä¸ªæ¯”è¾ƒå®Œå–„çš„</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> SimpleWebSocket&lt;T = <span class="built_in">any</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> websocket: WebSocket</span><br><span class="line">    <span class="keyword">private</span> isOpen: <span class="built_in">boolean</span></span><br><span class="line">    <span class="keyword">private</span> isManualClose: <span class="built_in">boolean</span></span><br><span class="line">    <span class="keyword">private</span> reconnectionTimer: <span class="built_in">number</span></span><br><span class="line">    <span class="keyword">private</span> message: <span class="built_in">string</span>[] = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">        <span class="keyword">private</span> url: <span class="built_in">string</span>,</span></span><br><span class="line">        private success: (data: T) =&gt; void,</span><br><span class="line">        <span class="keyword">private</span> openInit?: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">void</span></span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">this</span>.reset()</span><br><span class="line">        <span class="keyword">this</span>.pump()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> send(msg: <span class="built_in">string</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.isOpen ? <span class="keyword">this</span>.websocket.send(msg) : <span class="keyword">this</span>.message.push(msg)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> close() &#123;</span><br><span class="line">        <span class="keyword">this</span>.isManualClose = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">this</span>.websocket.close()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> reset() &#123;</span><br><span class="line">        <span class="keyword">this</span>.websocket = <span class="keyword">this</span>.createWebSocket(<span class="keyword">this</span>.url)</span><br><span class="line">        <span class="keyword">this</span>.isOpen = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">this</span>.isManualClose = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">this</span>.bindEvent()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> createWebSocket(url: <span class="built_in">string</span>): WebSocket &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WebSocket(url)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> bindEvent() &#123;</span><br><span class="line">        <span class="keyword">this</span>.websocket.onmessage = <span class="function">(<span class="params">data: MessageEvent</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.success(data.data <span class="keyword">as</span> T)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.websocket.onopen = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.isOpen = <span class="literal">true</span></span><br><span class="line">            <span class="keyword">this</span>.openInit &amp;&amp; <span class="keyword">this</span>.openInit()</span><br><span class="line">            <span class="keyword">this</span>.reconnectionTimer &amp;&amp; <span class="built_in">window</span>.clearInterval(<span class="keyword">this</span>.reconnectionTimer)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.websocket.onclose = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.isManualClose) &#123;</span><br><span class="line">                <span class="keyword">this</span>.reconnection()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.websocket.onerror = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.reconnection()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> pump() &#123;</span><br><span class="line">        setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.message.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> msg = <span class="keyword">this</span>.message.shift()</span><br><span class="line">                <span class="keyword">if</span> (msg) &#123; <span class="keyword">this</span>.send(msg <span class="keyword">as</span> <span class="built_in">string</span>) &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1000</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡æ–°è¿æ¥ï¼Œ3ç§’é‡è¿ä¸€æ¬¡</span></span><br><span class="line">    <span class="keyword">private</span> reconnection() &#123;</span><br><span class="line">        <span class="keyword">this</span>.reconnectionTimer &amp;&amp; <span class="built_in">window</span>.clearInterval(<span class="keyword">this</span>.reconnectionTimer)</span><br><span class="line">        <span class="keyword">this</span>.reconnectionTimer = <span class="built_in">window</span>.setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.reset()</span><br><span class="line">        &#125;, <span class="number">3000</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; SimpleWebSocket &#125;</span><br></pre></td></tr></table></figure><ol><li>åˆå§‹åŒ–websocket</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">componentDidMount() &#123;</span><br><span class="line"><span class="keyword">const</span> config = Cookie.Get(<span class="string">""</span>); <span class="comment">// å°†æ˜¯å¦é€šçŸ¥çš„å¸ƒå°”å­˜åˆ°cookieä¸­ï¼Œä¹Ÿå¯ä»¥å­˜åˆ°localstorge</span></span><br><span class="line"><span class="keyword">if</span> (config) &#123;</span><br><span class="line"><span class="keyword">const</span> configValue = <span class="built_in">JSON</span>.parse(<span class="built_in">decodeURIComponent</span>(config));</span><br><span class="line"><span class="keyword">this</span>._data.setVoice(configValue.voice);</span><br><span class="line"><span class="keyword">this</span>._data.setNotify(configValue.notify); <span class="comment">// boolean</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">this</span>._websocket = <span class="keyword">new</span> SimpleWebSocket(</span><br><span class="line">Config.websocket,</span><br><span class="line">data =&gt; &#123;</span><br><span class="line"><span class="keyword">const</span> item = <span class="built_in">JSON</span>.parse(data);</span><br><span class="line"><span class="keyword">if</span> (item.data &amp;&amp; item.method == <span class="string">""</span>) &#123;</span><br><span class="line">~~~</span><br><span class="line">           <span class="comment">// è·å–æ¥çš„æ•°æ®åšå¤„ç†  </span></span><br><span class="line">         ~~~</span><br><span class="line"><span class="keyword">this</span>._data.makeVoice();</span><br><span class="line"><span class="keyword">this</span>._data.notify(news);</span><br><span class="line"><span class="keyword">this</span>.setState(&#123;&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">() =&gt; &#123;</span><br><span class="line"><span class="keyword">const</span> token = Cookie.Get();</span><br><span class="line"><span class="keyword">this</span>._websocket.send(</span><br><span class="line"><span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">method: <span class="string">"subscribe"</span>,</span><br><span class="line">data: &#123;</span><br><span class="line">topic: <span class="string">""</span>, </span><br><span class="line">client_type: <span class="string">""</span>, </span><br><span class="line">client_version: <span class="string">"1.0.0"</span>, </span><br><span class="line">token: token</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">);</span><br><span class="line">&#125;</span><br><span class="line">);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>é€šçŸ¥çš„è®¾ç½®</li></ol><p><code>var notification = new Notification(title, options)</code></p><p>å‚æ•°å¦‚ä¸‹ï¼š</p><ul><li>titleï¼šé€šçŸ¥çš„æ ‡é¢˜</li><li>optionsï¼šé€šçŸ¥çš„è®¾ç½®é€‰é¡¹ï¼ˆå¯é€‰ï¼‰ã€‚<ul><li>bodyï¼šé€šçŸ¥çš„å†…å®¹ã€‚</li><li>tagï¼šä»£è¡¨é€šçŸ¥çš„ä¸€ä¸ªè¯†åˆ«æ ‡ç­¾ï¼Œç›¸åŒtagæ—¶åªä¼šæ‰“å¼€åŒä¸€ä¸ªé€šçŸ¥çª—å£ã€‚</li><li>iconï¼šè¦åœ¨é€šçŸ¥ä¸­æ˜¾ç¤ºçš„å›¾æ ‡çš„URLã€‚</li><li>imageï¼šè¦åœ¨é€šçŸ¥ä¸­æ˜¾ç¤ºçš„å›¾åƒçš„URLã€‚</li><li>dataï¼šæƒ³è¦å’Œé€šçŸ¥å…³è”çš„ä»»åŠ¡ç±»å‹çš„æ•°æ®ã€‚</li><li>requireInteractionï¼šé€šçŸ¥ä¿æŒæœ‰æ•ˆä¸è‡ªåŠ¨å…³é—­ï¼Œé»˜è®¤ä¸ºfalseã€‚</li></ul></li></ul><h4 id="ç”¨æˆ·æƒé™"><a href="#ç”¨æˆ·æƒé™" class="headerlink" title="ç”¨æˆ·æƒé™"></a>ç”¨æˆ·æƒé™</h4><p>æƒ³è¦å‘ç”¨æˆ·æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯ï¼Œéœ€è¦è·å–ç”¨æˆ·æƒé™ï¼Œè€Œç›¸åŒçš„åŸŸååªéœ€è¦è·å–ä¸€æ¬¡æƒé™ã€‚åªæœ‰ç”¨æˆ·å…è®¸çš„æƒé™ä¸‹ï¼ŒNotification æ‰èƒ½èµ·åˆ°ä½œç”¨ï¼Œé¿å…æŸäº›ç½‘ç«™çš„å¹¿å‘Šæ»¥ç”¨ Notification æˆ–å…¶å®ƒç»™ç”¨æˆ·é€ æˆå½±å“ã€‚é‚£ä¹ˆå¦‚ä½•çŸ¥é“ç”¨æˆ·åˆ°åº•æ˜¯å…ä¸å…è®¸çš„ï¼Ÿ</p><p>Notification.permission è¯¥å±æ€§ç”¨äºè¡¨æ˜å½“å‰é€šçŸ¥æ˜¾ç¤ºçš„æˆæƒçŠ¶æ€ï¼Œå¯èƒ½çš„å€¼åŒ…æ‹¬ï¼š</p><ul><li>default ï¼šä¸çŸ¥é“ç”¨æˆ·çš„é€‰æ‹©ï¼Œé»˜è®¤ã€‚</li><li>granted ï¼šç”¨æˆ·å…è®¸ã€‚</li><li>denied ï¼šç”¨æˆ·æ‹’ç»ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(Notification.permission === <span class="string">'granted'</span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'ç”¨æˆ·å…è®¸é€šçŸ¥'</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(Notification.permission === <span class="string">'denied'</span>)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'ç”¨æˆ·æ‹’ç»é€šçŸ¥'</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'ç”¨æˆ·è¿˜æ²¡é€‰æ‹©ï¼Œå»å‘ç”¨æˆ·ç”³è¯·æƒé™å§'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è¯·æ±‚æƒé™"><a href="#è¯·æ±‚æƒé™" class="headerlink" title="è¯·æ±‚æƒé™"></a>è¯·æ±‚æƒé™</h4><p>å½“ç”¨æˆ·è¿˜æ²¡é€‰æ‹©çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å‘ç”¨æˆ·å»è¯·æ±‚æƒé™ã€‚Notification å¯¹è±¡æä¾›äº† requestPermission() æ–¹æ³•è¯·æ±‚ç”¨æˆ·å½“å‰æ¥æºçš„æƒé™ä»¥æ˜¾ç¤ºé€šçŸ¥ã€‚</p><p>ä»¥å‰åŸºäºå›è°ƒçš„è¯­æ³•å·²ç»å¼ƒç”¨ï¼ˆå½“ç„¶åœ¨ç°åœ¨çš„æµè§ˆå™¨ä¸­è¿˜æ˜¯èƒ½ç”¨çš„ï¼‰ï¼Œæœ€æ–°çš„è§„èŒƒå·²å°†æ­¤æ–¹æ³•æ›´æ–°ä¸ºåŸºäº promise çš„è¯­æ³•ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Notification.requestPermission().then(<span class="function"><span class="keyword">function</span>(<span class="params">permission</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(permission === <span class="string">'granted'</span>)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'ç”¨æˆ·å…è®¸é€šçŸ¥'</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(permission === <span class="string">'denied'</span>)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'ç”¨æˆ·æ‹’ç»é€šçŸ¥'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="å…³é—­é€šçŸ¥"><a href="#å…³é—­é€šçŸ¥" class="headerlink" title="å…³é—­é€šçŸ¥"></a>å…³é—­é€šçŸ¥</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> n = <span class="keyword">new</span> Notification(<span class="string">'æé†’'</span>,&#123;</span><br><span class="line">    body: <span class="string">'ä½ çš„æœ‹å‹åœˆæœ‰3æ¡æ–°çŠ¶æ€ï¼Œå¿«å»æŸ¥çœ‹å§'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    n.close();</span><br><span class="line">&#125;, <span class="number">3000</span>);</span><br></pre></td></tr></table></figure><p>Example:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">public setNotify(value: boolean) &#123;</span><br><span class="line"><span class="keyword">if</span> ((<span class="built_in">window</span> <span class="keyword">as</span> any).Notification) &#123;</span><br><span class="line">Notification.requestPermission(<span class="function"><span class="params">()</span> =&gt;</span> &#123; <span class="comment">// ç”¨æˆ·å…è®¸æµè§ˆå™¨é€šçŸ¥</span></span><br><span class="line"><span class="keyword">this</span>._notify = value;</span><br><span class="line">Cookie.Set(       <span class="comment">// å°†æ˜¯å¦é€šçŸ¥çš„å¸ƒå°”å­˜åˆ°cookieä¸­ï¼Œä¹Ÿå¯ä»¥å­˜åˆ°localstorge</span></span><br><span class="line"><span class="string">""</span>,</span><br><span class="line"><span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">voice: <span class="keyword">this</span>._voice,</span><br><span class="line">notify: <span class="keyword">this</span>._notify</span><br><span class="line">&#125;)</span><br><span class="line">);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ¡Œé¢æ¨é€åŠŸèƒ½</span></span><br><span class="line">public notify(item: NewsProfile.AsObject) &#123;</span><br><span class="line"><span class="keyword">if</span> ((<span class="built_in">window</span> <span class="keyword">as</span> any).Notification &amp;&amp; <span class="keyword">this</span>._notify) &#123;</span><br><span class="line"><span class="keyword">var</span> notify = <span class="keyword">new</span> Notification(<span class="string">"é€šçŸ¥çš„æ ‡é¢˜"</span>, &#123;</span><br><span class="line">icon:</span><br><span class="line"><span class="string">"è¿™å„¿ä¸ºlogoå›¾"</span>,</span><br><span class="line">body: <span class="string">"è¿™å„¿æ˜¯å…·ä½“çš„å†…å®¹"</span>,</span><br><span class="line">tag: <span class="string">'id'</span>, <span class="comment">// ç›¸å½“äºæ˜¯å½“å‰é€šçŸ¥çš„idï¼Œé…åˆrenotifyä½¿ç”¨ï¼Œå¯ä»¥ä½¿å¤šä¸ªé€šçŸ¥ä¸é‡å </span></span><br><span class="line">renotify : <span class="literal">true</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">notify.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="built_in">window</span>.focus();</span><br><span class="line"><span class="keyword">this</span>.close();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">public setVoice(v: boolean) &#123;</span><br><span class="line">Cookie.Set(</span><br><span class="line"><span class="string">""</span>,</span><br><span class="line"><span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">voice: <span class="keyword">this</span>._voice,</span><br><span class="line">notify: <span class="keyword">this</span>._notify</span><br><span class="line">&#125;)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">this</span>._voice = v;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å£°éŸ³æç¤º</span></span><br><span class="line">public makeVoice() &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>._voice) &#123;</span><br><span class="line"><span class="keyword">const</span> audio = <span class="built_in">document</span>.getElementById(<span class="string">"audioPlay"</span>); <span class="comment">// ä¸€æ®µéŸ³é¢‘æ–‡ä»¶</span></span><br><span class="line">(audio <span class="keyword">as</span> any).play();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>æ˜¯å¦é€šçŸ¥çš„å¼€å…³,åŒ…æ‹¬å£°éŸ³çš„å’Œnotifyçš„</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;Switch</span><br><span class="line">checked=&#123;<span class="keyword">this</span>._voice&#125;</span><br><span class="line">onChange=&#123;() =&gt; &#123;</span><br><span class="line"><span class="keyword">this</span>._voice = !<span class="keyword">this</span>._voice;</span><br><span class="line"><span class="keyword">this</span>.props.option &amp;&amp; <span class="keyword">this</span>.props.option(</span><br><span class="line"><span class="keyword">this</span>._voice,</span><br><span class="line"><span class="keyword">this</span>._desk</span><br><span class="line">);</span><br><span class="line"><span class="keyword">this</span>.setState(&#123;&#125;);</span><br><span class="line">   &#125;&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨Service-Workerå‘é€Pushæ¨é€-â€”-web-push"><a href="#ä½¿ç”¨Service-Workerå‘é€Pushæ¨é€-â€”-web-push" class="headerlink" title="ä½¿ç”¨Service Workerå‘é€Pushæ¨é€  â€” web push"></a>ä½¿ç”¨Service Workerå‘é€Pushæ¨é€  â€” web push</h4><p>Web pushåœ¨å›½å¤–çš„ç½‘ç«™è¿˜è¡Œï¼Œä½†åœ¨å›½å†…å‡ ä¹æ²¡è§åˆ°ï¼Œä¸»è¦è¿˜æ˜¯å› ä¸ºè°·æ­Œåœ¨å¢ƒå†…æ— æ³•è®¿é—®ï¼Œå› ä¸ºweb pushèµ°çš„æ˜¯è°·æ­ŒFCMé€šé“ï¼Œéœ€è¦èƒ½æ¥æ”¶åˆ°è°·æ­ŒæœåŠ¡å™¨çš„æ¶ˆæ¯ã€‚ä½†æ­£å¸¸ç½‘ç»œç¯å¢ƒä¸‹æ˜¯æ— æ³•è®¿é—®è°·æ­Œçš„ï¼Œä½¿å¾—åœ¨å›½å†…æå®ƒçš„æ„ä¹‰ä¸æ˜¯å¾ˆå¤§ï¼Œç ”ç©¶ä¸€ä¸‹è¿˜æ˜¯å¯ä»¥çš„ã€‚</p><h4 id="PSï¼š"><a href="#PSï¼š" class="headerlink" title="PSï¼š"></a>PSï¼š</h4><p>ä¸è¿‡è¿™ä¸ªæµè§ˆå™¨é€šçŸ¥ä¹ŸæŒºçƒ¦çš„ï¼Œæˆ‘ä¸ªäººæ¯”è¾ƒä¸æ„Ÿå†’ï¼Œä¼šæŠŠæ‰€æœ‰æµè§ˆå™¨é€šçŸ¥å…³æ‰ã€‚çœ‹äº§å“éœ€æ±‚å§ã€‚ä¹Ÿå¯ä»¥ç”¨ç°æœ‰çš„åº“push.js.</p><p><img src="https://ws4.sinaimg.cn/large/006tNc79gy1g2ssyxtg3pj30z50q4n1r.jpg" alt=""></p><p> å‚è€ƒé“¾æ¥ï¼š<a href="https://juejin.im/post/59d9b38ef265da064a0f72cc" target="_blank" rel="noopener">https://juejin.im/post/59d9b38ef265da064a0f72cc</a></p><p>è°·æ­Œå®˜æ–¹ <a href="https://developers.google.com/web/fundamentals/codelabs/push-notifications/?hl=zh-cn" target="_blank" rel="noopener">https://developers.google.com/web/fundamentals/codelabs/push-notifications/?hl=zh-cn</a></p><p>ä¸€ä¸ªgithubé¡¹ç›® <a href="https://github.com/realtime-framework/WebPushNotifications" target="_blank" rel="noopener">https://github.com/realtime-framework/WebPushNotifications</a></p>]]></content>
    
    <summary type="html">
    
      HTML5æ¡Œé¢é€šçŸ¥,Notification API,ç¬¬ä¸€ç§æ–¹å¼ä¸ºwebsocketè·å–åˆ°æ•°æ®ï¼Œnotifyé€šçŸ¥ï¼Œè¾ƒä¸ºå¸¸ç”¨ï¼Œç¬¬äºŒç§web-pushï¼Œä¸å¸¸ç”¨ï¼Œæœ‰å¢™
    
    </summary>
    
      <category term="é»˜è®¤åˆ†ç±»" scheme="https://kitions.github.io/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/"/>
    
    
      <category term="Notification" scheme="https://kitions.github.io/tags/Notification/"/>
    
  </entry>
  
  <entry>
    <title>Next.js-Windowæˆ–Document å¯¹è±¡æœªå®šä¹‰</title>
    <link href="https://kitions.github.io/2019/04/28/Next.js%E4%B8%ADWindow%E6%9C%AA%E5%AE%9A%E4%B9%89/"/>
    <id>https://kitions.github.io/2019/04/28/Next.jsä¸­Windowæœªå®šä¹‰/</id>
    <published>2019-04-28T01:53:22.000Z</published>
    <updated>2019-05-07T08:26:39.239Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Next-js-Window-æˆ–-Document-å¯¹è±¡æœªå®šä¹‰ï¼Ÿ"><a href="#Next-js-Window-æˆ–-Document-å¯¹è±¡æœªå®šä¹‰ï¼Ÿ" class="headerlink" title="Next.js-Window æˆ– Document å¯¹è±¡æœªå®šä¹‰ï¼Ÿ"></a>Next.js-Window æˆ– Document å¯¹è±¡æœªå®šä¹‰ï¼Ÿ</h3><blockquote><p>èƒŒæ™¯: åœ¨å¼•å…¥ç¬¬ä¸‰æ–¹æ’ä»¶ï¼Œæˆ–è€…ç›´æ¥åœ¨ä»£ç ä¸­å†™ <code>window</code> æ—¶ï¼Œæ§åˆ¶å°ä¼šç»™å‡ºè­¦å‘Šï¼Œ<code>window</code> æœªå®šä¹‰ã€‚</p></blockquote><p>å‘ç”Ÿåœ¨è¿™ä¸ªé—®é¢˜çš„åŸå› æ˜¯ï¼ŒnodeæœåŠ¡ç«¯å¹¶æ²¡æœ‰<code>window</code> æˆ– <code>document</code> å¯¹è±¡ã€‚è§£å†³æ–¹æ³•ï¼Œé€šè¿‡ <code>process.browser</code> æ¥åŒºåˆ†ç¯å¢ƒã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.browser) &#123;</span><br><span class="line">  <span class="comment">// å¼•å…¥ç¬¬ä¸‰æ–¹æ’ä»¶</span></span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'***'</span>)</span><br><span class="line">  <span class="comment">// æˆ–è€…ä¿®æ”¹windowå¯¹è±¡ä¸‹æŸä¸€å±æ€§</span></span><br><span class="line">  <span class="built_in">window</span>.mbk = &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">componentDidMountï¼ˆï¼‰&#123;</span><br><span class="line">  <span class="keyword">this</span>.MyModule = <span class="built_in">require</span>ï¼ˆ<span class="string">'./ MyModule'</span>ï¼‰</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> DynamicComponentWithNoSSR = dynamicï¼ˆ<span class="keyword">import</span>ï¼ˆ<span class="string">'../ components / hello3'</span>ï¼‰ï¼Œ&#123;</span><br><span class="line">  ssrï¼š<span class="literal">false</span></span><br><span class="line">&#125;ï¼‰</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span>ï¼ˆï¼‰=&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;æ ‡é¢˜/&gt;</span><br><span class="line">    &lt;DynamicComponentWithNoSSR /&gt;</span><br><span class="line">    &lt;p&gt;ä¸»é¡µåœ¨è¿™é‡Œï¼&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>div&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      next.jsåœ¨å¼•å…¥ç¬¬ä¸‰æ–¹æ’ä»¶ï¼Œæˆ–è€…ç›´æ¥åœ¨ä»£ç ä¸­å†™ window æ—¶ï¼Œæ§åˆ¶å°ä¼šç»™å‡ºè­¦å‘Šï¼Œwindow æœªå®šä¹‰ã€‚å‘ç”Ÿåœ¨è¿™ä¸ªé—®é¢˜çš„åŸå› æ˜¯ï¼ŒnodeæœåŠ¡ç«¯å¹¶æ²¡æœ‰window æˆ– document å¯¹è±¡ã€‚è§£å†³æ–¹æ³•ï¼Œé€šè¿‡ process.browser æ¥åŒºåˆ†ç¯å¢ƒã€‚
    
    </summary>
    
      <category term="é»˜è®¤åˆ†ç±»" scheme="https://kitions.github.io/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/"/>
    
    
      <category term="next.js" scheme="https://kitions.github.io/tags/next-js/"/>
    
  </entry>
  
  <entry>
    <title>node.js â€” koa â€” Typescript å¾®ä¿¡è¿æ¥api</title>
    <link href="https://kitions.github.io/2019/04/15/node.js%20%E2%80%94%20koa%20%E2%80%94%20Typescript%20%E5%BE%AE%E4%BF%A1%E8%BF%9E%E6%8E%A5api/"/>
    <id>https://kitions.github.io/2019/04/15/node.js â€” koa â€” Typescript å¾®ä¿¡è¿æ¥api/</id>
    <published>2019-04-15T03:51:12.000Z</published>
    <updated>2019-04-30T06:39:05.224Z</updated>
    
    <content type="html"><![CDATA[<h3 id="node-js-â€”-koa-â€”-Typescript-å¾®ä¿¡è¿æ¥api"><a href="#node-js-â€”-koa-â€”-Typescript-å¾®ä¿¡è¿æ¥api" class="headerlink" title="node.js â€” koa â€” Typescript å¾®ä¿¡è¿æ¥api"></a>node.js â€” koa â€” Typescript å¾®ä¿¡è¿æ¥api</h3><p>æœåŠ¡å™¨ä¸­é—´å±‚æ¡†æ¶ä¸ºkoaï¼Œä½¿ç”¨nodeåŸç”Ÿçš„åŠ å¯†æ–¹å¼ï¼Œåº”è¯¥æ•´ä¸ªå…¬å¸é¡¹ç›®çš„å¾®ä¿¡apiéƒ½ä»ä¸€ä¸ªæ¥å£ä¸Šå‡ºå»ï¼Œä¸åº”è¯¥åˆ†æ•£åˆ°å„ä¸ªé¡¹ç›®å»å•ç‹¬è°ƒapiï¼Œä¾¿äºç®¡ç†ç»´æŠ¤ï¼Œå‡å°‘è°ƒç”¨æ¬¡æ•°</p><p><code>memory-cache</code>ä¸ºè¯·æ±‚åˆ°çš„access_tokenåšç¼“å­˜ï¼Œå¾®ä¿¡è°ƒç”¨access_tokenæ¯æ—¥æœ‰æ¬¡æ•°é™åˆ¶ã€‚ç›®å‰æ˜¯æ ¹æ®æ—¶é—´åˆ¤æ–­çš„ï¼Œç†åº”åæœŸåŠ ä¸Šå®šæ—¶ä»»åŠ¡</p><ol><li>è·å–access_tokenå­˜å…¥ç¼“å­˜ï¼Œæœ‰æ•ˆæœŸä¸¤å°æ—¶ï¼Œæœ‰çš„è¯ä»ç¼“å­˜ä¸­å–</li><li>è·å–ticketå­˜å…¥ç¼“å­˜ï¼Œæœ‰æ•ˆæœŸä¸¤å°æ—¶ï¼Œæœ‰çš„è¯ä»ç¼“å­˜ä¸­å–</li><li>å°†è·å–åˆ°çš„ticketå’Œå…¶ä»–ä¸‰ä¸ªå‚æ•°è¿›è¡Œsha1-HEXåŠ å¯†ï¼Œæ‹¿åˆ°ç­¾åsignature</li><li>æä¾›ä¸€ä¸ªæ¥å£ä¾›å‰ç«¯è°ƒ(ps: æ•æ„Ÿå­—æ®µè¯·å‹¿ä¼ ç»™å‰å°)</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> koa <span class="keyword">from</span> <span class="string">"koa"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; HTTPProtocol &#125; <span class="keyword">from</span> <span class="string">"@Constance/interface"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; getData, httpType &#125; <span class="keyword">from</span> <span class="string">'@Utils/http'</span></span><br><span class="line"><span class="keyword">import</span> Config <span class="keyword">from</span> <span class="string">'@Config/config'</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> cache <span class="keyword">from</span> <span class="string">'memory-cache'</span></span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> IAccessTokenResponse &#123;</span><br><span class="line">errcode: <span class="built_in">number</span>;</span><br><span class="line">errmsg: <span class="built_in">string</span>;</span><br><span class="line">access_token: <span class="built_in">string</span>;</span><br><span class="line">expires_in: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> jsAPITicketResponse &#123;</span><br><span class="line">errcode: <span class="built_in">number</span>;</span><br><span class="line">errmsg: <span class="built_in">string</span>;</span><br><span class="line">ticket: <span class="built_in">string</span>;</span><br><span class="line">expires_in: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getWxConfig = <span class="keyword">async</span> (ctx: koa.Context) =&gt; &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; url &#125; = ctx.query</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›ç»™å‰å°çš„æ•°æ®</span></span><br><span class="line"><span class="keyword">let</span> res: HTTPProtocol&lt;<span class="built_in">any</span>&gt; = &#123;</span><br><span class="line">code: <span class="number">0</span>,</span><br><span class="line">msg: <span class="string">"æˆåŠŸ"</span>,</span><br><span class="line">data: <span class="string">""</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!url) &#123;</span><br><span class="line">res.msg = <span class="string">"æ— URL"</span></span><br><span class="line">ctx.body = res</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> timestamp: <span class="built_in">number</span> = <span class="built_in">Math</span>.floor(<span class="built_in">Date</span>.now() / <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–access_token </span></span><br><span class="line"><span class="keyword">if</span> (!cache.get(<span class="string">"tokenObj"</span>) || cache.get(<span class="string">"tokenObj"</span>).expires_in &lt; timestamp || cache.get(<span class="string">"tokenObj"</span>).app_id !== Config.wx_gzh.app_id) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> getAccessURL = Config.wx_gzh.access_token + <span class="string">`&amp;appid=`</span> + Config.wx_gzh.app_id + <span class="string">`&amp;secret=`</span> + Config.wx_gzh.app_secret</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> WxAccessToken = <span class="keyword">await</span> getData&lt;IAccessTokenResponse&gt;(getAccessURL, httpType.get)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (WxAccessToken &amp;&amp; WxAccessToken.access_token) &#123;</span><br><span class="line">cache.put(<span class="string">"tokenObj"</span>, &#123;</span><br><span class="line">access_token: WxAccessToken.access_token,</span><br><span class="line">expires_in: timestamp + (WxAccessToken.expires_in - <span class="number">1800</span>),</span><br><span class="line">app_id: Config.wx_gzh.app_id</span><br><span class="line">&#125;, <span class="number">1.5</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">cache.put(<span class="string">"tokenObj"</span>, <span class="literal">null</span>);</span><br><span class="line">ctx.logger.error(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`wxconfig: <span class="subst">$&#123;JSON.stringify(Config.wx_gzh)&#125;</span>`</span>));</span><br><span class="line">ctx.logger.error(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`tokenResult: <span class="subst">$&#123;JSON.stringify(WxAccessToken)&#125;</span>`</span>));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">res.code = <span class="number">500</span></span><br><span class="line">res.msg = <span class="string">"è·å–accesså¤±è´¥"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–ticket</span></span><br><span class="line"><span class="keyword">if</span> (cache.get(<span class="string">"tokenObj"</span>) &amp;&amp; cache.get(<span class="string">"tokenObj"</span>).app_id === Config.wx_gzh.app_id) &#123;</span><br><span class="line">timestamp = <span class="built_in">Math</span>.floor(<span class="built_in">Date</span>.now() / <span class="number">1000</span>);</span><br><span class="line"><span class="keyword">if</span> (!cache.get(<span class="string">"jsapiObj"</span>) || cache.get(<span class="string">"jsapiObj"</span>).expires_in &lt; timestamp || cache.get(<span class="string">"jsapiObj"</span>).app_id !== Config.wx_gzh.app_id) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> getTicketURL = Config.wx_gzh.js_api + <span class="string">`&amp;access_token=`</span> + cache.get(<span class="string">"tokenObj"</span>).access_token</span><br><span class="line"><span class="keyword">const</span> WxTicket = <span class="keyword">await</span> getData&lt;jsAPITicketResponse&gt;(getTicketURL, httpType.get)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (WxTicket &amp;&amp; WxTicket.ticket) &#123;</span><br><span class="line">cache.put(<span class="string">"jsapiObj"</span>, &#123;</span><br><span class="line">ticket: WxTicket.ticket,</span><br><span class="line">expires_in: timestamp + (WxTicket.expires_in - <span class="number">1800</span>),</span><br><span class="line">app_id: Config.wx_gzh.app_id</span><br><span class="line">&#125;, <span class="number">1.5</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">cache.put(<span class="string">"jsapiObj"</span>, <span class="literal">null</span>);</span><br><span class="line">ctx.logger.error(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`wxconfig: <span class="subst">$&#123;JSON.stringify(Config.wx_gzh)&#125;</span>`</span>));</span><br><span class="line">ctx.logger.error(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`jsapiResult: <span class="subst">$&#123;JSON.stringify(WxTicket)&#125;</span>`</span>));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (cache.get(<span class="string">"jsapiObj"</span>) &amp;&amp; cache.get(<span class="string">"jsapiObj"</span>).app_id === Config.wx_gzh.app_id) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> jsapi_ticket = cache.get(<span class="string">"jsapiObj"</span>).ticket;</span><br><span class="line"><span class="keyword">const</span> nonceStr = Config.wx_gzh.nonce_str</span><br><span class="line">timestamp = <span class="built_in">Math</span>.floor(<span class="built_in">Date</span>.now() / <span class="number">1000</span>);</span><br><span class="line"><span class="keyword">const</span> string1 = <span class="string">`jsapi_ticket=<span class="subst">$&#123;jsapi_ticket&#125;</span>&amp;noncestr=<span class="subst">$&#123;nonceStr&#125;</span>&amp;timestamp=<span class="subst">$&#123;timestamp&#125;</span>&amp;url=<span class="subst">$&#123;url&#125;</span>`</span>;</span><br><span class="line"><span class="keyword">const</span> signature = sha1Trans(string1)</span><br><span class="line">res.code = <span class="number">0</span></span><br><span class="line">res.msg = <span class="string">"æˆåŠŸ"</span></span><br><span class="line">res.data = &#123;</span><br><span class="line">nonceStr: nonceStr,</span><br><span class="line">timestamp: timestamp,</span><br><span class="line">signature: signature,</span><br><span class="line">appId: Config.wx_gzh.app_id</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sha1Trans</span>(<span class="params">str: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> sha1 = crypto.createHash(<span class="string">'sha1'</span>);<span class="comment">//åˆ›å»ºå“ˆå¸ŒåŠ å¯†ç®—æ³•ï¼Œåè¾¹å¯ä»¥æ˜¯md5ï¼Œsha1,sha256ç­‰</span></span><br><span class="line"><span class="keyword">var</span> newStr = sha1.update(str).digest(<span class="string">'HEX'</span>);</span><br><span class="line"><span class="keyword">return</span> newStr</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ctx.body = res</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">getWxConfig</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶ä¸ºï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">"wx_gzh": &#123;</span><br><span class="line">   "nonce_str": "éšæœºå­—ç¬¦ä¸²",</span><br><span class="line">   "app_id": "ä½ è‡ªå·±çš„",</span><br><span class="line">   "app_secret": "ä½ è‡ªå·±çš„",</span><br><span class="line">   "js_api": "https://api.weixin.qq.com/cgi-bin/ticket/getticket?type=jsapi",</span><br><span class="line">   "access_token": "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential"</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      å…±4æ­¥éª¤ï¼Œæ¯”è¾ƒç®€å•ï¼Œç”¨äº†memory-cacheï¼ŒåæœŸéœ€è¦å®šæ—¶ä»»åŠ¡
    
    </summary>
    
      <category term="é»˜è®¤åˆ†ç±»" scheme="https://kitions.github.io/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/"/>
    
    
      <category term="å¾®ä¿¡" scheme="https://kitions.github.io/tags/%E5%BE%AE%E4%BF%A1/"/>
    
  </entry>
  
  <entry>
    <title>golangä¹‹httpå°è£…</title>
    <link href="https://kitions.github.io/2019/03/28/golang-http%E5%B0%81%E8%A3%85/"/>
    <id>https://kitions.github.io/2019/03/28/golang-httpå°è£…/</id>
    <published>2019-03-28T01:53:22.000Z</published>
    <updated>2019-04-30T06:46:00.324Z</updated>
    
    <content type="html"><![CDATA[<h3 id="goè®©æ—¥å¿—æ˜¾ç¤ºè¡Œæ•°"><a href="#goè®©æ—¥å¿—æ˜¾ç¤ºè¡Œæ•°" class="headerlink" title="goè®©æ—¥å¿—æ˜¾ç¤ºè¡Œæ•°"></a>goè®©æ—¥å¿—æ˜¾ç¤ºè¡Œæ•°</h3><pre><code>log.SetFlags(log.Lshortfile | log.LstdFlags)</code></pre><h3 id="ä¸€ä¸ªç®€å•çš„golang-httpå°è£…"><a href="#ä¸€ä¸ªç®€å•çš„golang-httpå°è£…" class="headerlink" title="ä¸€ä¸ªç®€å•çš„golang httpå°è£…"></a>ä¸€ä¸ªç®€å•çš„golang httpå°è£…</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HttpGetCall</span><span class="params">(url <span class="keyword">string</span>, params <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>, cooikes []*http.Cookie, res <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">op := NewRequestOptions()</span><br><span class="line">op.Params = params</span><br><span class="line">op.Cookies = cooikes</span><br><span class="line">resp, err := grequests.Get(url, op)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !resp.Ok &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"Response failed with status code: %d."</span>, resp.StatusCode)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> res != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> resp.JSON(res)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRequestOptions</span><span class="params">()</span> *<span class="title">grequests</span>.<span class="title">RequestOptions</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;grequests.RequestOptions&#123;</span><br><span class="line">DialTimeout:         <span class="number">5</span> * time.Second,</span><br><span class="line">TLSHandshakeTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">RequestTimeout:      <span class="number">5</span> * time.Second,</span><br><span class="line">InsecureSkipVerify:  <span class="literal">true</span>,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿”å›ç±»å‹çš„ç»“æ„ä½“</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Message <span class="keyword">struct</span> &#123;</span><br><span class="line">Code <span class="keyword">int</span>              <span class="string">`json:"code"`</span></span><br><span class="line">Msg  <span class="keyword">string</span>           <span class="string">`json:"msg"`</span></span><br><span class="line">Data *json.RawMessage <span class="string">`json:"data"`</span> <span class="comment">// must be *json.RawMessage</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ä¾‹å­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetUserInfoByAccount</span><span class="params">(account <span class="keyword">string</span>)</span> <span class="params">(*protocol.UserCenterFilterUserInfo, <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">params := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line"><span class="string">"field"</span>: <span class="string">"member_name"</span>,</span><br><span class="line"><span class="string">"value"</span>: account,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> m protocol.Message</span><br><span class="line">url := getUserCenterInnerDomain() + <span class="string">"/get_filter_user_and_company_list"</span></span><br><span class="line">err := util.HttpGetCall(url, params, <span class="literal">nil</span>, &amp;m)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">logger.Warnning(<span class="string">"GetUserInfoByAccount error:"</span>, err.Error())</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, protocol.CODE_SYSTEM_ERROR</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Resp <span class="keyword">struct</span> &#123;</span><br><span class="line">Infos []protocol.UserCenterFilterUserInfo <span class="string">`json:"infos"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> resp Resp</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err = json.Unmarshal(*m.Data, &amp;resp); err != <span class="literal">nil</span> &#123;</span><br><span class="line">logger.Warnning(<span class="string">"GetUserInfoByAccount error:"</span>, err.Error())</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, protocol.CODE_SYSTEM_ERROR</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> util.IsDebug() &#123;</span><br><span class="line">logger.Debug(resp)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> m.Code != protocol.CODE_OK &#123;</span><br><span class="line">log.Printf(<span class="string">"request filed:code=%d msg=%s\n"</span>, m.Code, m.Msg)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, protocol.CODE_SYSTEM_ERROR</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(resp.Infos) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, protocol.CODE_USER_NOT_EXIST</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> &amp;resp.Infos[<span class="number">0</span>], protocol.CODE_OK</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      ä¸€ä¸ªç®€å•çš„golang httpå°è£…åŠä¸€ä¸ªè°ƒç”¨çš„ä¾‹å­ï¼Œè¿˜æœ‰ä¸ªgolangè®©æ—¥å¿—æ˜¾ç¤ºè¡Œæ•°çš„ä¸€å¥è¯
    
    </summary>
    
      <category term="é»˜è®¤åˆ†ç±»" scheme="https://kitions.github.io/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/"/>
    
    
      <category term="go" scheme="https://kitions.github.io/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>go å‘ä¹‹å¹¶å‘è®¿é—®map</title>
    <link href="https://kitions.github.io/2019/03/13/go%20%E5%9D%91%E4%B9%8B%E5%B9%B6%E5%8F%91%E8%AE%BF%E9%97%AEmap/"/>
    <id>https://kitions.github.io/2019/03/13/go å‘ä¹‹å¹¶å‘è®¿é—®map/</id>
    <published>2019-03-13T06:53:22.000Z</published>
    <updated>2019-03-26T08:50:41.860Z</updated>
    
    <content type="html"><![CDATA[<h1 id="go-å‘ä¹‹å¹¶å‘è®¿é—®map"><a href="#go-å‘ä¹‹å¹¶å‘è®¿é—®map" class="headerlink" title="go å‘ä¹‹å¹¶å‘è®¿é—®map"></a>go å‘ä¹‹å¹¶å‘è®¿é—®map</h1><p> å¹¶å‘çš„å¯¹ä¸€ä¸ªmapè¿›è¡Œè¯»å†™æ˜¯æœ‰é—®é¢˜çš„ï¼Œä¸»è¦æ˜¯å†™(ps: å¹¶å‘çš„å†™mapè‚¯å®šæ˜¯ä»»ä½•è¯­è¨€éƒ½ä¸è¡Œçš„,çœŸçš„å‚»)</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ç®€æ˜“è§£å†³æ–¹æ³• </span><br><span class="line"><span class="number">1.</span> ç»™ <span class="keyword">map</span> åŠ é”</span><br><span class="line"><span class="number">2.</span> å¤åˆ¶å‡ºæ¥ä¸€ä¸ªå•ç‹¬çš„<span class="keyword">map</span></span><br><span class="line">ä»£ç <span class="number">2</span>  <span class="comment">// cloneReqå¸®åŠ©å‡½æ•°  é˜²æ­¢å¹¶å‘çš„åç¨‹ è®¿é—®åŒä¸€ä¸ªmap é€ æˆpanic</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cloneReq</span><span class="params">(req <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span> <span class="title">map</span>[<span class="title">string</span>]<span class="title">string</span></span> &#123;</span><br><span class="line">clone := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;&#125;</span><br><span class="line">lock := sync.RWMutex&#123;&#125;</span><br><span class="line">lock.RLock()</span><br><span class="line"><span class="keyword">for</span> key, value := <span class="keyword">range</span> req &#123;</span><br><span class="line">clone[key] = value</span><br><span class="line">&#125;</span><br><span class="line">lock.RUnlock()</span><br><span class="line"><span class="keyword">return</span> clone</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>goæä¾›äº†ä¸€ç§å«mapçš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥ç¿»è¯‘æˆæ˜ å°„ï¼Œå¯¹åº”äºå…¶ä»–è¯­è¨€çš„å­—å…¸ã€å“ˆå¸Œè¡¨ã€‚å€ŸåŠ©mapï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªé”®å’Œå€¼ï¼Œç„¶åå¯ä»¥ä»mapä¸­è·å–ã€è®¾ç½®å’Œåˆ é™¤è¿™ä¸ªå€¼ï¼Œå°¤å…¶é€‚åˆæ•°æ®æŸ¥æ‰¾çš„åœºæ™¯ã€‚ä½†æ˜¯mapçš„ä½¿ç”¨æœ‰ä¸€å®šçš„é™åˆ¶ï¼Œå¦‚æœæ˜¯åœ¨å•ä¸ªåç¨‹ä¸­è¯»å†™mapï¼Œé‚£ä¹ˆä¸ä¼šå­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Œå¦‚æœæ˜¯å¤šä¸ªåç¨‹å¹¶å‘è®¿é—®ä¸€ä¸ªmapï¼Œæœ‰å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºé€€å‡ºï¼Œå¹¶æ‰“å°ä¸‹é¢é”™è¯¯ä¿¡æ¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatal error: concurrent <span class="keyword">map</span> read and <span class="keyword">map</span> write</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„è¿™ä¸ªé”™è¯¯ä¸æ˜¯æ¯æ¬¡éƒ½ä¼šé‡åˆ°çš„ï¼Œå¦‚æœå¹¶å‘è®¿é—®çš„åç¨‹æ•°ä¸å¤§ï¼Œé‡åˆ°çš„å¯èƒ½æ€§å°±æ›´å°äº†ã€‚ä¾‹å¦‚ä¸‹é¢çš„ç¨‹åºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    Map := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">go</span> writeMap(Map, i, i)</span><br><span class="line">        <span class="keyword">go</span> readMap(Map, i)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readMap</span><span class="params">(Map <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>, key <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Map[key]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">writeMap</span><span class="params">(Map <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>, key <span class="keyword">int</span>, value <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    Map[key] = value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªå¾ªç¯äº†10æ¬¡ï¼Œäº§ç”Ÿäº†20ä¸ªåç¨‹å¹¶å‘è®¿é—®mapï¼Œç¨‹åºåŸºæœ¬ä¸ä¼šå‡ºé”™ï¼Œä½†æ˜¯å¦‚æœå°†å¾ªç¯æ¬¡æ•°å˜å¤§ï¼Œæ¯”å¦‚10ä¸‡ï¼Œè¿è¡Œä¸‹é¢ç¨‹åºåŸºæœ¬æ¯æ¬¡éƒ½ä¼šå‡ºé”™ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    Map := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">go</span> writeMap(Map, i, i)</span><br><span class="line">        <span class="keyword">go</span> readMap(Map, i)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readMap</span><span class="params">(Map <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>, key <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Map[key]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">writeMap</span><span class="params">(Map <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>, key <span class="keyword">int</span>, value <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    Map[key] = value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://link.jianshu.com?t=https://blog.golang.org/go-maps-in-action" target="_blank" rel="noopener">goå®˜æ–¹åšå®¢</a>æœ‰å¦‚ä¸‹è¯´æ˜ï¼š</p><blockquote><p>Maps are not safe for concurrent use: itâ€™s not defined what happens when you read and write to them simultaneously. If you need to read from and write to a map from concurrently executing goroutines, the accesses must be mediated by some kind of synchronization mechanism. One common way to protect maps is with sync.RWMutex.</p></blockquote><p>å¤§è‡´æ„æ€å°±æ˜¯è¯´ï¼Œå¹¶å‘è®¿é—®mapæ˜¯ä¸å®‰å…¨çš„ï¼Œä¼šå‡ºç°æœªå®šä¹‰è¡Œä¸ºï¼Œå¯¼è‡´ç¨‹åºé€€å‡ºã€‚æ‰€ä»¥å¦‚æœå¸Œæœ›åœ¨å¤šåç¨‹ä¸­å¹¶å‘è®¿é—®mapï¼Œå¿…é¡»æä¾›æŸç§åŒæ­¥æœºåˆ¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹é€šè¿‡è¯»å†™é”sync.RWMutexå®ç°å¯¹mapçš„å¹¶å‘è®¿é—®æ§åˆ¶ï¼Œå°†mapå’Œsync.RWMutexå°è£…ä¸€ä¸‹ï¼Œå¯ä»¥å®ç°å¯¹mapçš„å®‰å…¨å¹¶å‘è®¿é—®ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"sync"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SafeMap <span class="keyword">struct</span> &#123;</span><br><span class="line">    sync.RWMutex</span><br><span class="line">    Map <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    safeMap := newSafeMap(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">go</span> safeMap.writeMap(i, i)</span><br><span class="line">        <span class="keyword">go</span> safeMap.readMap(i)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newSafeMap</span><span class="params">(size <span class="keyword">int</span>)</span> *<span class="title">SafeMap</span></span> &#123;</span><br><span class="line">    sm := <span class="built_in">new</span>(SafeMap)</span><br><span class="line">    sm.Map = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">return</span> sm</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sm *SafeMap)</span> <span class="title">readMap</span><span class="params">(key <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    sm.RLock()</span><br><span class="line">    value := sm.Map[key]</span><br><span class="line">    sm.RUnlock()</span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sm *SafeMap)</span> <span class="title">writeMap</span><span class="params">(key <span class="keyword">int</span>, value <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    sm.Lock()</span><br><span class="line">    sm.Map[key] = value</span><br><span class="line">    sm.Unlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> åŸé“¾æ¥ï¼š<a href="https://www.jianshu.com/p/10a998089486" target="_blank" rel="noopener">https://www.jianshu.com/p/10a998089486</a>   </p>]]></content>
    
    <summary type="html">
    
      go å‘ä¹‹å¹¶å‘è®¿é—®map,å¹¶å‘çš„å¯¹ä¸€ä¸ªmapè¿›è¡Œè¯»å†™æ˜¯æœ‰é—®é¢˜çš„ï¼Œä¸»è¦æ˜¯å†™
    
    </summary>
    
      <category term="é»˜è®¤åˆ†ç±»" scheme="https://kitions.github.io/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/"/>
    
    
      <category term="go" scheme="https://kitions.github.io/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>go ä¹‹grpc è·å–æ¥çš„æ•°æ® è½¬ä¸ºjson</title>
    <link href="https://kitions.github.io/2019/02/16/grpc%20%E8%8E%B7%E5%8F%96%E6%9D%A5%E7%9A%84%E6%95%B0%E6%8D%AE%20%E8%BD%AC%E4%B8%BAjson/"/>
    <id>https://kitions.github.io/2019/02/16/grpc è·å–æ¥çš„æ•°æ® è½¬ä¸ºjson/</id>
    <published>2019-02-16T06:53:22.000Z</published>
    <updated>2019-03-05T08:26:55.301Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// grpc è·å–æ¥çš„æ•°æ® è½¬ä¸ºjson</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SmartPrint</span><span class="params">(xm <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">js, err := json.Marshal(xm)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="keyword">string</span>(js))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      SmartPrint()æ–¹æ³•
    
    </summary>
    
      <category term="é»˜è®¤åˆ†ç±»" scheme="https://kitions.github.io/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/"/>
    
    
      <category term="go" scheme="https://kitions.github.io/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>goä¹‹deferå»¶è¿Ÿå‡½æ•°</title>
    <link href="https://kitions.github.io/2018/12/03/golang-defer/"/>
    <id>https://kitions.github.io/2018/12/03/golang-defer/</id>
    <published>2018-12-03T02:13:23.000Z</published>
    <updated>2019-03-05T08:27:43.705Z</updated>
    
    <content type="html"><![CDATA[<h1 id="goä¹‹deferå»¶è¿Ÿå‡½æ•°"><a href="#goä¹‹deferå»¶è¿Ÿå‡½æ•°" class="headerlink" title="goä¹‹deferå»¶è¿Ÿå‡½æ•°"></a>goä¹‹deferå»¶è¿Ÿå‡½æ•°</h1><h5 id="Example1"><a href="#Example1" class="headerlink" title="Example1"></a>Example1</h5><h6 id="bad"><a href="#bad" class="headerlink" title="bad"></a>bad</h6><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">do</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    f, err := os.Open(<span class="string">"book.txt"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> f.Close()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ..code...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="good"><a href="#good" class="headerlink" title="good"></a>good</h6><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">do</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    f, err := os.Open(<span class="string">"book.txt"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> err := f.Close(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// log etc</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ..code...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ£€æŸ¥å¯èƒ½çš„é”™è¯¯è€Œä¸æ˜¯ç›´æ¥äº¤ç»™ defer å°±å®Œäº‹ï¼Œä½ å¯ä»¥æŠŠ defer å†…çš„ä»£ç å†™æˆä¸€ä¸ªå¸®åŠ©å‡½æ•°æ¥ç®€åŒ–æˆ‘ä»¬çš„ä»£ç ï¼Œè¿™é‡Œä¸ºäº†è®²è§£æ–¹ä¾¿å°±æ²¡æœ‰è¿›è¡Œç®€åŒ–ã€‚</span></span><br><span class="line"><span class="comment">// è¿˜å¯ä»¥é€šè¿‡å‘½åçš„è¿”å›å˜é‡æ¥è¿”å› defer å†…çš„é”™è¯¯ã€‚</span></span><br></pre></td></tr></table></figure><ol><li>å‡½æ•°ä¸ä¼šç«‹å³è°ƒç”¨</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SaveSitemap</span><span class="params">(cat <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">fd, err := os.Create(<span class="string">"sitemap/sitemap"</span> + cat + <span class="string">".xml"</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">"expected error happended when create BaikeSitemap file %v\n"</span>, err.Error())</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> fd.Close()       <span class="comment">// è¿™å„¿closeä¸å½±å“åé¢</span></span><br><span class="line">vinfo, err := GenerateSitemap(cat)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">_, err = fd.Write([]<span class="keyword">byte</span>(vinfo))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">log.Printf(<span class="string">" %v Sitemap å†™å…¥æˆåŠŸ"</span>, NameReverse[cat])</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// defer ä¼šåœ¨æœ€åæ‰§è¡Œ</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      goä¹‹deferå»¶è¿Ÿå‡½æ•°
    
    </summary>
    
      <category term="é»˜è®¤åˆ†ç±»" scheme="https://kitions.github.io/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/"/>
    
    
      <category term="go" scheme="https://kitions.github.io/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>å‰ç«¯æ€§èƒ½-chorme performance</title>
    <link href="https://kitions.github.io/2018/11/15/performance/"/>
    <id>https://kitions.github.io/2018/11/15/performance/</id>
    <published>2018-11-15T09:14:31.000Z</published>
    <updated>2018-12-05T03:36:38.351Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰ç«¯æ€§èƒ½"><a href="#å‰ç«¯æ€§èƒ½" class="headerlink" title="å‰ç«¯æ€§èƒ½"></a>å‰ç«¯æ€§èƒ½</h1><p><strong>æ€§èƒ½APIä¸Šçš„æµç¨‹æ—¶é—´ç‚¹</strong>ï¼ˆtimingçš„æ•´ä½“ç»“æ„ï¼‰<br><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fx6f9oc290j314v0ofdjm.jpg" alt="æ€§èƒ½APIä¸Šçš„æµç¨‹æ—¶é—´ç‚¹"></p><ul><li>navigationStart: è¡¨ç¤ºä»ä¸Šä¸€ä¸ªæ–‡æ¡£å¸è½½ç»“æŸæ—¶çš„ unix æ—¶é—´æˆ³ï¼Œå¦‚æœæ²¡æœ‰ä¸Šä¸€ä¸ªæ–‡æ¡£ï¼Œè¿™ä¸ªå€¼å°†å’Œ fetchStart ç›¸ç­‰ã€‚</li><li>unloadEventStart: è¡¨ç¤ºå‰ä¸€ä¸ªç½‘é¡µï¼ˆä¸å½“å‰é¡µé¢åŒåŸŸï¼‰unload çš„æ—¶é—´æˆ³ï¼Œå¦‚æœæ— å‰ä¸€ä¸ªç½‘é¡µ unload æˆ–è€…å‰ä¸€ä¸ªç½‘é¡µä¸å½“å‰é¡µé¢ä¸åŒåŸŸï¼Œåˆ™å€¼ä¸º 0ã€‚</li><li>unloadEventEnd: è¿”å›å‰ä¸€ä¸ªé¡µé¢ unload æ—¶é—´ç»‘å®šçš„å›è°ƒå‡½æ•°æ‰§è¡Œå®Œæ¯•çš„æ—¶é—´æˆ³ã€‚</li><li>redirectStart: ç¬¬ä¸€ä¸ª HTTP é‡å®šå‘å‘ç”Ÿæ—¶çš„æ—¶é—´ã€‚æœ‰è·³è½¬ä¸”æ˜¯åŒåŸŸåå†…çš„é‡å®šå‘æ‰ç®—ï¼Œå¦åˆ™å€¼ä¸º 0ã€‚</li><li>redirectEnd: æœ€åä¸€ä¸ª HTTP é‡å®šå‘å®Œæˆæ—¶çš„æ—¶é—´ã€‚æœ‰è·³è½¬ä¸”æ˜¯åŒåŸŸåå†…éƒ¨çš„é‡å®šå‘æ‰ç®—ï¼Œå¦åˆ™å€¼ä¸º 0ã€‚</li><li>fetchStart: æµè§ˆå™¨å‡†å¤‡å¥½ä½¿ç”¨ HTTP è¯·æ±‚æŠ“å–æ–‡æ¡£çš„æ—¶é—´ï¼Œè¿™å‘ç”Ÿåœ¨æ£€æŸ¥æœ¬åœ°ç¼“å­˜ä¹‹å‰ã€‚</li><li>domainLookupStart/domainLookupEnd: DNS åŸŸåæŸ¥è¯¢å¼€å§‹/ç»“æŸçš„æ—¶é—´ï¼Œå¦‚æœä½¿ç”¨äº†æœ¬åœ°ç¼“å­˜ï¼ˆå³æ—  DNS æŸ¥è¯¢ï¼‰æˆ–æŒä¹…è¿æ¥ï¼Œåˆ™ä¸ fetchStart å€¼ç›¸ç­‰</li><li>connectStart: HTTPï¼ˆTCPï¼‰å¼€å§‹/é‡æ–° å»ºç«‹è¿æ¥çš„æ—¶é—´ï¼Œå¦‚æœæ˜¯æŒä¹…è¿æ¥ï¼Œåˆ™ä¸ fetchStart å€¼ç›¸ç­‰ã€‚</li><li>connectEnd: HTTPï¼ˆTCPï¼‰ å®Œæˆå»ºç«‹è¿æ¥çš„æ—¶é—´ï¼ˆå®Œæˆæ¡æ‰‹ï¼‰ï¼Œå¦‚æœæ˜¯æŒä¹…è¿æ¥ï¼Œåˆ™ä¸ fetchStart å€¼ç›¸ç­‰ã€‚</li><li>secureConnectionStart: HTTPS è¿æ¥å¼€å§‹çš„æ—¶é—´ï¼Œå¦‚æœä¸æ˜¯å®‰å…¨è¿æ¥ï¼Œåˆ™å€¼ä¸º 0ã€‚</li><li>requestStart: HTTP è¯·æ±‚è¯»å–çœŸå®æ–‡æ¡£å¼€å§‹çš„æ—¶é—´ï¼ˆå®Œæˆå»ºç«‹è¿æ¥ï¼‰ï¼ŒåŒ…æ‹¬ä»æœ¬åœ°è¯»å–ç¼“å­˜ã€‚</li><li>responseStart: HTTP å¼€å§‹æ¥æ”¶å“åº”çš„æ—¶é—´ï¼ˆè·å–åˆ°ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼‰ï¼ŒåŒ…æ‹¬ä»æœ¬åœ°è¯»å–ç¼“å­˜ã€‚</li><li>responseEnd: HTTP å“åº”å…¨éƒ¨æ¥æ”¶å®Œæˆçš„æ—¶é—´ï¼ˆè·å–åˆ°æœ€åä¸€ä¸ªå­—èŠ‚ï¼‰ï¼ŒåŒ…æ‹¬ä»æœ¬åœ°è¯»å–ç¼“å­˜ã€‚</li><li>domLoading: å¼€å§‹è§£ææ¸²æŸ“ DOM æ ‘çš„æ—¶é—´ï¼Œæ­¤æ—¶ Document.readyState å˜ä¸º loadingï¼Œå¹¶å°†æŠ›å‡º readystatechange ç›¸å…³äº‹ä»¶ã€‚</li><li>domInteractive: å®Œæˆè§£æ DOM æ ‘çš„æ—¶é—´ï¼ŒDocument.readyState å˜ä¸º interactiveï¼Œå¹¶å°†æŠ›å‡º readystatechange ç›¸å…³äº‹ä»¶ï¼Œæ³¨æ„åªæ˜¯ DOM æ ‘è§£æå®Œæˆï¼Œè¿™æ—¶å€™å¹¶æ²¡æœ‰å¼€å§‹åŠ è½½ç½‘é¡µå†…çš„èµ„æºã€‚</li><li>domContentLoadedEventStart: DOM è§£æå®Œæˆåï¼Œç½‘é¡µå†…èµ„æºåŠ è½½å¼€å§‹çš„æ—¶é—´ï¼Œåœ¨ DOMContentLoaded äº‹ä»¶æŠ›å‡ºå‰å‘ç”Ÿã€‚</li><li>domContentLoadedEventEnd: DOM è§£æå®Œæˆåï¼Œç½‘é¡µå†…èµ„æºåŠ è½½å®Œæˆçš„æ—¶é—´ï¼ˆå¦‚ JS è„šæœ¬åŠ è½½æ‰§è¡Œå®Œæ¯•ï¼‰ã€‚</li><li>domComplete: DOM æ ‘è§£æå®Œæˆï¼Œä¸”èµ„æºä¹Ÿå‡†å¤‡å°±ç»ªçš„æ—¶é—´ï¼ŒDocument.readyState å˜ä¸º completeï¼Œå¹¶å°†æŠ›å‡º readystatechange ç›¸å…³äº‹ä»¶ã€‚</li><li>loadEventStart: load äº‹ä»¶å‘é€ç»™æ–‡æ¡£ï¼Œä¹Ÿå³ load å›è°ƒå‡½æ•°å¼€å§‹æ‰§è¡Œçš„æ—¶é—´ã€‚</li><li>loadEventEnd: load äº‹ä»¶çš„å›è°ƒå‡½æ•°æ‰§è¡Œå®Œæ¯•çš„æ—¶é—´ã€‚</li></ul><p>or</p><ul><li><p><code>startTime</code>ï¼šæœ‰äº›æµè§ˆå™¨å®ç°ä¸º<a href="https://msdn.microsoft.com/en-us/library/ff974724(v=vs.85" target="_blank" rel="noopener"><code>navigationStart</code></a>.aspx)ï¼Œä»£è¡¨æµè§ˆå™¨å¼€å§‹unloadå‰ä¸€ä¸ªé¡µé¢æ–‡æ¡£çš„å¼€å§‹æ—¶é—´èŠ‚ç‚¹ã€‚æ¯”å¦‚æˆ‘ä»¬å½“å‰æ­£åœ¨æµè§ˆbaidu.comï¼Œåœ¨åœ°å€æ è¾“å…¥google.comå¹¶å›è½¦ï¼Œæµè§ˆå™¨çš„æ‰§è¡ŒåŠ¨ä½œä¾æ¬¡ä¸ºï¼šunloadå½“å‰æ–‡æ¡£ï¼ˆå³baidu.comï¼‰-&gt;è¯·æ±‚ä¸‹ä¸€æ–‡æ¡£ï¼ˆå³google.comï¼‰ã€‚navigationStartçš„å€¼ä¾¿æ˜¯è§¦å‘unloadå½“å‰æ–‡æ¡£çš„æ—¶é—´èŠ‚ç‚¹ã€‚</p><blockquote><p>å¦‚æœå½“å‰æ–‡æ¡£ä¸ºç©ºï¼Œåˆ™navigationStartçš„å€¼ç­‰äºfetchStartã€‚</p></blockquote></li><li><p><code>redirectStart</code>å’Œ<code>redirectEnd</code>ï¼šå¦‚æœé¡µé¢æ˜¯ç”±redirectè€Œæ¥ï¼Œåˆ™redirectStartå’ŒredirectEndåˆ†åˆ«ä»£è¡¨redirectå¼€å§‹å’Œç»“æŸçš„æ—¶é—´èŠ‚ç‚¹ï¼›</p></li><li><p><code>unloadEventStart</code>å’Œ<code>unloadEventEnd</code>ï¼šå¦‚æœå‰ä¸€ä¸ªæ–‡æ¡£å’Œè¯·æ±‚çš„æ–‡æ¡£æ˜¯åŒä¸€ä¸ªåŸŸçš„ï¼Œåˆ™<code>unloadEventStart</code>å’Œ<code>unloadEventEnd</code>åˆ†åˆ«ä»£è¡¨æµè§ˆå™¨unloadå‰ä¸€ä¸ªæ–‡æ¡£çš„å¼€å§‹å’Œç»“æŸæ—¶é—´èŠ‚ç‚¹ã€‚å¦åˆ™ä¸¤è€…éƒ½ç­‰äº0ï¼›</p></li><li><p><code>fetchStart</code>æ˜¯æŒ‡åœ¨æµè§ˆå™¨å‘èµ·ä»»ä½•è¯·æ±‚ä¹‹å‰çš„æ—¶é—´å€¼ã€‚åœ¨fetchStartå’Œ<code>domainLookupStart</code>ä¹‹é—´ï¼Œæµè§ˆå™¨ä¼šæ£€æŸ¥å½“å‰æ–‡æ¡£çš„ç¼“å­˜ï¼›</p></li><li><p><code>domainLookupStart</code>å’Œ<code>domainLookupEnd</code>åˆ†åˆ«ä»£è¡¨DNSæŸ¥è¯¢çš„å¼€å§‹å’Œç»“æŸæ—¶é—´èŠ‚ç‚¹ã€‚å¦‚æœæµè§ˆå™¨æ²¡æœ‰è¿›è¡ŒDNSæŸ¥è¯¢ï¼ˆæ¯”å¦‚ä½¿ç”¨äº†cacheï¼‰ï¼Œåˆ™ä¸¤è€…çš„å€¼éƒ½ç­‰äº<code>fetchStart</code>ï¼›</p></li><li><p><code>connectStart</code>å’Œ<code>connectEnd</code>åˆ†åˆ«ä»£è¡¨TCPå»ºç«‹è¿æ¥å’Œè¿æ¥æˆåŠŸçš„æ—¶é—´èŠ‚ç‚¹ã€‚å¦‚æœæµè§ˆå™¨æ²¡æœ‰è¿›è¡ŒTCPè¿æ¥ï¼ˆæ¯”å¦‚ä½¿ç”¨æŒä¹…åŒ–è¿æ¥webscoketï¼‰ï¼Œåˆ™ä¸¤è€…éƒ½ç­‰äº<code>domainLookupEnd</code>ï¼›</p></li><li><p><code>secureConnectionStart</code>ï¼šå¯é€‰ã€‚å¦‚æœé¡µé¢ä½¿ç”¨HTTPSï¼Œå®ƒçš„å€¼æ˜¯å®‰å…¨è¿æ¥æ¡æ‰‹ä¹‹å‰çš„æ—¶åˆ»ã€‚å¦‚æœè¯¥å±æ€§ä¸å¯ç”¨ï¼Œåˆ™è¿”å›undefinedã€‚å¦‚æœè¯¥å±æ€§å¯ç”¨ï¼Œä½†æ²¡æœ‰ä½¿ç”¨HTTPSï¼Œåˆ™è¿”å›0ï¼›</p></li><li><p><code>requestStart</code>ä»£è¡¨æµè§ˆå™¨å‘èµ·è¯·æ±‚çš„æ—¶é—´èŠ‚ç‚¹ï¼Œè¯·æ±‚çš„æ–¹å¼å¯ä»¥æ˜¯è¯·æ±‚æœåŠ¡å™¨ã€ç¼“å­˜ã€æœ¬åœ°èµ„æºç­‰ï¼›</p></li><li><p><code>responseStart</code>å’Œ<code>responseEnd</code>åˆ†åˆ«ä»£è¡¨æµè§ˆå™¨æ”¶åˆ°ä»æœåŠ¡å™¨ç«¯ï¼ˆæˆ–ç¼“å­˜ã€æœ¬åœ°èµ„æºï¼‰å“åº”å›çš„ç¬¬ä¸€ä¸ªå­—èŠ‚å’Œæœ€åä¸€ä¸ªå­—èŠ‚æ•°æ®çš„æ—¶åˆ»ï¼›</p></li><li><p><code>domLoading</code>ä»£è¡¨æµè§ˆå™¨å¼€å§‹è§£æhtmlæ–‡æ¡£çš„æ—¶é—´èŠ‚ç‚¹ã€‚æˆ‘ä»¬çŸ¥é“IEæµè§ˆå™¨ä¸‹çš„documentæœ‰<code>readyState</code>å±æ€§ï¼Œ<code>domLoading</code>çš„å€¼å°±ç­‰äº<code>readyState</code>æ”¹å˜ä¸º<code>loading</code>çš„æ—¶é—´èŠ‚ç‚¹ï¼›</p></li><li><p><code>domInteractive</code>ä»£è¡¨æµè§ˆå™¨è§£æhtmlæ–‡æ¡£çš„çŠ¶æ€ä¸º<code>interactive</code>æ—¶çš„æ—¶é—´èŠ‚ç‚¹ã€‚<code>domInteractive</code>å¹¶éDOMReadyï¼Œå®ƒæ—©äºDOMReadyè§¦å‘ï¼Œä»£è¡¨htmlæ–‡æ¡£è§£æå®Œæ¯•ï¼ˆå³dom treeåˆ›å»ºå®Œæˆï¼‰ä½†æ˜¯å†…åµŒèµ„æºï¼ˆæ¯”å¦‚å¤–é“¾cssã€jsç­‰ï¼‰è¿˜æœªåŠ è½½çš„æ—¶é—´ç‚¹ï¼›</p></li><li><p><code>domContentLoadedEventStart</code>ï¼šä»£è¡¨<code>DOMContentLoaded</code>äº‹ä»¶è§¦å‘çš„æ—¶é—´èŠ‚ç‚¹ï¼š</p><blockquote><p>é¡µé¢æ–‡æ¡£å®Œå…¨åŠ è½½å¹¶è§£æå®Œæ¯•ä¹‹å,ä¼šè§¦å‘DOMContentLoadedäº‹ä»¶ï¼ŒHTMLæ–‡æ¡£ä¸ä¼šç­‰å¾…æ ·å¼æ–‡ä»¶,å›¾ç‰‡æ–‡ä»¶,å­æ¡†æ¶é¡µé¢çš„åŠ è½½(loadäº‹ä»¶å¯ä»¥ç”¨æ¥æ£€æµ‹HTMLé¡µé¢æ˜¯å¦å®Œå…¨åŠ è½½å®Œæ¯•(fully-loaded))ã€‚</p></blockquote></li><li><p><code>domContentLoadedEventEnd</code>ï¼šä»£è¡¨<code>DOMContentLoaded</code>äº‹ä»¶å®Œæˆçš„æ—¶é—´èŠ‚ç‚¹ï¼Œæ­¤åˆ»ç”¨æˆ·å¯ä»¥å¯¹é¡µé¢è¿›è¡Œæ“ä½œï¼Œä¹Ÿå°±æ˜¯JS è„šæœ¬åŠ è½½æ‰§è¡Œå®Œæ¯•æˆ–è€…jQueryä¸­çš„domreadyæ—¶é—´ï¼›</p></li><li><p><code>domComplete</code>ï¼šhtmlæ–‡æ¡£å®Œå…¨è§£æå®Œæ¯•çš„æ—¶é—´èŠ‚ç‚¹ï¼›</p></li><li><p><code>loadEventStart</code>å’Œ<code>loadEventEnd</code>åˆ†åˆ«ä»£è¡¨onloadäº‹ä»¶è§¦å‘å’Œç»“æŸçš„æ—¶é—´èŠ‚ç‚¹</p></li></ul><p><strong>DOMçš„æ—¶é—´ç‚¹</strong></p><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fx6fc3x5quj309n08umxm.jpg" alt=""></p><p>ä¸Šå›¾å‡ ä¸ªDOMæ—¶é—´ç‚¹çš„è§£é‡Šï¼š</p><ul><li><p>domLoadingï¼šè¿™æ˜¯æ•´ä¸ªè¿‡ç¨‹çš„èµ·å§‹æ—¶é—´æˆ³ï¼Œæµè§ˆå™¨å³å°†å¼€å§‹è§£æç¬¬ä¸€æ‰¹æ”¶åˆ°çš„ HTML æ–‡æ¡£å­—èŠ‚ã€‚</p></li><li><p>domInteractiveï¼šè¡¨ç¤ºæµè§ˆå™¨å®Œæˆå¯¹æ‰€æœ‰ HTML çš„è§£æå¹¶ä¸” DOM æ„å»ºå®Œæˆçš„æ—¶é—´ç‚¹ã€‚</p></li><li><p>domContentLoadedï¼šè¡¨ç¤º DOM å‡†å¤‡å°±ç»ªå¹¶ä¸”æ²¡æœ‰æ ·å¼è¡¨é˜»æ­¢ JavaScript æ‰§è¡Œçš„æ—¶é—´ç‚¹ï¼Œè¿™æ„å‘³ç€ç°</p><p>åœ¨æˆ‘ä»¬å¯ä»¥æ„å»ºæ¸²æŸ“æ ‘äº†ã€‚</p><ul><li>è®¸å¤š JavaScript æ¡†æ¶éƒ½ä¼šç­‰å¾…æ­¤äº‹ä»¶å‘ç”Ÿåï¼Œæ‰å¼€å§‹æ‰§è¡Œå®ƒä»¬è‡ªå·±çš„é€»è¾‘ã€‚å› æ­¤ï¼Œæµè§ˆå™¨ä¼šæ•è·<br>EventStart å’Œ EventEnd æ—¶é—´æˆ³ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿè¿½è¸ªæ‰§è¡Œæ‰€èŠ±è´¹çš„æ—¶é—´ã€‚</li></ul></li><li><p>domCompleteï¼šé¡¾åæ€ä¹‰ï¼Œæ‰€æœ‰å¤„ç†å®Œæˆï¼Œå¹¶ä¸”ç½‘é¡µä¸Šçš„æ‰€æœ‰èµ„æºï¼ˆå›¾åƒç­‰ï¼‰éƒ½å·²ä¸‹è½½å®Œæ¯•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒåŠ è½½è½¬ç¯å·²åœæ­¢æ—‹è½¬ã€‚</p></li><li><p>loadEventï¼šä½œä¸ºæ¯ä¸ªç½‘é¡µåŠ è½½çš„æœ€åä¸€æ­¥ï¼Œæµè§ˆå™¨ä¼šè§¦å‘ onload äº‹ä»¶ï¼Œä»¥ä¾¿è§¦å‘é¢å¤–çš„åº”ç”¨é€»è¾‘ã€‚</p></li></ul><h4 id="2-2-2-è®¡ç®—æ€§èƒ½æŒ‡æ ‡"><a href="#2-2-2-è®¡ç®—æ€§èƒ½æŒ‡æ ‡" class="headerlink" title="2.2.2 è®¡ç®—æ€§èƒ½æŒ‡æ ‡"></a>2.2.2 è®¡ç®—æ€§èƒ½æŒ‡æ ‡</h4><p>å¯ä»¥ä½¿ç”¨<code>Navigation.timing</code> ç»Ÿè®¡åˆ°çš„æ—¶é—´æ•°æ®æ¥è®¡ç®—ä¸€äº›é¡µé¢æ€§èƒ½æŒ‡æ ‡ï¼Œæ¯”å¦‚DNSæŸ¥è¯¢è€—æ—¶ã€ç™½å±æ—¶é—´ã€domreadyç­‰ç­‰ã€‚å¦‚ä¸‹ï¼š</p><ul><li>DNSæŸ¥è¯¢è€—æ—¶ = domainLookupEnd - domainLookupStart</li><li>TCPé“¾æ¥è€—æ—¶ = connectEnd - connectStart</li><li>requestè¯·æ±‚è€—æ—¶ = responseEnd - responseStart</li><li>è§£ædomæ ‘è€—æ—¶ = domComplete - domInteractive</li><li>ç™½å±æ—¶é—´ = domloadng - fetchStart</li><li>domreadyæ—¶é—´ = domContentLoadedEventEnd - fetchStart</li><li>onloadæ—¶é—´ = loadEventEnd - fetchStart</li></ul><h3 id="W3C-API"><a href="#W3C-API" class="headerlink" title="W3C API"></a>W3C API</h3><p>window.performance æ˜¯W3Cæ€§èƒ½å°ç»„å¼•å…¥çš„æ–°çš„APIï¼Œç›®å‰IE9ä»¥ä¸Šçš„æµè§ˆå™¨éƒ½æ”¯æŒã€‚åœ¨Console Tabä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¾“å…¥window.performance.timingæ¥æŸ¥è¯¢åˆ°æµè§ˆå™¨æ˜¾ç¤ºä¸€ä¸ªé¡µé¢ï¼Œå„ä¸ªé˜¶æ®µæ‰€è€—è´¹çš„æ—¶é—´ã€‚</p><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fx6fhyllqej30bf0d70ue.jpg" alt=""></p><p>é™¤äº†timingå­—æ®µï¼Œperformanceè¿˜æœ‰å‡ ä¸ªå­—æ®µï¼Œå¯ä»¥è®©æˆ‘ä»¬å¯¹é¡µé¢è¿›è¡Œæ›´å¥½çš„åˆ†æ</p><ol><li><p>memoryå­—æ®µä»£è¡¨çš„æ˜¯JSå¯¹å†…å­˜çš„å ç”¨</p></li><li><p>navigationå­—æ®µç»Ÿè®¡çš„æ˜¯ä¸€äº›ç½‘é¡µå¯¼èˆªã€‚</p><p>2.1.  redirectCount åŒæºé‡å®šå‘çš„æ•°é‡ç­‰</p><p>2.2.  type è¿”å›å€¼æ˜¯0ï¼Œ1ï¼Œ2ï¼Œ</p><ul><li>0 : TYPE_NAVIGATE (ç”¨æˆ·é€šè¿‡å¸¸è§„å¯¼èˆªæ–¹å¼è®¿é—®é¡µé¢ï¼Œæ¯”å¦‚ç‚¹ä¸€ä¸ªé“¾æ¥ï¼Œæˆ–è€…ä¸€èˆ¬çš„getæ–¹å¼)</li><li>1 : TYPE_RELOAD (ç”¨æˆ·é€šè¿‡åˆ·æ–°ï¼ŒåŒ…æ‹¬JSè°ƒç”¨åˆ·æ–°æ¥å£ç­‰æ–¹å¼è®¿é—®é¡µé¢)</li><li>2 : TYPE_BACK_FORWARD (ç”¨æˆ·é€šè¿‡åé€€æŒ‰é’®è®¿é—®æœ¬é¡µé¢)</li></ul></li></ol><h3 id="chrome-API"><a href="#chrome-API" class="headerlink" title="chrome API"></a>chrome API</h3><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fx6fjvukvaj30c10frmzg.jpg" alt=""></p><h2 id="performance"><a href="#performance" class="headerlink" title="performance"></a>performance</h2><p>ä¹‹å‰chormeè€ç‰ˆæœ¬åä¸ºtimelineï¼ŒæŒ‡çš„æ˜¯å½“ä½ çš„é¡µé¢åœ¨æµè§ˆå™¨è¿è¡Œæ—¶çš„æ€§èƒ½è¡¨ç°ï¼Œç”¨è¿™ä¸ªperformanceåŠŸèƒ½å»åˆ†æResponse, Animation, ä»¥åŠ Idle è¿™ä¸‰ä¸ªæ€§èƒ½æŒ‡æ ‡ã€‚</p><h3 id="Begin"><a href="#Begin" class="headerlink" title="Begin"></a>Begin</h3><ol><li>æ‰“å¼€Chromeçš„åŒ¿åæ¨¡å¼ã€‚åŒ¿åæ¨¡å¼å¯ä»¥ä¿è¯Chromeåœ¨ä¸€ä¸ªç›¸å¯¹å¹²å‡€çš„ç¯å¢ƒä¸‹è¿è¡Œã€‚æ¯”å¦‚ï¼Œä½ å®‰è£…äº†è®¸å¤šchromeæ’ä»¶ï¼Œè¿™äº›æ’ä»¶å¯èƒ½ä¼šå½±å“æˆ‘ä»¬åˆ†ææ€§èƒ½è¡¨ç°ã€‚</li><li>åœ¨åŒ¿åæ¨¡å¼ä¸‹æ‰“å¼€å³è¾¹è¿™ä¸ªé“¾æ¥ï¼Œ<a href="https://googlechrome.github.io/devtools-samples/jank/" target="_blank" rel="noopener">DEMO</a>ï¼Œè¿™ä¸ªç½‘é¡µå°±æ˜¯æˆ‘ä»¬è¦ç”¨æ¥åˆ†æçš„DEMOã€‚è¿™ä¸ªé¡µé¢é‡Œéƒ½æ˜¯å¾ˆå¤šä¸Šä¸‹ç§»åŠ¨çš„è“è‰²å°æ–¹å—ã€‚</li><li>å³é”®æ£€æŸ¥Command+Opiton+Iï¼ˆMacï¼‰æˆ–è€…Control+shift+I (Windows, Linux) æ¥æ‰“å¼€Devtoolsã€‚</li><li>å¼€å‘ä½¿ç”¨çš„ç”µè„‘é…ç½®æ™®éè¾ƒé«˜ï¼Œåœ¨Performanceé€‰é¡¹å¡ä¸­ï¼Œå¯¹äºCPUï¼Œé€‰æ‹©4xå‡é€Ÿã€‚DevToolsé™åˆ¶ä½ çš„CPUï¼Œä½¿å…¶æ¯”å¹³æ—¶æ…¢4å€ã€‚</li></ol><blockquote><p>å¦‚æœè¦ç¡®ä¿å®ƒä»¬åœ¨ä½ç«¯ç§»åŠ¨è®¾å¤‡ä¸Šè¿è¡Œè‰¯å¥½ï¼Œè¯·å°†CPUé™åˆ¶è®¾ç½®ä¸º<strong>20xå‡é€Ÿ</strong>ã€‚</p></blockquote><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fwwyn0656fj30v40j441i.jpg" alt="performance"></p><ol><li>control æ¡ï¼Œæœ€ä¸Šé¢ä¸€æ¡ï¼Œæœ‰å½•åˆ¶ï¼Œåˆ·æ–°é¡µé¢ï¼Œæ¸…é™¤ç»“æœç­‰æ“ä½œ</li><li>overviewæ€»è§ˆå›¾ï¼Œæ¨ªè½´æ˜¯æ—¶é—´çº¿ï¼ŒåŒ…å«fpså¸§ç‡ï¼Œcpuå ç”¨ï¼Œnetç½‘ç»œè¯·æ±‚ï¼Œé¡µé¢æ€§èƒ½çš„æ±‡æ€»</li><li>ç«ç„°å›¾ï¼ŒNetworkï¼ŒFrames, Interactions, Mainç­‰ </li><li>æ€»ç»“ï¼šç²¾ç¡®åˆ°æ¯«ç§’çº§çš„åˆ†æï¼ŒæŒ‰è°ƒç”¨å±‚çº§ï¼Œäº‹ä»¶åˆ†ç±»çš„æ•´ç†</li></ol><p>åœ¨ç«ç„°å›¾çš„networkä¸­ ï¼š </p><ol><li>HTML æ–‡ä»¶ä¸ºè“è‰²ã€‚ </li><li>è„šæœ¬ä¸ºé»„è‰²ã€‚ </li><li>æ ·å¼è¡¨ä¸ºç´«è‰²ã€‚ </li><li>åª’ä½“æ–‡ä»¶ä¸ºç»¿è‰²ã€‚ </li><li>å…¶ä»–èµ„æºä¸ºç°è‰²ã€‚</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">with</span>(performance)&#123;</span><br><span class="line">            readyStart = timing.fetchStart - timing.navigationStart;</span><br><span class="line">            redirectTime = timing.redirectEnd  - timing.redirectStart;</span><br><span class="line">            appcacheTime = timing.domainLookupStart  - timing.fetchStart;</span><br><span class="line">            unloadEventTime = timing.unloadEventEnd - timing.unloadEventStart;</span><br><span class="line">            lookupDomainTime = timing.domainLookupEnd - timing.domainLookupStart;</span><br><span class="line">            connectTime = timing.connectEnd - timing.connectStart;</span><br><span class="line">            requestTime = timing.responseEnd - timing.requestStart;</span><br><span class="line">            initDomTreeTime = timing.domInteractive - timing.responseEnd;</span><br><span class="line">            domReadyTime = timing.domContentLoadedEventEnd - timing.navigationStart;</span><br><span class="line">            loadTime = timing.loadEventEnd - timing.navigationStart;</span><br><span class="line">             <span class="comment">//è¿‡æ—©è·å–æ—¶ domCompleteæœ‰æ—¶ä¼šæ˜¯0loadEventTime = timing.loadEventEnd - timing.loadEventStart;loadTime = timing.loadEventEnd - timing.navigationStart;</span></span><br><span class="line">             <span class="comment">//è¿‡æ—©è·å–æ—¶ loadEventEndæœ‰æ—¶ä¼šæ˜¯0</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'å‡†å¤‡æ–°é¡µé¢æ—¶é—´è€—æ—¶: '</span> + readyStart);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'redirect é‡å®šå‘è€—æ—¶: '</span> + redirectTime);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'Appcache è€—æ—¶: '</span> + appcacheTime);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'unload å‰æ–‡æ¡£è€—æ—¶: '</span> + unloadEventTime);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'DNS æŸ¥è¯¢è€—æ—¶: '</span> + lookupDomainTime);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'TCPè¿æ¥è€—æ—¶: '</span> + connectTime);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'requestè¯·æ±‚è€—æ—¶: '</span> + requestTime);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'è¯·æ±‚å®Œæ¯•è‡³DOMåŠ è½½: '</span> + initDomTreeTime);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'DOMåŠ è½½å®Œæˆ: '</span> + domReadyTime);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'ä»å¼€å§‹è‡³loadæ€»è€—æ—¶: '</span> + loadTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="number">2000</span>) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡åˆ†æï¼Œå‘ç°ç”¨æ­¤æ–¹æ³• DOMåŠ è½½å®Œæˆå’Œå…¨éƒ¨åŠ è½½å®Œæˆè€—ç”¨çš„æ—¶é—´å’Œchromeæµè§ˆå™¨NETWORDKé¢æ¿ä¸Šæ˜¾ç¤ºçš„DomContentLoaded ã€Loadæ—¶é—´åŸºæœ¬ä¸€è‡´ï¼Œè¯¯å·®å‡ msï¼Œ<br> æ‰€ä»¥æˆ‘ä»¬åŸºæœ¬ä¸Šå¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•æ¥ç»Ÿè®¡æˆ‘ä»¬æ‰€åšçš„H5ç½‘ç«™åœ¨ä¸åŒåœ°åŸŸã€ä¸åŒå®¢æˆ·ç«¯ä¸‹åŠ è½½H5æ‰€è€—ç”¨çš„æ—¶é—´ï¼Œè¿›è€Œé€ä¸ªä¼˜åŒ–ã€‚æ¯”å¦‚DNSè€—æ—¶, DOMåŠ è½½è€—æ—¶äº† </p><h3 id="reflowï¼ˆå›æµï¼‰"><a href="#reflowï¼ˆå›æµï¼‰" class="headerlink" title="reflowï¼ˆå›æµï¼‰"></a>reflowï¼ˆå›æµï¼‰</h3><p>è¯´åˆ°é¡µé¢ä¸ºä»€ä¹ˆä¼šæ…¢ï¼Ÿé‚£æ˜¯å› ä¸ºæµè§ˆå™¨è¦èŠ±æ—¶é—´ã€èŠ±ç²¾åŠ›å»æ¸²æŸ“ï¼Œå°¤å…¶æ˜¯å½“å®ƒå‘ç°æŸä¸ªéƒ¨åˆ†å‘ç”Ÿäº†ç‚¹å˜åŒ–å½±å“äº†å¸ƒå±€ï¼Œéœ€è¦å€’å›å»é‡æ–°æ¸²æŸ“ï¼Œ è¯¥è¿‡ç¨‹ç§°ä¸º<strong>reflowï¼ˆå›æµï¼‰ã€‚</strong></p><p>åœ¨æµè§ˆå™¨çš„æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼ˆé¡µé¢åˆå§‹åŒ–ï¼Œç”¨æˆ·è¡Œä¸ºæ”¹å˜é¡µé¢æ ·å¼ï¼ŒåŠ¨ç”»æ”¹å˜é¡µé¢æ ·å¼ï¼‰ reflowï¼ˆå›æµï¼‰repaint(é‡ç»˜)éƒ½ä¼šå¤§å¤§å½±å“webæ€§èƒ½ï¼Œå°¤å…¶æ˜¯h5é¡µé¢ã€‚</p><p>reflow å‡ ä¹æ˜¯æ— æ³•é¿å…çš„ã€‚ç°åœ¨ç•Œé¢ä¸Šæµè¡Œçš„ä¸€äº›æ•ˆæœï¼Œæ¯”å¦‚æ ‘çŠ¶ç›®å½•çš„æŠ˜å ã€å±•å¼€ï¼ˆå®è´¨ä¸Šæ˜¯å…ƒç´ çš„æ˜¾ç¤ºä¸éšè—ï¼‰ç­‰ï¼Œéƒ½å°†å¼•èµ·æµè§ˆå™¨çš„ reflowã€‚é¼ æ ‡æ»‘è¿‡ã€ç‚¹å‡»â€¦â€¦åªè¦è¿™äº›è¡Œä¸ºå¼•èµ·äº†é¡µé¢ä¸ŠæŸäº›å…ƒç´ çš„å ä½é¢ç§¯ã€å®šä½æ–¹å¼ã€è¾¹è·ç­‰å±æ€§çš„å˜åŒ–ï¼Œéƒ½ä¼šå¼•èµ·å®ƒå†…éƒ¨ã€å‘¨å›´ç”šè‡³æ•´ä¸ªé¡µé¢çš„é‡æ–°æ¸² æŸ“ã€‚é€šå¸¸æˆ‘ä»¬éƒ½æ— æ³•é¢„ä¼°æµè§ˆå™¨åˆ°åº•ä¼š reflow å“ªä¸€éƒ¨åˆ†çš„ä»£ç ï¼Œå®ƒä»¬éƒ½å½¼æ­¤ç›¸äº’å½±å“ç€ã€‚</p>]]></content>
    
    <summary type="html">
    
      chorme performanceï¼Œä¹‹å‰chormeè€ç‰ˆæœ¬åä¸ºtimelineï¼ŒæŒ‡çš„æ˜¯å½“ä½ çš„é¡µé¢åœ¨æµè§ˆå™¨è¿è¡Œæ—¶çš„æ€§èƒ½è¡¨ç°ï¼Œç”¨è¿™ä¸ªperformanceåŠŸèƒ½å»åˆ†æResponse, Animation, ä»¥åŠ Idle è¿™ä¸‰ä¸ªæ€§èƒ½æŒ‡æ ‡ã€‚
    
    </summary>
    
      <category term="é»˜è®¤åˆ†ç±»" scheme="https://kitions.github.io/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/"/>
    
    
      <category term="æ€§èƒ½" scheme="https://kitions.github.io/tags/%E6%80%A7%E8%83%BD/"/>
    
  </entry>
  
  <entry>
    <title>Rxjsæµ…æµ…æ»´å­¦ä¹ </title>
    <link href="https://kitions.github.io/2018/11/04/Rxjs/"/>
    <id>https://kitions.github.io/2018/11/04/Rxjs/</id>
    <published>2018-11-04T07:44:35.000Z</published>
    <updated>2018-12-05T03:35:13.356Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Rxjsæµ…æµ…æ»´å­¦ä¹ "><a href="#Rxjsæµ…æµ…æ»´å­¦ä¹ " class="headerlink" title="Rxjsæµ…æµ…æ»´å­¦ä¹ "></a>Rxjsæµ…æµ…æ»´å­¦ä¹ </h1><p>æˆ‘ä»¬éƒ½çŸ¥é“ JS æ˜¯ä»€ä¹ˆï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯ Rx å‘¢ï¼ŸRx æ˜¯ Reactive Extensionï¼ˆä¹Ÿå« ReactiveXï¼‰çš„ç®€ç§°ï¼ŒæŒ‡çš„æ˜¯å®è·µå“åº”å¼ç¼–ç¨‹çš„ä¸€å¥—å·¥å…·ï¼Œ<a href="http://reactivex.io/" target="_blank" rel="noopener">Rx å®˜ç½‘</a>é¦–é¡µçš„ä»‹ç»æ˜¯ä¸€å¥—é€šè¿‡å¯ç›‘å¬æµæ¥åšå¼‚æ­¥ç¼–ç¨‹çš„ APIï¼ˆAn API for asynchronous programming with observable streamsï¼‰ã€‚</p><p>RxJS æ˜¯åŸºäºè§‚å¯Ÿè€…æ¨¡å¼å’Œè¿­ä»£å™¨æ¨¡å¼ä»¥å‡½æ•°å¼ç¼–ç¨‹æ€ç»´æ¥å®ç°çš„ã€‚</p><h3 id="RxJS-çš„ç‰¹ç‚¹"><a href="#RxJS-çš„ç‰¹ç‚¹" class="headerlink" title="RxJS çš„ç‰¹ç‚¹"></a>RxJS çš„ç‰¹ç‚¹</h3><ul><li>æ•°æ®æµæŠ½è±¡äº†å¾ˆå¤šç°å®é—®é¢˜</li><li>æ“…é•¿å¤„ç†å¼‚æ­¥é—®é¢˜</li><li>æŠŠå¤æ‚é—®é¢˜åˆ†è§£ä¸ºç®€å•é—®é¢˜çš„ç»„åˆ</li></ul><p>å‰ç«¯ä¸­çš„ DOM äº‹ä»¶ã€WebSocket æ¨é€æ¶ˆæ¯ã€AJAX è¯·æ±‚èµ„æºã€åŠ¨ç”»éƒ½å¯ä»¥çœ‹ä½œæ˜¯æ•°æ®æµã€‚</p><p>RxJS å¯¹æ•°æ®é‡‡ç”¨â€œæ¨â€çš„æ–¹å¼ï¼Œå½“ä¸€ä¸ªæ•°æ®äº§ç”Ÿæ—¶ï¼Œä¼šå°†å…¶æ¨é€ç»™å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œè¿™ä¸ªå¤„ç†å‡½æ•°ä¸ç”¨å…³å¿ƒæ•°æ®æ—¶åŒæ­¥äº§ç”Ÿè¿˜æ˜¯å¼‚æ­¥äº§ç”Ÿçš„ï¼Œå› æ­¤å¤„ç†å¼‚æ­¥å°†ä¼šå˜å¾—éå¸¸ç®€å•ã€‚</p><p>RxJS ä¸­å¾ˆå¤šæ“ä½œç¬¦ï¼Œæ¯ä¸ªæ“ä½œç¬¦éƒ½æä¾›äº†ä¸€ä¸ªå°åŠŸèƒ½ï¼Œå­¦ä¹  RxJS æœ€é‡è¦çš„å°±æ˜¯å­¦ä¹ å¦‚ä½•ç»„åˆæ“ä½œç¬¦æ¥è§£å†³å¤æ‚é—®é¢˜ã€‚</p><p>åœ¨ RxJS ä¸­ç”¨æ¥è§£å†³å¼‚æ­¥äº‹ä»¶ç®¡ç†çš„çš„åŸºæœ¬æ¦‚å¿µæ˜¯ï¼š</p><ul><li><strong>Observable (å¯è§‚å¯Ÿå¯¹è±¡):</strong> è¡¨ç¤ºä¸€ä¸ªæ¦‚å¿µï¼Œè¿™ä¸ªæ¦‚å¿µæ˜¯ä¸€ä¸ªå¯è°ƒç”¨çš„æœªæ¥å€¼æˆ–äº‹ä»¶çš„é›†åˆã€‚</li><li><strong>Observer (è§‚å¯Ÿè€…):</strong> ä¸€ä¸ªå›è°ƒå‡½æ•°çš„é›†åˆï¼Œå®ƒçŸ¥é“å¦‚ä½•å»ç›‘å¬ç”± Observable æä¾›çš„å€¼ã€‚</li><li><strong>Subscription (è®¢é˜…):</strong> è¡¨ç¤º Observable çš„æ‰§è¡Œï¼Œä¸»è¦ç”¨äºå–æ¶ˆ Observable çš„æ‰§è¡Œã€‚</li><li><strong>Operators (æ“ä½œç¬¦):</strong> é‡‡ç”¨å‡½æ•°å¼ç¼–ç¨‹é£æ ¼çš„çº¯å‡½æ•° (pure function)ï¼Œä½¿ç”¨åƒ <code>map</code>ã€<code>filter</code>ã€<code>concat</code>ã€<code>flatMap</code> ç­‰è¿™æ ·çš„æ“ä½œç¬¦æ¥å¤„ç†é›†åˆã€‚</li><li><strong>Subject (ä¸»ä½“):</strong> ç›¸å½“äº EventEmitterï¼Œå¹¶ä¸”æ˜¯å°†å€¼æˆ–äº‹ä»¶å¤šè·¯æ¨é€ç»™å¤šä¸ª Observer çš„å”¯ä¸€æ–¹å¼ã€‚</li><li><strong>Schedulers (è°ƒåº¦å™¨):</strong> ç”¨æ¥æ§åˆ¶å¹¶å‘å¹¶ä¸”æ˜¯ä¸­å¤®é›†æƒçš„è°ƒåº¦å‘˜ï¼Œå…è®¸æˆ‘ä»¬åœ¨å‘ç”Ÿè®¡ç®—æ—¶è¿›è¡Œåè°ƒï¼Œä¾‹å¦‚ <code>setTimeout</code> æˆ– <code>requestAnimationFrame</code> æˆ–å…¶ä»–ã€‚</li></ul><h2 id="Observable-å¯è§‚å¯Ÿå¯¹è±¡"><a href="#Observable-å¯è§‚å¯Ÿå¯¹è±¡" class="headerlink" title="Observable (å¯è§‚å¯Ÿå¯¹è±¡)"></a>Observable (å¯è§‚å¯Ÿå¯¹è±¡)</h2><p>Observables æ˜¯å¤šä¸ªå€¼çš„æƒ°æ€§æ¨é€é›†åˆã€‚å®ƒå¡«è¡¥äº†ä¸‹é¢è¡¨æ ¼ä¸­çš„ç©ºç™½ï¼š</p><table><thead><tr><th></th><th>å•ä¸ªå€¼</th><th>å¤šä¸ªå€¼</th></tr></thead><tbody><tr><td><strong>æ‹‰å–</strong></td><td><a href="https://developer.mozilla.org/en-US/docs/Glossary/Function" target="_blank" rel="noopener"><code>Function</code></a></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols" target="_blank" rel="noopener"><code>Iterator</code></a></td></tr><tr><td><strong>æ¨é€</strong></td><td><a href="https://developer.mozilla.org/en-US/docs/Mozilla/JavaScript_code_modules/Promise.jsm/Promise" target="_blank" rel="noopener"><code>Promise</code></a></td><td><a href="https://cn.rx.js.org/class/es6/Observable.js~Observable.html" target="_blank" rel="noopener"><code>Observable</code></a></td></tr></tbody></table><p><strong>ç¤ºä¾‹</strong> - å½“è®¢é˜…ä¸‹é¢ä»£ç ä¸­çš„ Observable çš„æ—¶å€™ä¼šç«‹å³(åŒæ­¥åœ°)æ¨é€å€¼<code>1</code>ã€<code>2</code>ã€<code>3</code>ï¼Œç„¶å1ç§’åä¼šæ¨é€å€¼<code>4</code>ï¼Œå†ç„¶åæ˜¯å®Œæˆæµï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> observable = Rx.Observable.create(<span class="function"><span class="keyword">function</span> (<span class="params">observer</span>) </span>&#123;</span><br><span class="line">  observer.next(<span class="number">1</span>);</span><br><span class="line">  observer.next(<span class="number">2</span>);</span><br><span class="line">  observer.next(<span class="number">3</span>);</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    observer.next(<span class="number">4</span>);</span><br><span class="line">    observer.complete();</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><blockquote><p>Observables åƒæ˜¯æ²¡æœ‰å‚æ•°, ä½†å¯ä»¥æ³›åŒ–ä¸ºå¤šä¸ªå€¼çš„å‡½æ•°ã€‚</p></blockquote><p>Demo01ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Hello'</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> x = foo.call(); <span class="comment">// ç­‰åŒäº foo()</span></span><br><span class="line"><span class="built_in">console</span>.log(x);</span><br><span class="line"><span class="keyword">var</span> y = foo.call(); <span class="comment">// ç­‰åŒäº foo()</span></span><br><span class="line"><span class="built_in">console</span>.log(y);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"Hello"</span></span><br><span class="line"><span class="number">42</span></span><br><span class="line"><span class="string">"Hello"</span></span><br><span class="line"><span class="number">42</span></span><br></pre></td></tr></table></figure><p>Observables é‡å†™ä¸Šé¢çš„ä»£ç ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = Rx.Observable.create(<span class="function"><span class="keyword">function</span> (<span class="params">observer</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Hello'</span>);</span><br><span class="line">  observer.next(<span class="number">42</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">foo.subscribe(<span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(x);</span><br><span class="line">&#125;);</span><br><span class="line">foo.subscribe(<span class="function"><span class="keyword">function</span> (<span class="params">y</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(y);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"Hello"</span></span><br><span class="line"><span class="number">42</span></span><br><span class="line"><span class="string">"Hello"</span></span><br><span class="line"><span class="number">42</span></span><br></pre></td></tr></table></figure><p>è¿™æ˜¯å› ä¸ºå‡½æ•°å’Œ Observables éƒ½æ˜¯æƒ°æ€§è¿ç®—ã€‚å¦‚æœä½ ä¸è°ƒç”¨å‡½æ•°ï¼Œ<code>console.log(&#39;Hello&#39;)</code> å°±ä¸ä¼šæ‰§è¡Œã€‚Observables ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå¦‚æœä½ ä¸â€œè°ƒç”¨â€å®ƒ(ä½¿ç”¨ <code>subscribe</code>)ï¼Œ<code>console.log(&#39;Hello&#39;)</code> ä¹Ÿä¸ä¼šæ‰§è¡Œã€‚æ­¤å¤–ï¼Œâ€œè°ƒç”¨â€æˆ–â€œè®¢é˜…â€æ˜¯ç‹¬ç«‹çš„æ“ä½œï¼šä¸¤ä¸ªå‡½æ•°è°ƒç”¨ä¼šè§¦å‘ä¸¤ä¸ªå•ç‹¬çš„å‰¯ä½œç”¨ï¼Œä¸¤ä¸ª Observable è®¢é˜…åŒæ ·ä¹Ÿæ˜¯è§¦å‘ä¸¤ä¸ªå•ç‹¬çš„å‰¯ä½œç”¨ã€‚EventEmitters å…±äº«å‰¯ä½œç”¨å¹¶ä¸”æ— è®ºæ˜¯å¦å­˜åœ¨è®¢é˜…è€…éƒ½ä¼šå°½æ—©æ‰§è¡Œï¼ŒObservables ä¸ä¹‹ç›¸åï¼Œä¸ä¼šå…±äº«å‰¯ä½œç”¨å¹¶ä¸”æ˜¯å»¶è¿Ÿæ‰§è¡Œã€‚</p><blockquote><p>è®¢é˜… Observable ç±»ä¼¼äºè°ƒç”¨å‡½æ•°ã€‚</p></blockquote><blockquote><p>Observables ä¼ é€’å€¼å¯ä»¥æ˜¯åŒæ­¥çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯å¼‚æ­¥çš„ã€‚</p></blockquote><h4 id="Observableå‰–æ"><a href="#Observableå‰–æ" class="headerlink" title="Observableå‰–æ"></a>Observableå‰–æ</h4><p>Observables æ˜¯ä½¿ç”¨ <code>Rx.Observable.create</code> æˆ–åˆ›å»ºæ“ä½œç¬¦<strong>åˆ›å»ºçš„</strong>ï¼Œå¹¶ä½¿ç”¨è§‚å¯Ÿè€…æ¥<strong>è®¢é˜…</strong>å®ƒï¼Œç„¶å<strong>æ‰§è¡Œ</strong>å®ƒå¹¶å‘é€ <code>next</code> / <code>error</code> / <code>complete</code> é€šçŸ¥ç»™è§‚å¯Ÿè€…ï¼Œè€Œä¸”æ‰§è¡Œå¯èƒ½ä¼šè¢«<strong>æ¸…ç†</strong>ã€‚è¿™å››ä¸ªæ–¹é¢å…¨éƒ¨ç¼–ç åœ¨ Observables å®ä¾‹ä¸­ï¼Œä½†æŸäº›æ–¹é¢æ˜¯ä¸å…¶ä»–ç±»å‹ç›¸å…³çš„ï¼Œåƒ Observer (è§‚å¯Ÿè€…) å’Œ Subscription (è®¢é˜…)ã€‚</p><p>Observable çš„æ ¸å¿ƒå…³æ³¨ç‚¹ï¼š</p><ul><li><strong>åˆ›å»º</strong> Observables</li><li><strong>è®¢é˜…</strong> Observables</li><li><strong>æ‰§è¡Œ</strong> Observables</li><li><strong>æ¸…ç†</strong> Observables</li></ul><h4 id="åˆ›å»º-Observables"><a href="#åˆ›å»º-Observables" class="headerlink" title="åˆ›å»º Observables"></a>åˆ›å»º Observables</h4><p><code>Rx.Observable.create</code> æ˜¯ <code>Observable</code> æ„é€ å‡½æ•°çš„åˆ«åï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼š<code>subscribe</code> å‡½æ•°ã€‚</p><p>ä¸‹é¢çš„ç¤ºä¾‹åˆ›å»ºäº†ä¸€ä¸ª Observableï¼Œå®ƒæ¯éš”ä¸€ç§’ä¼šå‘è§‚å¯Ÿè€…å‘é€å­—ç¬¦ä¸² <code>&#39;hi&#39;</code> ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> observable = Rx.Observable.create(<span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">observer</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> id = setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    observer.next(<span class="string">'hi'</span>)</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>Observables å¯ä»¥ä½¿ç”¨ <code>create</code> æ¥åˆ›å»º, ä½†é€šå¸¸æˆ‘ä»¬ä½¿ç”¨æ‰€è°“çš„<a href="https://cn.rx.js.org/manual/overview.html#creation-operators" target="_blank" rel="noopener">åˆ›å»ºæ“ä½œç¬¦</a>, åƒ <code>of</code>ã€<code>from</code>ã€<code>interval</code>ã€ç­‰ç­‰ã€‚</p><p> åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œ<code>subscribe</code> å‡½æ•°æ˜¯ç”¨æ¥æè¿° Observable æœ€é‡è¦çš„ä¸€å—ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹è®¢é˜…æ˜¯ä»€ä¹ˆæ„æ€ã€‚</p><h4 id="è®¢é˜…-Observables"><a href="#è®¢é˜…-Observables" class="headerlink" title="è®¢é˜… Observables"></a>è®¢é˜… Observables</h4><p>ç¤ºä¾‹ä¸­çš„ Observable å¯¹è±¡ <code>observable</code> å¯ä»¥<strong>è®¢é˜…</strong>ï¼Œåƒè¿™æ ·ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">observable.subscribe(<span class="function"><span class="params">x</span> =&gt;</span> <span class="built_in">console</span>.log(x));</span><br></pre></td></tr></table></figure><p><code>observable.subscribe</code> å’Œ <code>Observable.create(function subscribe(observer) {...})</code> ä¸­çš„ <code>subscribe</code> æœ‰ç€åŒæ ·çš„åå­—ï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ä¸ªå·§åˆã€‚åœ¨åº“ä¸­ï¼Œå®ƒä»¬æ˜¯ä¸åŒçš„ï¼Œä½†ä»å®é™…å‡ºå‘ï¼Œå¯ä»¥è®¤ä¸ºåœ¨æ¦‚å¿µä¸Šå®ƒä»¬æ˜¯ç­‰åŒçš„ã€‚</p><blockquote><p>è®¢é˜… Observable åƒæ˜¯è°ƒç”¨å‡½æ•°, å¹¶æä¾›æ¥æ”¶æ•°æ®çš„å›è°ƒå‡½æ•°ã€‚</p></blockquote><p><code>subscribe</code> è°ƒç”¨æ˜¯å¯åŠ¨ â€œObservable æ‰§è¡Œâ€çš„ä¸€ç§ç®€å•æ–¹å¼ï¼Œ å¹¶å°†å€¼æˆ–äº‹ä»¶ä¼ é€’ç»™æœ¬æ¬¡æ‰§è¡Œçš„è§‚å¯Ÿè€…ã€‚</p><h4 id="æ‰§è¡Œ-Observables"><a href="#æ‰§è¡Œ-Observables" class="headerlink" title="æ‰§è¡Œ Observables"></a>æ‰§è¡Œ Observables</h4><p><code>Observable.create(function subscribe(observer) {...})</code> ä¸­<code>...</code>çš„ä»£ç è¡¨ç¤º â€œObservable æ‰§è¡Œâ€ï¼Œå®ƒæ˜¯æƒ°æ€§è¿ç®—ï¼Œåªæœ‰åœ¨æ¯ä¸ªè§‚å¯Ÿè€…è®¢é˜…åæ‰ä¼šæ‰§è¡Œã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæ‰§è¡Œä¼šä»¥åŒæ­¥æˆ–å¼‚æ­¥çš„æ–¹å¼äº§ç”Ÿå¤šä¸ªå€¼ã€‚</p><p>Observable æ‰§è¡Œå¯ä»¥ä¼ é€’ä¸‰ç§ç±»å‹çš„å€¼ï¼š</p><ul><li>â€œNextâ€ é€šçŸ¥ï¼š å‘é€ä¸€ä¸ªå€¼ï¼Œæ¯”å¦‚æ•°å­—ã€å­—ç¬¦ä¸²ã€å¯¹è±¡ï¼Œç­‰ç­‰ã€‚</li><li>â€œErrorâ€ é€šçŸ¥ï¼š å‘é€ä¸€ä¸ª JavaScript é”™è¯¯ æˆ– å¼‚å¸¸ã€‚</li><li>â€œCompleteâ€ é€šçŸ¥ï¼š ä¸å†å‘é€ä»»ä½•å€¼ã€‚</li></ul><p>â€œNextâ€ é€šçŸ¥æ˜¯æœ€é‡è¦ï¼Œä¹Ÿæ˜¯æœ€å¸¸è§çš„ç±»å‹ï¼šå®ƒä»¬è¡¨ç¤ºä¼ é€’ç»™è§‚å¯Ÿè€…çš„å®é™…æ•°æ®ã€‚â€Errorâ€ å’Œ â€œCompleteâ€ é€šçŸ¥å¯èƒ½åªä¼šåœ¨ Observable æ‰§è¡ŒæœŸé—´å‘ç”Ÿä¸€æ¬¡ï¼Œå¹¶ä¸”åªä¼šæ‰§è¡Œå…¶ä¸­çš„ä¸€ä¸ªã€‚</p><blockquote><p>åœ¨ Observable æ‰§è¡Œä¸­, å¯èƒ½ä¼šå‘é€é›¶ä¸ªåˆ°æ— ç©·å¤šä¸ª â€œNextâ€ é€šçŸ¥ã€‚å¦‚æœå‘é€çš„æ˜¯ â€œErrorâ€ æˆ– â€œCompleteâ€ é€šçŸ¥çš„è¯ï¼Œé‚£ä¹ˆä¹‹åä¸ä¼šå†å‘é€ä»»ä½•é€šçŸ¥äº†ã€‚</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> observable = Rx.Observable.create(<span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">observer</span>) </span>&#123;</span><br><span class="line">  observer.next(<span class="number">1</span>);</span><br><span class="line">  observer.next(<span class="number">2</span>);</span><br><span class="line">  observer.next(<span class="number">3</span>);</span><br><span class="line">  observer.complete();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> observable = Rx.Observable.create(<span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">observer</span>) </span>&#123;</span><br><span class="line">  observer.next(<span class="number">1</span>);</span><br><span class="line">  observer.next(<span class="number">2</span>);</span><br><span class="line">  observer.next(<span class="number">3</span>);</span><br><span class="line">  observer.complete();</span><br><span class="line">  observer.next(<span class="number">4</span>); <span class="comment">// å› ä¸ºè¿åè§„çº¦ï¼Œæ‰€ä»¥ä¸ä¼šå‘é€</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> observable = Rx.Observable.create(<span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">observer</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    observer.next(<span class="number">1</span>);</span><br><span class="line">    observer.next(<span class="number">2</span>);</span><br><span class="line">    observer.next(<span class="number">3</span>);</span><br><span class="line">    observer.complete();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    observer.error(err); <span class="comment">// å¦‚æœæ•è·åˆ°å¼‚å¸¸ä¼šå‘é€ä¸€ä¸ªé”™è¯¯</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="æ¸…ç†-Observable-æ‰§è¡Œ"><a href="#æ¸…ç†-Observable-æ‰§è¡Œ" class="headerlink" title="æ¸…ç† Observable æ‰§è¡Œ"></a>æ¸…ç† Observable æ‰§è¡Œ</h4><p>å› ä¸º Observable æ‰§è¡Œå¯èƒ½ä¼šæ˜¯æ— é™çš„ï¼Œå¹¶ä¸”è§‚å¯Ÿè€…é€šå¸¸å¸Œæœ›èƒ½åœ¨æœ‰é™çš„æ—¶é—´å†…ä¸­æ­¢æ‰§è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ª API æ¥å–æ¶ˆæ‰§è¡Œã€‚å› ä¸ºæ¯ä¸ªæ‰§è¡Œéƒ½æ˜¯å…¶å¯¹åº”è§‚å¯Ÿè€…ä¸“å±çš„ï¼Œä¸€æ—¦è§‚å¯Ÿè€…å®Œæˆæ¥æ”¶å€¼ï¼Œå®ƒå¿…é¡»è¦ä¸€ç§æ–¹æ³•æ¥åœæ­¢æ‰§è¡Œï¼Œä»¥é¿å…æµªè´¹è®¡ç®—èƒ½åŠ›æˆ–å†…å­˜èµ„æºã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> observable = Rx.Observable.from([<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>]);</span><br><span class="line"><span class="keyword">var</span> subscription = observable.subscribe(<span class="function"><span class="params">x</span> =&gt;</span> <span class="built_in">console</span>.log(x));</span><br><span class="line"><span class="comment">// ç¨åï¼š</span></span><br><span class="line">subscription.unsubscribe();</span><br></pre></td></tr></table></figure><blockquote><p>å½“ä½ è®¢é˜…äº† Observableï¼Œä½ ä¼šå¾—åˆ°ä¸€ä¸ª Subscription ï¼Œå®ƒè¡¨ç¤ºè¿›è¡Œä¸­çš„æ‰§è¡Œã€‚åªè¦è°ƒç”¨ <code>unsubscribe()</code> æ–¹æ³•å°±å¯ä»¥å–æ¶ˆæ‰§è¡Œã€‚</p></blockquote><h2 id="Observer-è§‚å¯Ÿè€…"><a href="#Observer-è§‚å¯Ÿè€…" class="headerlink" title="Observer (è§‚å¯Ÿè€…)"></a>Observer (è§‚å¯Ÿè€…)</h2><p><strong>ä»€ä¹ˆæ˜¯è§‚å¯Ÿè€…ï¼Ÿ</strong> - è§‚å¯Ÿè€…æ˜¯ç”± Observable å‘é€çš„å€¼çš„æ¶ˆè´¹è€…ã€‚è§‚å¯Ÿè€…åªæ˜¯ä¸€ç»„å›è°ƒå‡½æ•°çš„é›†åˆï¼Œæ¯ä¸ªå›è°ƒå‡½æ•°å¯¹åº”ä¸€ç§ Observable å‘é€çš„é€šçŸ¥ç±»å‹ï¼š<code>next</code>ã€<code>error</code> å’Œ <code>complete</code> ã€‚ä¸‹é¢çš„ç¤ºä¾‹æ˜¯ä¸€ä¸ªå…¸å‹çš„è§‚å¯Ÿè€…å¯¹è±¡ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> observer = &#123;</span><br><span class="line">  next: <span class="function"><span class="params">x</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'Observer got a next value: '</span> + x),</span><br><span class="line">  error: <span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.error(<span class="string">'Observer got an error: '</span> + err),</span><br><span class="line">  complete: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'Observer got a complete notification'</span>),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¦ä½¿ç”¨è§‚å¯Ÿè€…ï¼Œéœ€è¦æŠŠå®ƒæä¾›ç»™ Observable çš„ <code>subscribe</code> æ–¹æ³•ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">observable.subscribe(observer);</span><br></pre></td></tr></table></figure><blockquote><p>è§‚å¯Ÿè€…åªæ˜¯æœ‰ä¸‰ä¸ªå›è°ƒå‡½æ•°çš„å¯¹è±¡ï¼Œæ¯ä¸ªå›è°ƒå‡½æ•°å¯¹åº”ä¸€ç§ Observable å‘é€çš„é€šçŸ¥ç±»å‹ã€‚</p></blockquote><h2 id="Subscriptionï¼ˆè®¢é˜…ï¼‰"><a href="#Subscriptionï¼ˆè®¢é˜…ï¼‰" class="headerlink" title="Subscriptionï¼ˆè®¢é˜…ï¼‰"></a>Subscriptionï¼ˆè®¢é˜…ï¼‰</h2><p><strong>ä»€ä¹ˆæ˜¯ Subscription ï¼Ÿ</strong> - Subscription æ˜¯è¡¨ç¤ºå¯æ¸…ç†èµ„æºçš„å¯¹è±¡ï¼Œé€šå¸¸æ˜¯ Observable çš„æ‰§è¡Œã€‚Subscription æœ‰ä¸€ä¸ªé‡è¦çš„æ–¹æ³•ï¼Œå³ <code>unsubscribe</code>ï¼Œå®ƒä¸éœ€è¦ä»»ä½•å‚æ•°ï¼Œåªæ˜¯ç”¨æ¥æ¸…ç†ç”± Subscription å ç”¨çš„èµ„æºã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> observable = Rx.Observable.interval(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">var</span> subscription = observable.subscribe(<span class="function"><span class="params">x</span> =&gt;</span> <span class="built_in">console</span>.log(x));</span><br><span class="line"><span class="comment">// ç¨åï¼š</span></span><br><span class="line"><span class="comment">// è¿™ä¼šå–æ¶ˆæ­£åœ¨è¿›è¡Œä¸­çš„ Observable æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">// Observable æ‰§è¡Œæ˜¯é€šè¿‡ä½¿ç”¨è§‚å¯Ÿè€…è°ƒç”¨ subscribe æ–¹æ³•å¯åŠ¨çš„</span></span><br><span class="line">subscription.unsubscribe();</span><br></pre></td></tr></table></figure><blockquote><p>Subscription åŸºæœ¬ä¸Šåªæœ‰ä¸€ä¸ª <code>unsubscribe()</code> å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ç”¨æ¥é‡Šæ”¾èµ„æºæˆ–å»å–æ¶ˆ Observable æ‰§è¡Œã€‚</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> observable1 = Rx.Observable.interval(<span class="number">400</span>);</span><br><span class="line"><span class="keyword">var</span> observable2 = Rx.Observable.interval(<span class="number">300</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subscription = observable1.subscribe(<span class="function"><span class="params">x</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'first: '</span> + x));</span><br><span class="line"><span class="keyword">var</span> childSubscription = observable2.subscribe(<span class="function"><span class="params">x</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'second: '</span> + x));</span><br><span class="line"></span><br><span class="line">subscription.add(childSubscription);</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// subscription å’Œ childSubscription éƒ½ä¼šå–æ¶ˆè®¢é˜…</span></span><br><span class="line">  subscription.unsubscribe();</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">    second: <span class="number">0</span></span><br><span class="line">    first: <span class="number">0</span></span><br><span class="line">    second: <span class="number">1</span></span><br><span class="line">    first: <span class="number">1</span></span><br><span class="line">    second: <span class="number">2</span></span><br></pre></td></tr></table></figure><h4 id="simple-Demo1"><a href="#simple-Demo1" class="headerlink" title="simple Demo1"></a>simple Demo1</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> button = <span class="built_in">document</span>.querySelector(<span class="string">'button'</span>);</span><br><span class="line">button.addEventListener(<span class="string">'click'</span>, () =&gt;</span><br><span class="line">                        <span class="built_in">console</span>.log(<span class="string">'Clicked!'</span>)</span><br><span class="line">                       );</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> button = <span class="built_in">document</span>.querySelector(<span class="string">'button'</span>);</span><br><span class="line">Rx.Observable.fromEvent(button, <span class="string">'click'</span>)</span><br><span class="line">  .subscribe(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'Clicked!'</span>));</span><br></pre></td></tr></table></figure><p><code>Rx.Observable.fromEvent()</code>ç›¸å½“äºåˆ›å»ºäº†ä¸€ä¸ªå¯è§‚å¯Ÿå¯¹è±¡<code>Observable</code>,ä¹Ÿå°±æ˜¯ç›‘å¬çš„ä»£ç†å¯¹è±¡,subscribeæ˜¯è¿™ä¸ªå¯¹è±¡çš„ä¸€ä¸ªæ–¹æ³•,è¯¥æ–¹æ³•è¿”å›è¿™ä¸ªç›‘å¬çš„äº‹ä»¶,<code>subscribe</code>æ–¹æ³•çš„å‚æ•°æ˜¯å¯¹è§‚å¯Ÿå¯¹è±¡è¿”å›å€¼åšå‡ºä¸‹ä¸€æ­¥æ“ä½œ(å›è°ƒå‡½æ•°).</p><h4 id="Demo2ï¼ˆæ§åˆ¶æµåŠ¨ï¼‰"><a href="#Demo2ï¼ˆæ§åˆ¶æµåŠ¨ï¼‰" class="headerlink" title="Demo2ï¼ˆæ§åˆ¶æµåŠ¨ï¼‰"></a>Demo2ï¼ˆæ§åˆ¶æµåŠ¨ï¼‰</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¾“å…¥ "hello world"</span></span><br><span class="line"><span class="keyword">var</span> input = Rx.Observable.fromEvent(<span class="built_in">document</span>.querySelector(<span class="string">'input'</span>), <span class="string">'input'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿‡æ»¤æ‰å°äº3ä¸ªå­—ç¬¦é•¿åº¦çš„ç›®æ ‡å€¼</span></span><br><span class="line">input.filter(<span class="function"><span class="params">event</span> =&gt;</span> event.target.value.length &gt; <span class="number">2</span>)</span><br><span class="line">  .map(<span class="function"><span class="params">event</span> =&gt;</span> event.target.value)</span><br><span class="line">  .subscribe(<span class="function"><span class="params">value</span> =&gt;</span> <span class="built_in">console</span>.log(value)); <span class="comment">// "hel"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å»¶è¿Ÿäº‹ä»¶</span></span><br><span class="line">input.delay(<span class="number">200</span>)</span><br><span class="line">  .map(<span class="function"><span class="params">event</span> =&gt;</span> event.target.value)</span><br><span class="line">  .subscribe(<span class="function"><span class="params">value</span> =&gt;</span> <span class="built_in">console</span>.log(value)); <span class="comment">// "h" -200ms-&gt; "e" -200ms-&gt; "l" ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¯200msåªèƒ½é€šè¿‡ä¸€ä¸ªäº‹ä»¶</span></span><br><span class="line">input.throttleTime(<span class="number">200</span>)</span><br><span class="line">  .map(<span class="function"><span class="params">event</span> =&gt;</span> event.target.value)</span><br><span class="line">  .subscribe(<span class="function"><span class="params">value</span> =&gt;</span> <span class="built_in">console</span>.log(value)); <span class="comment">// "h" -200ms-&gt; "w"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åœæ­¢è¾“å…¥å200msæ–¹èƒ½é€šè¿‡æœ€æ–°çš„é‚£ä¸ªäº‹ä»¶</span></span><br><span class="line">input.debounceTime(<span class="number">200</span>)</span><br><span class="line">  .map(<span class="function"><span class="params">event</span> =&gt;</span> event.target.value)</span><br><span class="line">  .subscribe(<span class="function"><span class="params">value</span> =&gt;</span> <span class="built_in">console</span>.log(value)); <span class="comment">// "o" -200ms-&gt; "d"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨3æ¬¡äº‹ä»¶ååœæ­¢äº‹ä»¶æµ</span></span><br><span class="line">input.take(<span class="number">3</span>)</span><br><span class="line">  .map(<span class="function"><span class="params">event</span> =&gt;</span> event.target.value)</span><br><span class="line">  .subscribe(<span class="function"><span class="params">value</span> =&gt;</span> <span class="built_in">console</span>.log(value)); <span class="comment">// "hel"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›´åˆ°å…¶ä»– observable è§¦å‘äº‹ä»¶æ‰åœæ­¢äº‹ä»¶æµ</span></span><br><span class="line"><span class="keyword">var</span> stopStream = Rx.Observable.fromEvent(<span class="built_in">document</span>.querySelector(<span class="string">'button'</span>), <span class="string">'click'</span>);</span><br><span class="line">input.takeUntil(stopStream)</span><br><span class="line">  .map(<span class="function"><span class="params">event</span> =&gt;</span> event.target.value)</span><br><span class="line">  .subscribe(<span class="function"><span class="params">value</span> =&gt;</span> <span class="built_in">console</span>.log(value)); <span class="comment">// "hello" (ç‚¹å‡»æ‰èƒ½çœ‹åˆ°)</span></span><br></pre></td></tr></table></figure><h4 id="Demo3ï¼ˆäº§ç”Ÿå€¼ï¼‰"><a href="#Demo3ï¼ˆäº§ç”Ÿå€¼ï¼‰" class="headerlink" title="Demo3ï¼ˆäº§ç”Ÿå€¼ï¼‰"></a>Demo3ï¼ˆäº§ç”Ÿå€¼ï¼‰</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¾“å…¥ "hello world"</span></span><br><span class="line"><span class="keyword">var</span> input = Rx.Observable.fromEvent(<span class="built_in">document</span>.querySelector(<span class="string">'input'</span>), <span class="string">'input'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼ é€’ä¸€ä¸ªæ–°çš„å€¼</span></span><br><span class="line">input.map(<span class="function"><span class="params">event</span> =&gt;</span> event.target.value)</span><br><span class="line">  .subscribe(<span class="function"><span class="params">value</span> =&gt;</span> <span class="built_in">console</span>.log(value)); <span class="comment">// "h"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡æå–å±æ€§ä¼ é€’ä¸€ä¸ªæ–°çš„å€¼</span></span><br><span class="line">input.pluck(<span class="string">'target'</span>, <span class="string">'value'</span>)</span><br><span class="line">  .subscribe(<span class="function"><span class="params">value</span> =&gt;</span> <span class="built_in">console</span>.log(value)); <span class="comment">// "h"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼ é€’ä¹‹å‰çš„ä¸¤ä¸ªå€¼</span></span><br><span class="line">input.pluck(<span class="string">'target'</span>, <span class="string">'value'</span>).pairwise()</span><br><span class="line">  .subscribe(<span class="function"><span class="params">value</span> =&gt;</span> <span class="built_in">console</span>.log(value)); <span class="comment">// ["h", "he"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åªä¼šé€šè¿‡å”¯ä¸€çš„å€¼</span></span><br><span class="line">input.pluck(<span class="string">'data'</span>).distinct()</span><br><span class="line">  .subscribe(<span class="function"><span class="params">value</span> =&gt;</span> <span class="built_in">console</span>.log(value)); <span class="comment">// "helo wrd"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸ä¼šä¼ é€’é‡å¤çš„å€¼</span></span><br><span class="line">input.pluck(<span class="string">'data'</span>).distinctUntilChanged()</span><br><span class="line">  .subscribe(<span class="function"><span class="params">value</span> =&gt;</span> <span class="built_in">console</span>.log(value)); <span class="comment">// "helo world"</span></span><br></pre></td></tr></table></figure><p>### </p>]]></content>
    
    <summary type="html">
    
      Rx æ˜¯ Reactive Extensionï¼ˆä¹Ÿå« ReactiveXï¼‰çš„ç®€ç§°ï¼ŒæŒ‡çš„æ˜¯å®è·µå“åº”å¼ç¼–ç¨‹çš„ä¸€å¥—å·¥å…·ï¼ŒRx å®˜ç½‘é¦–é¡µçš„ä»‹ç»æ˜¯ä¸€å¥—é€šè¿‡å¯ç›‘å¬æµæ¥åšå¼‚æ­¥ç¼–ç¨‹çš„ APIï¼ˆAn API for asynchronous programming with observable streamsï¼‰ã€‚RxJS æ˜¯åŸºäºè§‚å¯Ÿè€…æ¨¡å¼å’Œè¿­ä»£å™¨æ¨¡å¼ä»¥å‡½æ•°å¼ç¼–ç¨‹æ€ç»´æ¥å®ç°çš„ã€‚
    
    </summary>
    
      <category term="é»˜è®¤åˆ†ç±»" scheme="https://kitions.github.io/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/"/>
    
    
      <category term="rxjs" scheme="https://kitions.github.io/tags/rxjs/"/>
    
  </entry>
  
  <entry>
    <title>css-åŠ¨ç”»-PPT</title>
    <link href="https://kitions.github.io/2018/08/08/css-%E5%8A%A8%E7%94%BB-PPT/"/>
    <id>https://kitions.github.io/2018/08/08/css-åŠ¨ç”»-PPT/</id>
    <published>2018-08-08T09:19:33.000Z</published>
    <updated>2018-09-03T09:48:17.430Z</updated>
    
    <content type="html"><![CDATA[<p>å®ä¸ºç®€é™‹</p><p><a href="https://slides.com/nsplknsplk/deck/live#/" target="_blank" rel="noopener">cssåŠ¨ç”»ç®€æ-åœ¨çº¿PPT</a></p>]]></content>
    
    <summary type="html">
    
      ç½‘é¡µç‰ˆPPTï¼Œslides.comï¼Œ
    
    </summary>
    
      <category term="é»˜è®¤åˆ†ç±»" scheme="https://kitions.github.io/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/"/>
    
    
      <category term="animation" scheme="https://kitions.github.io/tags/animation/"/>
    
  </entry>
  
  <entry>
    <title>css-GPUåŠ é€Ÿ</title>
    <link href="https://kitions.github.io/2018/08/07/css-GPU%E5%8A%A0%E9%80%9F/"/>
    <id>https://kitions.github.io/2018/08/07/css-GPUåŠ é€Ÿ/</id>
    <published>2018-08-07T08:31:13.000Z</published>
    <updated>2018-07-28T12:58:04.000Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬å¯ä»¥åœ¨æµè§ˆå™¨ä¸­ç”¨csså¼€å¯ç¡¬ä»¶åŠ é€Ÿï¼Œä½¿GPU (Graphics Processing Unit) å‘æŒ¥åŠŸèƒ½ï¼Œä»è€Œæå‡æ€§èƒ½å—ï¼Ÿ</p><p>ç°åœ¨å¤§å¤šæ•°ç”µè„‘çš„æ˜¾å¡éƒ½æ”¯æŒç¡¬ä»¶åŠ é€Ÿã€‚é‰´äºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å‘æŒ¥GPUçš„åŠ›é‡ï¼Œä»è€Œä½¿æˆ‘ä»¬çš„ç½‘ç«™æˆ–åº”ç”¨è¡¨ç°çš„æ›´ä¸ºæµç•…ã€‚</p><h3 id="åœ¨æ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯ç”¨CSSå¼€å¯ç¡¬ä»¶åŠ é€Ÿ"><a href="#åœ¨æ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯ç”¨CSSå¼€å¯ç¡¬ä»¶åŠ é€Ÿ" class="headerlink" title="åœ¨æ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯ç”¨CSSå¼€å¯ç¡¬ä»¶åŠ é€Ÿ"></a>åœ¨æ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯ç”¨CSSå¼€å¯ç¡¬ä»¶åŠ é€Ÿ</h3><p>CSS animations, transforms ä»¥åŠ transitions ä¸ä¼šè‡ªåŠ¨å¼€å¯GPUåŠ é€Ÿï¼Œè€Œæ˜¯ç”±æµè§ˆå™¨çš„ç¼“æ…¢çš„è½¯ä»¶æ¸²æŸ“å¼•æ“æ¥æ‰§è¡Œã€‚é‚£æˆ‘ä»¬æ€æ ·æ‰å¯ä»¥åˆ‡æ¢åˆ°GPUæ¨¡å¼å‘¢ï¼Œå¾ˆå¤šæµè§ˆå™¨æä¾›äº†æŸäº›è§¦å‘çš„CSSè§„åˆ™ã€‚</p><p>ç°åœ¨ï¼ŒåƒChrome, FireFox, Safari, IE9+å’Œæœ€æ–°ç‰ˆæœ¬çš„Operaéƒ½æ”¯æŒç¡¬ä»¶åŠ é€Ÿï¼Œå½“å®ƒä»¬æ£€æµ‹åˆ°é¡µé¢ä¸­æŸä¸ªDOMå…ƒç´ åº”ç”¨äº†æŸäº›CSSè§„åˆ™æ—¶å°±ä¼šå¼€å¯ï¼Œæœ€æ˜¾è‘—çš„ç‰¹å¾çš„å…ƒç´ çš„3Då˜æ¢ã€‚</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.cube</span> &#123;</span><br><span class="line">   <span class="attribute">-webkit-transform</span>: <span class="built_in">translate3d</span>(250px,250px,250px)</span><br><span class="line">   <span class="built_in">rotate3d</span>(250px,250px,250px,-120deg)</span><br><span class="line">   <span class="built_in">scale3d</span>(0.5, 0.5, 0.5);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯æ˜¯åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦å¯¹å…ƒç´ åº”ç”¨3Då˜æ¢çš„æ•ˆæœï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸ªå°æŠ€å·§â€œæ¬ºéª—â€æµè§ˆå™¨æ¥å¼€å¯ç¡¬ä»¶åŠ é€Ÿã€‚</p><p>è™½ç„¶æˆ‘ä»¬å¯èƒ½ä¸æƒ³å¯¹å…ƒç´ åº”ç”¨3Då˜æ¢ï¼Œå¯æˆ‘ä»¬ä¸€æ ·å¯ä»¥å¼€å¯3Då¼•æ“ã€‚ä¾‹å¦‚æˆ‘ä»¬å¯ä»¥ç”¨transform: translateZ(0); æ¥å¼€å¯ç¡¬ä»¶åŠ é€Ÿ ã€‚</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.cube</span> &#123;</span><br><span class="line">   <span class="attribute">-webkit-transform</span>: <span class="built_in">translateZ</span>(0);</span><br><span class="line">   <span class="attribute">-moz-transform</span>: <span class="built_in">translateZ</span>(0);</span><br><span class="line">   <span class="attribute">-ms-transform</span>: <span class="built_in">translateZ</span>(0);</span><br><span class="line">   <span class="attribute">-o-transform</span>: <span class="built_in">translateZ</span>(0);</span><br><span class="line">   <span class="attribute">transform</span>: <span class="built_in">translateZ</span>(0);</span><br><span class="line">   <span class="comment">/* Other transform properties here */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ Chrome and Safariä¸­ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨CSS transforms æˆ–è€… animationsæ—¶å¯èƒ½ä¼šæœ‰é¡µé¢é—ªçƒçš„æ•ˆæœï¼Œä¸‹é¢çš„ä»£ç å¯ä»¥ä¿®å¤æ­¤æƒ…å†µï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.cube</span> &#123;</span><br><span class="line">   <span class="attribute">-webkit-backface-visibility</span>: hidden;</span><br><span class="line">   <span class="attribute">-moz-backface-visibility</span>: hidden;</span><br><span class="line">   <span class="attribute">-ms-backface-visibility</span>: hidden;</span><br><span class="line">   <span class="attribute">backface-visibility</span>: hidden;</span><br><span class="line"> </span><br><span class="line">   <span class="attribute">-webkit-perspective</span>: <span class="number">1000</span>;</span><br><span class="line">   <span class="attribute">-moz-perspective</span>: <span class="number">1000</span>;</span><br><span class="line">   <span class="attribute">-ms-perspective</span>: <span class="number">1000</span>;</span><br><span class="line">   <span class="attribute">perspective</span>: <span class="number">1000</span>;</span><br><span class="line">   <span class="comment">/* Other transform properties here */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨webkitå†…æ ¸çš„æµè§ˆå™¨ä¸­ï¼Œå¦ä¸€ä¸ªè¡Œä¹‹æœ‰æ•ˆçš„æ–¹æ³•æ˜¯</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.cube</span> &#123;</span><br><span class="line">   <span class="attribute">-webkit-transform</span>: <span class="built_in">translate3d</span>(0, 0, 0);</span><br><span class="line">   <span class="attribute">-moz-transform</span>: <span class="built_in">translate3d</span>(0, 0, 0);</span><br><span class="line">   <span class="attribute">-ms-transform</span>: <span class="built_in">translate3d</span>(0, 0, 0);</span><br><span class="line">   <span class="attribute">transform</span>: <span class="built_in">translate3d</span>(0, 0, 0);</span><br><span class="line">  <span class="comment">/* Other transform properties here */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸç”Ÿçš„ç§»åŠ¨ç«¯åº”ç”¨(Native mobile applications)æ€»æ˜¯å¯ä»¥å¾ˆå¥½çš„è¿ç”¨GPUï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå®ƒæ¯”ç½‘é¡µåº”ç”¨(Web apps)è¡¨ç°æ›´å¥½çš„åŸå› ã€‚ç¡¬ä»¶åŠ é€Ÿåœ¨ç§»åŠ¨ç«¯å°¤å…¶æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå¯ä»¥æœ‰æ•ˆçš„å‡å°‘èµ„æºçš„åˆ©ç”¨(éº¦æ—¶æ³¨ï¼šç§»åŠ¨ç«¯æœ¬èº«èµ„æºæœ‰é™)ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>åªå¯¹æˆ‘ä»¬éœ€è¦å®ç°åŠ¨ç”»æ•ˆæœçš„å…ƒç´ åº”ç”¨ä»¥ä¸Šæ–¹æ³•ï¼Œå¦‚æœä»…ä»…ä¸ºäº†å¼€å¯ç¡¬ä»¶åŠ é€Ÿè€Œéšä¾¿ä¹±ç”¨ï¼Œé‚£æ˜¯ä¸æ˜æ™ºçš„ã€‚</p><p>å°å¿ƒä½¿ç”¨è¿™äº›æ–¹æ³•ï¼Œå¦‚æœé€šè¿‡ä½ çš„æµ‹è¯•ï¼Œç»“æœç¡®æ˜¯æé«˜äº†æ€§èƒ½ï¼Œä½ æ‰å¯ä»¥ä½¿ç”¨è¿™äº›æ–¹æ³•ã€‚ä½¿ç”¨GPUå¯èƒ½ä¼šå¯¼è‡´ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºå®ƒå¢åŠ äº†å†…å­˜çš„ä½¿ç”¨ï¼Œè€Œä¸”å®ƒä¼šå‡å°‘ç§»åŠ¨ç«¯è®¾å¤‡çš„ç”µæ± å¯¿å‘½ã€‚</p><p>åŸæ–‡åœ°å€ï¼š<a href="http://blog.teamtreehouse.com/increase-your-sites-performance-with-hardware-accelerated-css" target="_blank" rel="noopener">http://blog.teamtreehouse.com/increase-your-sites-performance-with-hardware-accelerated-css</a>ã€‚</p>]]></content>
    
    <summary type="html">
    
      ä¸»è¦ä½¿ç”¨transform3Då¼€å¯ï¼Œæµè§ˆå™¨å¼€å¯ç¡¬ä»¶åŠ é€Ÿåœ¨ç§»åŠ¨ç«¯æ€§èƒ½æå‡æ˜æ˜¾ï¼Œå¦‚æœä»…ä»…ä¸ºäº†å¼€å¯ç¡¬ä»¶åŠ é€Ÿè€Œéšä¾¿ä¹±ç”¨ï¼Œé‚£æ˜¯ä¸æ˜æ™ºçš„ã€‚å°å¿ƒä½¿ç”¨è¿™äº›æ–¹æ³•ï¼Œå¦‚æœé€šè¿‡ä½ çš„æµ‹è¯•ï¼Œç»“æœç¡®æ˜¯æé«˜äº†æ€§èƒ½ï¼Œä½ æ‰å¯ä»¥ä½¿ç”¨è¿™äº›æ–¹æ³•ã€‚ä½¿ç”¨GPUå¯èƒ½ä¼šå¯¼è‡´ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºå®ƒå¢åŠ äº†å†…å­˜çš„ä½¿ç”¨ï¼Œè€Œä¸”å®ƒä¼šå‡å°‘ç§»åŠ¨ç«¯è®¾å¤‡çš„ç”µæ± å¯¿å‘½ã€‚
    
    </summary>
    
      <category term="é»˜è®¤åˆ†ç±»" scheme="https://kitions.github.io/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/"/>
    
    
      <category term="css" scheme="https://kitions.github.io/tags/css/"/>
    
  </entry>
  
</feed>
